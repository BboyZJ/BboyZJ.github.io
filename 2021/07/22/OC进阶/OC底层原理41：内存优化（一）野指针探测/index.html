<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    <meta name="description" content="我是小J，关注我">
    <meta name="author" content="张建">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-redefine.png">
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://www.bboyzj.cn/2021/07/22/oc进阶/oc底层原理41：内存优化（一）野指针探测/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    <meta property="og:type" content="article">
    <meta property="og:title" content="OC底层原理41：内存优化（一）野指针探测">
    <meta property="og:description" content="我是小J，关注我">
    <meta property="og:url" content="https://www.bboyzj.cn2021/07/22/OC进阶/OC底层原理41：内存优化（一）野指针探测/">
    <meta property="og:image" content="/images/redefine-logo.svg">
    <meta property="og:site_name" content="BboyZJ">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="OC底层原理41：内存优化（一）野指针探测">
    <meta name="twitter:description" content="我是小J，关注我">
    <meta name="twitter:image" content="/images/redefine-logo.svg">
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/redefine-logo.svg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/redefine-logo.svg">
    <meta name="theme-color" content="#005080">
    <link rel="shortcut icon" href="/BboyZJ.github.io/images/redefine-logo.svg">
    
    <title>
        
            OC底层原理41：内存优化（一）野指针探测 -
        
        BboyZJ
    </title>
    
<link rel="stylesheet" href="/BboyZJ.github.io/css/style.css">

    
<link rel="stylesheet" href="/BboyZJ.github.io/assets/fonts.css">

    
    
    
    
    <script id="hexo-configurations">
    let REDEFINE = window.REDEFINE || {};
    REDEFINE.hexo_config = {"hostname":"www.bboyzj.cn","root":"/BboyZJ.github.io/","language":"en","path":"search.xml"};
    REDEFINE.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#005080","avatar":"/images/head_img.svg","favicon":"/images/redefine-logo.svg","article_img_align":"center","right_side_width":"210px","content_max_width":"1000px","nav_color":{"left":"#f78736","right":"#367df7","transparency":35},"hover":{"shadow":true,"scale":false},"first_screen":{"enable":true,"background_image":{"light":"https://evan.beee.top/img/wallhaven-wqery6-light.webp","dark":"https://evan.beee.top/img/wallhaven-wqery6-dark.webp"},"title_color":{"light":"#fff","dark":"#d1d1b6"},"description":"学无止境 学而不思则罔 思而不学则殆","custom_font":{"enable":false,"font_family":null,"font_url":null}},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":true},"code_block":{"copy":true,"style":"mac","custom_font":{"enable":false,"font_family":null,"font_url":null}},"pjax":{"enable":true},"lazyload":{"enable":true},"version":"1.1.5","friend_links":{"columns":2},"home_article":{"date_format":"auto","category":{"enable":true,"limit":3},"tag":{"enable":true,"limit":3}},"plugins":{"aplayer":{"enable":false,"audio":[{"name":null,"artist":null,"url":null,"cover":null},{"name":null,"artist":null,"url":null,"cover":null}]}}};
    REDEFINE.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
    
    
<link rel="stylesheet" href="/BboyZJ.github.io/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/BboyZJ.github.io/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/BboyZJ.github.io/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/BboyZJ.github.io/fontawesome/regular.min.css">

    
    
    
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/BboyZJ.github.io/atom.xml" title="张建的博客" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="menu-wrapper">
    
    <div class="menu-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                BboyZJ
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="pc">
                <ul class="menu-list">
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/BboyZJ.github.io/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        首页
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/BboyZJ.github.io/tags/"  >
                                    
                                        
                                            <i class="fa-regular fa-tags"></i>
                                        
                                        标签
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/BboyZJ.github.io/categories/"  >
                                    
                                        
                                            <i class="fa-regular fa-categories"></i>
                                        
                                        分类
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="menu-drawer">
        <ul class="drawer-menu-list">
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="" 
                        href="/BboyZJ.github.io/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                首页
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="" 
                        href="/BboyZJ.github.io/tags/"  >
                             
                                
                                    <i class="fa-regular fa-tags"></i>
                                
                                标签
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="" 
                        href="/BboyZJ.github.io/categories/"  >
                             
                                
                                    <i class="fa-regular fa-categories"></i>
                                
                                分类
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            
            
                <div class="article-title">
                    <h1 class="article-title-regular">OC底层原理41：内存优化（一）野指针探测</h1>
                </div>
            
                
            

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="/BboyZJ.github.io/images/head_img.svg">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">张建</span>
                            
                                <span class="author-label">lol</span>
                            
                        </div>
                        <div class="meta-info">
                            <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="pc">2021-07-22 14:51:26</span>
        <span class="mobile">2021-07-22 14:51</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="pc">2023-03-03 15:53:22</span>
            <span class="mobile">2023-03-03 15:53</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/BboyZJ.github.io/categories/OC-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E6%8E%A2%E7%B4%A2%E7%AF%87/">OC-底层原理探索篇</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/BboyZJ.github.io/tags/iOS-OC/">iOS-OC</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content markdown-body">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文主要讲解两种野指针检测的原理和实现</p>
<h1 id="技术点：野指针探测"><a href="#技术点：野指针探测" class="headerlink" title="技术点：野指针探测"></a>技术点：野指针探测</h1><p>本文的主要目的是理解野指针的形成过程以及如果去检测野指针</p>
<h1 id="引子"><a href="#引子" class="headerlink" title="引子"></a>引子</h1><p>在介绍野指针之前，首先说下目前的异常处理类型，附 <a class="link"   target="_blank" rel="noopener" href="https://developer.apple.com/documentation/xcode/understanding-the-exception-types-in-a-crash-report" >苹果官网链接 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<h1 id="异常类型"><a href="#异常类型" class="headerlink" title="异常类型"></a>异常类型</h1><p>异常类型分为两类：</p>
<ul>
<li><p>软件异常：主要来自 <code>kill()、phread_kill()、iOS中的NSException未捕获、absort等</code></p>
</li>
<li><p>硬件异常：硬件的信号处理器trap，是和平台相关的，野指针崩溃大部分是硬件异常</p>
</li>
</ul>
<p>而处理异常时，需要关注两个概念</p>
<ul>
<li><p><code>Mach</code>异常：<code>Mach</code>层异常</p>
</li>
<li><p><code>UNIX</code>信号：BSD层获取</p>
</li>
</ul>
<p>iOS中的POSIX API就是通过Mach之上的BSD层实现的，如下图所示：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/BboyZJ.github.io/assets/16488640293427.jpg"
                     
                ></p>
<ul>
<li><p><code>Mach</code> 是一个受 <code>Acccent</code> 启发而高出的Unix系统</p>
</li>
<li><p><code>BSD</code> 层是建立在Mach之上，是XNU中一个不可分割的一部分，BSD负责提供可靠的、现代的API</p>
</li>
<li><p><code>POSIX</code> 表示可移植操作系统接口（Portable Operation System Interface）</p>
</li>
</ul>
<p>所以，综上所述，Mach异常和UNIX信号存在对应的关系</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/BboyZJ.github.io/assets/16488657025540.jpg"
                     
                ></p>
<ul>
<li>硬件异常流程：硬件异常 -&gt; Mach异常 -&gt; UNIX信号</li>
<li>软件异常流程：软件异常 -&gt; UNIX异常</li>
</ul>
<h1 id="Mach异常与UNIX信号的转换"><a href="#Mach异常与UNIX信号的转换" class="headerlink" title="Mach异常与UNIX信号的转换"></a>Mach异常与UNIX信号的转换</h1><p>下面是 <code>Mach异常</code> 与 <code>UNIX信号</code> 的转换关系代码，来自 <code>xnu</code> 中的 <code>bsd/uxkern/ux_exception.c</code></p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">switch(exception) &#123;</span><br><span class="line">case EXC_BAD_ACCESS:</span><br><span class="line">    if (code == KERN_INVALID_ADDRESS)</span><br><span class="line">        *ux_signal = SIGSEGV;</span><br><span class="line">    else</span><br><span class="line">        *ux_signal = SIGBUS;</span><br><span class="line">    break;</span><br><span class="line"></span><br><span class="line">case EXC_BAD_INSTRUCTION:</span><br><span class="line">    *ux_signal = SIGILL;</span><br><span class="line">    break;</span><br><span class="line"></span><br><span class="line">case EXC_ARITHMETIC:</span><br><span class="line">    *ux_signal = SIGFPE;</span><br><span class="line">    break;</span><br><span class="line"></span><br><span class="line">case EXC_EMULATION:</span><br><span class="line">    *ux_signal = SIGEMT;</span><br><span class="line">    break;</span><br><span class="line"></span><br><span class="line">case EXC_SOFTWARE:</span><br><span class="line">    switch (code) &#123;</span><br><span class="line"></span><br><span class="line">    case EXC_UNIX_BAD_SYSCALL:</span><br><span class="line">    *ux_signal = SIGSYS;</span><br><span class="line">    break;</span><br><span class="line">    case EXC_UNIX_BAD_PIPE:</span><br><span class="line">    *ux_signal = SIGPIPE;</span><br><span class="line">    break;</span><br><span class="line">    case EXC_UNIX_ABORT:</span><br><span class="line">    *ux_signal = SIGABRT;</span><br><span class="line">    break;</span><br><span class="line">    case EXC_SOFT_SIGNAL:</span><br><span class="line">    *ux_signal = SIGKILL;</span><br><span class="line">    break;</span><br><span class="line">    &#125;</span><br><span class="line">    break;</span><br><span class="line"></span><br><span class="line">case EXC_BREAKPOINT:</span><br><span class="line">    *ux_signal = SIGTRAP;</span><br><span class="line">    break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>将其对应关系汇总成一个表格，如下所示</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/BboyZJ.github.io/assets/16488661552655.jpg"
                     
                ></p>
<ul>
<li>其中 Mach异常有以下</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/BboyZJ.github.io/assets/16488662828917.jpg"
                     
                ></p>
<ul>
<li>UNIX信号有以下几种</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/BboyZJ.github.io/assets/16488663202265.jpg"
                     
                ></p>
<h1 id="野指针"><a href="#野指针" class="headerlink" title="野指针"></a>野指针</h1><p>指向的 <code>对象被释放或收回</code>，但是该 <code>指针没有做任何的修改</code>，以至于 该<code>指针仍指向已经回收的内存地址</code>，这个指针就是 <code>野指针</code></p>
<h2 id="野指针分类"><a href="#野指针分类" class="headerlink" title="野指针分类"></a>野指针分类</h2><p>这个参考腾讯Bugly团队的总结，大致分为两类</p>
<ul>
<li>内存没被覆盖</li>
<li>内存被覆盖</li>
</ul>
<p>如下图所示</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/BboyZJ.github.io/assets/16488665261518.jpg"
                     
                ></p>
<h2 id="为什么OC野指针的crash这么多？"><a href="#为什么OC野指针的crash这么多？" class="headerlink" title="为什么OC野指针的crash这么多？"></a>为什么OC野指针的crash这么多？</h2><p>我们一般在APP发版前，都会经过多轮的 <code>自测、内侧、灰度测试</code> 等，按照常理来说，大部分的crash应该都被覆盖了，但是由于 <code>野指针的随机性</code>，使得经常在测试时不会出现crash，而是在 <code>线上出现crash</code>，这对App体验来说是非常致命的</p>
<p>而野指针的随机性问题大致可以分为两类：</p>
<ul>
<li>跑不进出错的逻辑，执行不到出错的代码，这种可以通过 <code>提高测试场景覆盖率</code> 来解决</li>
<li>跑进有问题的逻辑，但是野指针指向的地址并不一定会导致crash，原因是因为：<code>野指针</code> 其本质是指向 <code>已经删除的对象</code> 或 <code>受限内存区域</code> 的指针，这里说的 <code>OC野指针</code>，是指 <code>OC对象释放后指针未置空而导致的野指针</code>。这里不必现的原因是因为 <code>dealloc</code> 执行后只是告诉系统，这片 <code>内存我不用了</code>，<code>而系统并没有让这片内存不能访问</code>。</li>
</ul>
<h2 id="野指针解决思路"><a href="#野指针解决思路" class="headerlink" title="野指针解决思路"></a>野指针解决思路</h2><p>这里主要是借鉴Xcode中的两种处理方案：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/BboyZJ.github.io/assets/16488670422301.jpg"
                     
                ></p>
<ul>
<li>Malloc Scrrbble，其<a class="link"   target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/ManagingMemory/Articles/MallocDebug.html" >官方解释 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>如下：申请内存 <code>alloc</code> 时在内存上填 <code>0xAA</code>，释放内存 <code>dealloc</code> 在内存上填 <code>0x55</code>。</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/BboyZJ.github.io/assets/16488671458859.jpg"
                     
                ></p>
<ul>
<li><code>Zombie Objects</code>，其 <a class="link"   target="_blank" rel="noopener" href="https://developer.apple.com/documentation/xcode/investigating-crashes-for-zombie-objects?preferredLanguage=occ" >官方解释 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 如下：一个对象已经解除了它的引用，已经释放掉，但是此时仍然是可以接收消息，这个对象就叫做 <code>Zombie Objects（僵尸对象）</code>。这种方案的重点就是 <code>将释放的对象，全部转为僵尸对象</code></li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/BboyZJ.github.io/assets/16488672958625.jpg"
                     
                ></p>
<h2 id="两种方案对比"><a href="#两种方案对比" class="headerlink" title="两种方案对比"></a>两种方案对比</h2><ul>
<li><p><code>僵尸对象</code> 相比 <code>Malloc Scribble</code>，不需要考虑会不会崩溃的问题，只要野指针指向僵尸对象，那么再次访问野指针就一定会崩溃</p>
</li>
<li><p>僵尸对象这种方式，不如 <code>Malloc Scribble覆盖面广</code>，可以通过 <code>hook free</code> 方法将c函数也包含在其中</p>
</li>
</ul>
<h2 id="Malloc-Scribble"><a href="#Malloc-Scribble" class="headerlink" title="Malloc Scribble"></a>Malloc Scribble</h2><p>思路：当访问到对象内存中填写的是 <code>0xAA、0x55</code> 时，程序就会出现异常</p>
<ul>
<li>申请内存 <code>alloc</code> 时在内存上填 <code>0xAA</code></li>
<li>释放内存 <code>dealloc</code> 使在内存上填 <code>0x55</code></li>
</ul>
<p>以上的申请和释放的填充分别对应以下两种情况</p>
<ul>
<li>申请：没有错初始化就直接被访问</li>
<li>释放：释放后访问</li>
</ul>
<p>所以综上所述，针对野指针，我们的解决办法是：在对象释放时做数据填充 <code>0x55</code> 即可，关于对象的释放流程可以参考这篇文章 <a href="">OC底层原理35：内存管理（一）TaggedPointer&#x2F;retain&#x2F;release&#x2F;dealloc&#x2F;</a></p>
<h1 id="野指针探测实现1"><a href="#野指针探测实现1" class="headerlink" title="野指针探测实现1"></a>野指针探测实现1</h1><p>这个实现主要依据 <a class="link"   target="_blank" rel="noopener" href="https://github.com/fangjinfeng/MySampleCode/tree/master/FJFZombieSnifferDemo" >腾讯Bugly工程师：陈其锋 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 的分享，在其代码的主要思路是：</p>
<ul>
<li><p>通过 <code>fishhook</code> 替换 <code>c函数</code> 的 <code>free</code> 方法为自定义的 <code>safe_free</code>，类似于 <code>Method Swizzling</code></p>
</li>
<li><p>在 <code>safe_free</code> 方法中对 <code>已经释放变量的内</code>存，填充 <code>0x55</code> ，使已经释放变量 <code>不能访问</code>，从而使某些野指针的crash从不必现变成 <code>必现</code></p>
<ul>
<li><p>为了 <code>防止填充0x55的内存内新的数据内容填充</code>，使野指针crash变成不必现，在这里采用的策略是，safe_free不释放这片内存，而是自己保留着，即safe_free方法中不会真的调用free。</p>
</li>
<li><p>同时为了 <code>防止系统内存过快消耗（因为要保留内存）</code>，需要在 <code>保留内存大于一定值时释放一部分</code>，防止被系统杀死，同时，在收到 <code>系统内存警告</code> 时，也需要 <code>释放一部分内存</code></p>
</li>
</ul>
</li>
<li><p>发生crash时，得到的崩溃信息有限，不利于排查问题，所以这里采用代理类（即集成自 NSProxy的子类），重写消息转发的三个方法（参考这篇文章 <a href="https://www.bboyzj.cn/2020/10/06/OC%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%8614-3%EF%BC%9A%E6%B6%88%E6%81%AF%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%E4%B9%8B%E5%8A%A8%E6%80%81%E6%96%B9%E6%B3%95%E5%86%B3%E8%AE%AE&%E6%B6%88%E6%81%AF%E8%BD%AC%E5%8F%91/">OC底层原理14-3：消息流程分析之动态方法决议 &amp; 消息转发</a>），以及NSObject的实例方法，来获取异常信息。但是这样的话，还有一个问题，就是NSProxy只能做OC对象的代理，所以需要在safe_free中增加对象类型的判断</p>
</li>
</ul>
<p>以下是完整的野指针探测实现代码</p>
<ul>
<li>引入fishhook</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/BboyZJ.github.io/assets/16488770386627.jpg"
                     
                ></p>
<ul>
<li>实现NSProxy的代理子类</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--1、MIZombieProxy.h--&gt;</span><br><span class="line">@interface MIZombieProxy : NSProxy</span><br><span class="line"></span><br><span class="line">@property (nonatomic, assign) Class originClass;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&lt;!--2、MIZombieProxy.m--&gt;</span><br><span class="line">#import &quot;MIZombieProxy.h&quot;</span><br><span class="line"></span><br><span class="line">@implementation MIZombieProxy</span><br><span class="line"></span><br><span class="line">- (BOOL)respondsToSelector:(SEL)aSelector&#123;</span><br><span class="line">    return [self.originClass instancesRespondToSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel&#123;</span><br><span class="line">    return [self.originClass instanceMethodSignatureForSelector:sel];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)forwardInvocation: (NSInvocation *)invocation</span><br><span class="line">&#123;</span><br><span class="line">    [self _throwMessageSentExceptionWithSelector: invocation.selector];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#define MIZombieThrowMesssageSentException() [self _throwMessageSentExceptionWithSelector: _cmd]</span><br><span class="line">- (Class)class&#123;</span><br><span class="line">    MIZombieThrowMesssageSentException();</span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br><span class="line">- (BOOL)isEqual:(id)object&#123;</span><br><span class="line">    MIZombieThrowMesssageSentException();</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br><span class="line">- (NSUInteger)hash&#123;</span><br><span class="line">    MIZombieThrowMesssageSentException();</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line">- (id)self&#123;</span><br><span class="line">    MIZombieThrowMesssageSentException();</span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br><span class="line">- (BOOL)isKindOfClass:(Class)aClass&#123;</span><br><span class="line">    MIZombieThrowMesssageSentException();</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br><span class="line">- (BOOL)isMemberOfClass:(Class)aClass&#123;</span><br><span class="line">    MIZombieThrowMesssageSentException();</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br><span class="line">- (BOOL)conformsToProtocol:(Protocol *)aProtocol&#123;</span><br><span class="line">    MIZombieThrowMesssageSentException();</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br><span class="line">- (BOOL)isProxy&#123;</span><br><span class="line">    MIZombieThrowMesssageSentException();</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSString *)description&#123;</span><br><span class="line">    MIZombieThrowMesssageSentException();</span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - MRC</span><br><span class="line">- (instancetype)retain&#123;</span><br><span class="line">    MIZombieThrowMesssageSentException();</span><br><span class="line">    return  nil;</span><br><span class="line">&#125;</span><br><span class="line">- (oneway void)release&#123;</span><br><span class="line">    MIZombieThrowMesssageSentException();</span><br><span class="line">&#125;</span><br><span class="line">- (void)dealloc</span><br><span class="line">&#123;</span><br><span class="line">    MIZombieThrowMesssageSentException();</span><br><span class="line">    [super dealloc];</span><br><span class="line">&#125;</span><br><span class="line">- (NSUInteger)retainCount&#123;</span><br><span class="line">    MIZombieThrowMesssageSentException();</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line">- (struct _NSZone *)zone&#123;</span><br><span class="line">    MIZombieThrowMesssageSentException();</span><br><span class="line">    return  nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#pragma mark - private</span><br><span class="line">- (void)_throwMessageSentExceptionWithSelector:(SEL)selector&#123;</span><br><span class="line">    @throw [NSException exceptionWithName:NSInternalInconsistencyException reason:[NSString stringWithFormat:@&quot;(-[%@ %@]) was sent to a zombie object at address: %p&quot;, NSStringFromClass(self.originClass),NSStringFromSelector(selector), self] userInfo:nil];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure></div>

<ul>
<li>hook free 方法的具体实现</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--1、MISafeFree.h--&gt;</span><br><span class="line">@interface MISafeFree : NSObject</span><br><span class="line"></span><br><span class="line">//系统警告时，用函数释放一些内存</span><br><span class="line">void free_safe_mem(size_t freeNum);</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&lt;!--2、MISafeFree.m--&gt;</span><br><span class="line">#import &quot;MISafeFree.h&quot;</span><br><span class="line">#import &quot;queue.h&quot;</span><br><span class="line">#import &quot;fishhook.h&quot;</span><br><span class="line">#import &quot;MIZombieProxy.h&quot;</span><br><span class="line"></span><br><span class="line">#import &lt;dlfcn.h&gt;</span><br><span class="line">#import &lt;objc/runtime.h&gt;</span><br><span class="line">#import &lt;malloc/malloc.h&gt;</span><br><span class="line"></span><br><span class="line">//用于保存zombie类</span><br><span class="line">static Class kMIZombieIsa;</span><br><span class="line">//用于保存zombie类的实例变量大小</span><br><span class="line">static size_t kMIZombieSize;</span><br><span class="line"></span><br><span class="line">//用于表示调用free函数</span><br><span class="line">static void(* orig_free)(void *p);</span><br><span class="line">//用于保存已注册的类的集合</span><br><span class="line">static CFMutableSetRef registeredClasses = nil;</span><br><span class="line">/*</span><br><span class="line"> 用来保存自己保留的内存</span><br><span class="line"> - 1、队列要线程安全或者自己加锁</span><br><span class="line"> - 2、这个队列内部应该尽量少申请和释放堆内存</span><br><span class="line"> */</span><br><span class="line">struct DSQueue *_unfreeQueue = NULL;</span><br><span class="line">//用来记录自己保存的内存的大小</span><br><span class="line">int unfreeSize = 0;</span><br><span class="line"></span><br><span class="line">//最多存储的内存，大于这个值就释放一部分</span><br><span class="line">#define MAX_STEAL_MEM_SIZE 1024*1024*100</span><br><span class="line">//最多保留的指针个数，超过就释放一部分</span><br><span class="line">#define MAX_STEAL_MEM_NUM 1024*1024*10</span><br><span class="line">//每次释放时释放的指针数量</span><br><span class="line">#define BATCH_FREE_NUM 100</span><br><span class="line"></span><br><span class="line">@implementation MISafeFree</span><br><span class="line"></span><br><span class="line">#pragma mark - Public Method</span><br><span class="line">//系统警告时，用函数释放一些内存</span><br><span class="line">void free_safe_mem(size_t freeNum)&#123;</span><br><span class="line">#ifdef DEBUG</span><br><span class="line">    //获取队列的长度</span><br><span class="line">    size_t count = ds_queue_length(_unfreeQueue);</span><br><span class="line">    //需要释放的内存大小</span><br><span class="line">    freeNum = freeNum &gt; count ? count : freeNum;</span><br><span class="line">    //遍历并释放</span><br><span class="line">    for (int i = 0; i &lt; freeNum; i++) &#123;</span><br><span class="line">        //获取未释放的内存块</span><br><span class="line">        void *unfreePoint = ds_queue_get(_unfreeQueue);</span><br><span class="line">        //创建内存块申请的大小</span><br><span class="line">        size_t memSize = malloc_size(unfreePoint);</span><br><span class="line">        //原子减操作，多线程对全局变量进行自减</span><br><span class="line">        __sync_fetch_and_sub(&amp;unfreeSize, (int)memSize);</span><br><span class="line">        //释放</span><br><span class="line">        orig_free(unfreePoint);</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - Life Circle</span><br><span class="line"></span><br><span class="line">+ (void)load&#123;</span><br><span class="line">#ifdef DEBUG</span><br><span class="line">    loadZombieProxyClass();</span><br><span class="line">    init_safe_free();</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - Private Method</span><br><span class="line">void safe_free(void* p)&#123;</span><br><span class="line">    </span><br><span class="line">    //获取自己保留的内存的大小</span><br><span class="line">    int unFreeCount = ds_queue_length(_unfreeQueue);</span><br><span class="line">    //保留的内存大于一定值时就释放一部分</span><br><span class="line">    if (unFreeCount &gt; MAX_STEAL_MEM_NUM*0.9 || unfreeSize&gt;MAX_STEAL_MEM_SIZE) &#123;</span><br><span class="line">        free_safe_mem(BATCH_FREE_NUM);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        //创建p申请的内存大小</span><br><span class="line">        size_t memSize = malloc_size(p);</span><br><span class="line">        //有足够的空间才覆盖</span><br><span class="line">        if (memSize &gt; kMIZombieSize) &#123;</span><br><span class="line">            //指针强转为id对象</span><br><span class="line">            id obj = (id)p;</span><br><span class="line">            //获取指针原本的类</span><br><span class="line">            Class origClass = object_getClass(obj);</span><br><span class="line">            //判断是不是objc对象</span><br><span class="line">            char *type = @encode(typeof(obj));</span><br><span class="line">            /*</span><br><span class="line">             - strcmp 字符串比较</span><br><span class="line">             - CFSetContainsValue 查看已注册类中是否有origClass这个类</span><br><span class="line">             </span><br><span class="line">             如果都满足，则将这块内存填充0x55</span><br><span class="line">             */</span><br><span class="line">            if (strcmp(&quot;@&quot;, type) == 0 &amp;&amp; CFSetContainsValue(registeredClasses, origClass)) &#123;</span><br><span class="line">                //内存上填充0x55</span><br><span class="line">                memset(obj, 0x55, memSize);</span><br><span class="line">                //将自己类的isa复制过去</span><br><span class="line">                memcpy(obj, &amp;kMIZombieIsa, sizeof(void*));</span><br><span class="line">                //为obj设置指定的类</span><br><span class="line">                object_setClass(obj, [MIZombieProxy class]);</span><br><span class="line">                //保留obj原本的类</span><br><span class="line">                ((MIZombieProxy*)obj).originClass = origClass;</span><br><span class="line">                //多线程下int的原子加操作，多线程对全局变量进行自加，不用理会线程锁了</span><br><span class="line">                __sync_fetch_and_add(&amp;unfreeSize, (int)memSize);</span><br><span class="line">                //入队</span><br><span class="line">                ds_queue_put(_unfreeQueue, p);</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                orig_free(p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            orig_free(p);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//加载野指针自定义类</span><br><span class="line">void loadZombieProxyClass()&#123;</span><br><span class="line">    registeredClasses = CFSetCreateMutable(NULL, 0, NULL);</span><br><span class="line">    </span><br><span class="line">    //用于保存已注册类的个数</span><br><span class="line">    unsigned int count = 0;</span><br><span class="line">    //获取所有已注册的类</span><br><span class="line">    Class *classes = objc_copyClassList(&amp;count);</span><br><span class="line">    //遍历，并保存到registeredClasses中</span><br><span class="line">    for (int i = 0; i &lt; count; i++) &#123;</span><br><span class="line">        CFSetAddValue(registeredClasses, (__bridge const void *)(classes[i]));</span><br><span class="line">    &#125;</span><br><span class="line">    //释放临时变量内存</span><br><span class="line">    free(classes);</span><br><span class="line">    classes = NULL;</span><br><span class="line">    </span><br><span class="line">    kMIZombieIsa = objc_getClass(&quot;MIZombieProxy&quot;);</span><br><span class="line">    kMIZombieSize = class_getInstanceSize(kMIZombieIsa);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//初始化以及free符号重绑定</span><br><span class="line">bool init_safe_free()&#123;</span><br><span class="line">    //初始化用于保存内存的队列</span><br><span class="line">    _unfreeQueue = ds_queue_create(MAX_STEAL_MEM_NUM);</span><br><span class="line">    //dlsym 在打开的库中查找符号的值，即动态调用free函数</span><br><span class="line">    orig_free = (void(*)(void*))dlsym(RTLD_DEFAULT, &quot;free&quot;);</span><br><span class="line">    /*</span><br><span class="line">     rebind_symbols:符号重绑定</span><br><span class="line">     - 参数1：rebindings 是一个rebinding数组，其定义如下</span><br><span class="line">         struct rebinding &#123;</span><br><span class="line">           const char *name;  // 目标符号名</span><br><span class="line">           void *replacement; // 要替换的符号值（地址值）</span><br><span class="line">           void **replaced;   // 用来存放原来的符号值（地址值）</span><br><span class="line">         &#125;;</span><br><span class="line">     - 参数2：rebindings_nel 描述数组的长度</span><br><span class="line">     */</span><br><span class="line">    //重绑定free符号，让它指向自定义的safe_free函数</span><br><span class="line">    rebind_symbols((struct rebinding[])&#123;&#123;&quot;free&quot;, (void*)safe_free&#125;&#125;, 1);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure></div>

<ul>
<li>测试</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    id obj = [[NSObject alloc] init];</span><br><span class="line">    self.assignObj = obj;</span><br><span class="line">    </span><br><span class="line">//    [MIZombieSniffer installSniffer];</span><br><span class="line">&#125;</span><br><span class="line">- (IBAction)mallocScribbleAction:(id)sender &#123;</span><br><span class="line">    </span><br><span class="line">    UIView* testObj = [[UIView alloc] init];</span><br><span class="line">    [testObj release];</span><br><span class="line">    for (int i = 0; i &lt; 10; i++) &#123;</span><br><span class="line">        UIView* testView = [[UIView alloc] initWithFrame:CGRectMake(0,200,CGRectGetWidth(self.view.bounds), 60)];</span><br><span class="line">        [self.view addSubview:testView];</span><br><span class="line">    &#125;</span><br><span class="line">    [testObj setNeedsLayout];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>打印结果如下</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/BboyZJ.github.io/assets/16488771182594.jpg"
                     
                ></p>
<h1 id="Zombie-Objects"><a href="#Zombie-Objects" class="headerlink" title="Zombie Objects"></a>Zombie Objects</h1><p><strong>僵尸对象</strong></p>
<ul>
<li><p>可以用来检测内存错误（<code>EXC_BAD_ACCESS</code>）,它可以捕获任何阐释访问坏内存的调用</p>
</li>
<li><p>给僵尸对象发送消息的话，它仍然是可以响应的，然后会发生崩溃，并输出错误日志来显示野指针对象调用的类名和方法</p>
</li>
</ul>
<p><strong>苹果的僵尸对象检测原理</strong></p>
<p>首先我们来看下Xcode中僵尸对象是如何实现的，具体操作步骤可以参考这篇文章 <a class="link"   target="_blank" rel="noopener" href="https://www.jianshu.com/go-wild?ac=2&url=https%253A%252F%252Fzhiyongzou.github.io%252F2017%252F08%252F25%252FiOS-Zombie-Object-%2525E5%252583%2525B5%2525E5%2525B0%2525B8%2525E5%2525AF%2525B9%2525E8%2525B1%2525A1-%2525E5%25258E%25259F%2525E7%252590%252586%2525E6%25258E%2525A2%2525E7%2525B4%2525A2%252F" >iOS Zombie Objects(僵尸对象)原理探索 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<ul>
<li>从 dealloc 的源码中，我们可以看到 Replaced by NSZombie，即 对象释放 时，NSZombie 将 dealloc 里做替换，如下所示</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/BboyZJ.github.io/assets/16488773598076.jpg"
                     
                ></p>
<p>所以僵尸对象的生成过程伪代码如下</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//1、获取到即将deallocted对象所属类（Class）</span><br><span class="line">Class cls = object_getClass(self);</span><br><span class="line"></span><br><span class="line">//2、获取类名</span><br><span class="line">const char *clsName = class_getName(cls)</span><br><span class="line"></span><br><span class="line">//3、生成僵尸对象类名</span><br><span class="line">const char *zombieClsName = &quot;_NSZombie_&quot; + clsName;</span><br><span class="line"></span><br><span class="line">//4、查看是否存在相同的僵尸对象类名，不存在则创建</span><br><span class="line">Class zombieCls = objc_lookUpClass(zombieClsName);</span><br><span class="line">if (!zombieCls) &#123;</span><br><span class="line">     //5、获取僵尸对象类 _NSZombie_</span><br><span class="line"> Class baseZombieCls = objc_lookUpClass(“_NSZombie_&quot;);</span><br><span class="line"></span><br><span class="line">     //6、创建 zombieClsName 类</span><br><span class="line"> zombieCls = objc_duplicateClass(baseZombieCls, zombieClsName, 0);</span><br><span class="line">&#125;</span><br><span class="line">//7、在对象内存未被释放的情况下销毁对象的成员变量及关联引用。</span><br><span class="line">   objc_destructInstance(self);</span><br><span class="line"></span><br><span class="line">//8、修改对象的 isa 指针，令其指向特殊的僵尸类</span><br><span class="line">objc_setClass(self, zombieCls);</span><br></pre></td></tr></table></figure></div>

<ul>
<li>当僵尸对象再次被访问时，将进入消息转发流程，开始处理僵尸对象访问，输出日志并发生crash</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/BboyZJ.github.io/assets/16488774216302.jpg"
                     
                ></p>
<p>所以僵尸对象触发流程伪代码如下</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">//1、获取对象class</span><br><span class="line">Class cls = object_getClass(self);</span><br><span class="line"></span><br><span class="line">//2、获取对象类名</span><br><span class="line">const char *clsName = class_getName(cls);</span><br><span class="line"></span><br><span class="line">//3、检测是否带有前缀_NSZombie_</span><br><span class="line">if (string_has_prefix(clsName, &quot;_NSZombie_&quot;)) &#123;</span><br><span class="line">//4、获取被野指针对象类名</span><br><span class="line">  const char *originalClsName = substring_from(clsName, 10);</span><br><span class="line"></span><br><span class="line">　//5、获取当前调用方法名</span><br><span class="line">　const char *selectorName = sel_getName(_cmd);</span><br><span class="line">　　</span><br><span class="line">　//6、输出日志</span><br><span class="line">　Log(&#x27;&#x27;*** - [%s %s]: message sent to deallocated instance %p&quot;, originalClsName, selectorName, self);</span><br><span class="line"></span><br><span class="line">　//7、结束进程</span><br><span class="line">　abort();</span><br></pre></td></tr></table></figure></div>

<p>所以综上所述，这野指针探测方式的思路是：<code>dealloc</code> 方法的替换，其关键是调用 <code>objc_destructInstance</code> 来解除对象的关联引用</p>
<h1 id="野指针探测实现2"><a href="#野指针探测实现2" class="headerlink" title="野指针探测实现2"></a>野指针探测实现2</h1><p>这种思路主要来源 <a class="link"   target="_blank" rel="noopener" href="https://www.jianshu.com/go-wild?ac=2&url=http%253A%252F%252FLXDZombieSniffer" >sindrilin <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 的源码，其主要思路是：</p>
<p><strong>野指针检测流程</strong></p>
<ul>
<li><p>开启野指针检测</p>
</li>
<li><p>设值监控到野指针的回调block，在block中打印信息，或者存储堆栈</p>
</li>
<li><p>检测到野指针是否crash</p>
</li>
<li><p>最大内存占用空间</p>
</li>
<li><p>是否记录dealloc调用栈</p>
</li>
<li><p>监控策略</p>
<ul>
<li><p>只监控自定义对象</p>
</li>
<li><p>白名单策略</p>
</li>
<li><p>黑名单策略</p>
</li>
<li><p>监控所有对象</p>
</li>
</ul>
</li>
<li><p>交换NSObject的dealloc方法</p>
</li>
</ul>
<p><strong>触发野指针</strong></p>
<ul>
<li><p>开始处理对象</p>
</li>
<li><p>是否达到替换条件</p>
<ul>
<li>根据监控策略，是否属于要检测的类</li>
<li>空间是否足够</li>
</ul>
</li>
<li><p>如果符合条件，则获取对象，并解除引用，如果不符合则正常释放，即调用原来的dealloc方法</p>
</li>
<li><p>向对象内填充数据</p>
</li>
<li><p>赋值僵尸对象的类指针替换isa</p>
</li>
<li><p>对象+dealloc调用栈，保存在僵尸对象中</p>
</li>
<li><p>根据情况是否清理内存和对象</p>
</li>
</ul>
<p><strong>通过僵尸对象检测的实现思路</strong></p>
<ul>
<li><p>通过OC中 Method Swizzling，交换 根类NSObject和NSProxy 的 dealloc 方法为 自定义的dealloc 方法</p>
</li>
<li><p>为了 避免内存空间释放后被重写造成野指针 的问题，通过 字典存储被释放的对象，同时设置在 30s后调用dealloc方法将字典中存储的对象释放，避免内存增大</p>
</li>
<li><p>为了获取更多的崩溃信息，这里同样需要创建NSProxy的子类</p>
</li>
</ul>
<p><strong>具体实现</strong></p>
<ul>
<li><p>创建NSProxy的子类，其实现与上面的 MIZombieProxy 是一模一样的</p>
</li>
<li><p>hook dealloc 函数的具体实现</p>
</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--1、MIZombieSniffer.h--&gt;</span><br><span class="line">@interface MIZombieSniffer : NSObject</span><br><span class="line"></span><br><span class="line">/*!</span><br><span class="line"> *  @method installSniffer</span><br><span class="line"> *  启动zombie检测</span><br><span class="line"> */</span><br><span class="line">+ (void)installSniffer;</span><br><span class="line"></span><br><span class="line">/*!</span><br><span class="line"> *  @method uninstallSnifier</span><br><span class="line"> *  停止zombie检测</span><br><span class="line"> */</span><br><span class="line">+ (void)uninstallSnifier;</span><br><span class="line"></span><br><span class="line">/*!</span><br><span class="line"> *  @method appendIgnoreClass</span><br><span class="line"> *  添加白名单类</span><br><span class="line"> */</span><br><span class="line">+ (void)appendIgnoreClass: (Class)cls;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&lt;!--2、MIZombieSniffer.m--&gt;</span><br><span class="line">#import &quot;MIZombieSniffer.h&quot;</span><br><span class="line">#import &quot;MIZombieProxy.h&quot;</span><br><span class="line">#import &lt;objc/runtime.h&gt;</span><br><span class="line"></span><br><span class="line">//</span><br><span class="line">typedef void (*MIDeallocPointer) (id objc);</span><br><span class="line">//野指针探测器是否开启</span><br><span class="line">static BOOL _enabled = NO;</span><br><span class="line">//根类</span><br><span class="line">static NSArray *_rootClasses = nil;</span><br><span class="line">//用于存储被释放的对象</span><br><span class="line">static NSDictionary&lt;id, NSValue*&gt; *_rootClassDeallocImps = nil;</span><br><span class="line"></span><br><span class="line">//白名单</span><br><span class="line">static inline NSMutableSet *__mi_sniffer_white_lists()&#123;</span><br><span class="line">    //创建白名单集合</span><br><span class="line">    static NSMutableSet *mi_sniffer_white_lists;</span><br><span class="line">    //单例初始化白名单集合</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        mi_sniffer_white_lists = [[NSMutableSet alloc] init];</span><br><span class="line">    &#125;);</span><br><span class="line">    return mi_sniffer_white_lists;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static inline void __mi_dealloc(__unsafe_unretained id obj)&#123;</span><br><span class="line">    //获取对象的类</span><br><span class="line">    Class currentCls = [obj class];</span><br><span class="line">    Class rootCls = currentCls;</span><br><span class="line">    </span><br><span class="line">    //获取非NSObject和NSProxy的类</span><br><span class="line">    while (rootCls != [NSObject class] &amp;&amp; rootCls != [NSProxy class]) &#123;</span><br><span class="line">        //获取rootCls的父类，并赋值</span><br><span class="line">        rootCls = class_getSuperclass(rootCls);</span><br><span class="line">    &#125;</span><br><span class="line">    //获取类名</span><br><span class="line">    NSString *clsName = NSStringFromClass(rootCls);</span><br><span class="line">    //根据类名获取dealloc的imp指针</span><br><span class="line">    MIDeallocPointer deallocImp = NULL;</span><br><span class="line">    [[_rootClassDeallocImps objectForKey:clsName] getValue:&amp;deallocImp];</span><br><span class="line">    </span><br><span class="line">    if (deallocImp != NULL) &#123;</span><br><span class="line">        deallocImp(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//hook交换dealloc</span><br><span class="line">static inline IMP __mi_swizzleMethodWithBlock(Method method, void *block)&#123;</span><br><span class="line">    /*</span><br><span class="line">     imp_implementationWithBlock ：接收一个block参数，将其拷贝到堆中，返回一个trampoline</span><br><span class="line">     可以让block当做任何一个类的方法的实现，即当做类的方法的IMP来使用</span><br><span class="line">     */</span><br><span class="line">    IMP blockImp = imp_implementationWithBlock((__bridge id _Nonnull)(block));</span><br><span class="line">    //method_setImplementation 替换掉method的IMP</span><br><span class="line">    return method_setImplementation(method, blockImp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@implementation MIZombieSniffer</span><br><span class="line"></span><br><span class="line">//初始化根类</span><br><span class="line">+ (void)initialize</span><br><span class="line">&#123;</span><br><span class="line">    _rootClasses = [@[[NSObject class], [NSProxy class]] retain];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - public</span><br><span class="line">+ (void)installSniffer&#123;</span><br><span class="line">    @synchronized (self) &#123;</span><br><span class="line">        if (!_enabled) &#123;</span><br><span class="line">            //hook根类的dealloc方法</span><br><span class="line">            [self _swizzleDealloc];</span><br><span class="line">            _enabled = YES;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (void)uninstallSnifier&#123;</span><br><span class="line">    @synchronized (self) &#123;</span><br><span class="line">        if (_enabled) &#123;</span><br><span class="line">            //还原dealloc方法</span><br><span class="line">            [self _unswizzleDealloc];</span><br><span class="line">            _enabled = NO;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//添加百名单</span><br><span class="line">+ (void)appendIgnoreClass:(Class)cls&#123;</span><br><span class="line">    @synchronized (self) &#123;</span><br><span class="line">        NSMutableSet *whiteList = __mi_sniffer_white_lists();</span><br><span class="line">        NSString *clsName = NSStringFromClass(cls);</span><br><span class="line">        [clsName retain];</span><br><span class="line">        [whiteList addObject:clsName];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - private</span><br><span class="line">+ (void)_swizzleDealloc&#123;</span><br><span class="line">    static void *swizzledDeallocBlock = NULL;</span><br><span class="line">    </span><br><span class="line">    //定义block，作为方法的IMP</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        swizzledDeallocBlock = (__bridge void *)[^void(id obj) &#123;</span><br><span class="line">            //获取对象的类</span><br><span class="line">            Class currentClass = [obj class];</span><br><span class="line">            //获取类名</span><br><span class="line">            NSString *clsName = NSStringFromClass(currentClass);</span><br><span class="line">            //判断该类是否在白名单类</span><br><span class="line">            if ([__mi_sniffer_white_lists() containsObject: clsName]) &#123;</span><br><span class="line">                //如果在白名单内，则直接释放对象</span><br><span class="line">                __mi_dealloc(obj);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                //修改对象的isa指针，指向MIZombieProxy</span><br><span class="line">                /*</span><br><span class="line">                 valueWithBytes:objCType  创建并返回一个包含给定值的NSValue对象，该值会被解释为一个给定的NSObject类型</span><br><span class="line">                 - 参数1：NSValue对象的值</span><br><span class="line">                 - 参数2：给定值的对应的OC类型，需要使用编译器指令@encode来创建</span><br><span class="line">                 */</span><br><span class="line">                NSValue *objVal = [NSValue valueWithBytes: &amp;obj objCType: @encode(typeof(obj))];</span><br><span class="line">                //为obj设置指定的类</span><br><span class="line">                object_setClass(obj, [MIZombieProxy class]);</span><br><span class="line">                //保留对象原本的类</span><br><span class="line">                ((MIZombieProxy *)obj).originClass = currentClass;</span><br><span class="line">                </span><br><span class="line">                //设置在30s后调用dealloc将存储的对象释放，避免内存空间的增大</span><br><span class="line">                dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(30 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                    __unsafe_unretained id deallocObj = nil;</span><br><span class="line">                    //获取需要dealloc的对象</span><br><span class="line">                    [objVal getValue: &amp;deallocObj];</span><br><span class="line">                    //设置对象的类为原本的类</span><br><span class="line">                    object_setClass(deallocObj, currentClass);</span><br><span class="line">                    //释放</span><br><span class="line">                    __mi_dealloc(deallocObj);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; copy];</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    //交换了根类NSObject和NSProxy的dealloc方法为originalDeallocImp</span><br><span class="line">    NSMutableDictionary *deallocImps = [NSMutableDictionary dictionary];</span><br><span class="line">    //遍历根类</span><br><span class="line">    for (Class rootClass in _rootClasses) &#123;</span><br><span class="line">        //获取指定类中dealloc方法</span><br><span class="line">        Method oriMethod = class_getInstanceMethod([rootClass class], NSSelectorFromString(@&quot;dealloc&quot;));</span><br><span class="line">        //hook - 交换dealloc方法的IMP实现</span><br><span class="line">        IMP originalDeallocImp = __mi_swizzleMethodWithBlock(oriMethod, swizzledDeallocBlock);</span><br><span class="line">        //设置IMP的具体实现</span><br><span class="line">        [deallocImps setObject: [NSValue valueWithBytes: &amp;originalDeallocImp objCType: @encode(typeof(IMP))] forKey: NSStringFromClass(rootClass)];</span><br><span class="line">    &#125;</span><br><span class="line">    //_rootClassDeallocImps字典存储交换后的IMP实现</span><br><span class="line">    _rootClassDeallocImps = [deallocImps copy];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (void)_unswizzleDealloc&#123;</span><br><span class="line">    //还原dealloc交换的IMP</span><br><span class="line">    [_rootClasses enumerateObjectsUsingBlock:^(Class rootClass, NSUInteger idx, BOOL * _Nonnull stop) &#123;</span><br><span class="line">        IMP originDeallocImp = NULL;</span><br><span class="line">        //获取根类类名</span><br><span class="line">        NSString *clsName = NSStringFromClass(rootClass);</span><br><span class="line">        //获取hook后的dealloc实现</span><br><span class="line">        [[_rootClassDeallocImps objectForKey:clsName] getValue:&amp;originDeallocImp];</span><br><span class="line">        </span><br><span class="line">        NSParameterAssert(originDeallocImp);</span><br><span class="line">        //获取原本的dealloc实现</span><br><span class="line">        Method oriMethod = class_getInstanceMethod([rootClass class], NSSelectorFromString(@&quot;dealloc&quot;));</span><br><span class="line">        //还原dealloc的实现</span><br><span class="line">        method_setImplementation(oriMethod, originDeallocImp);</span><br><span class="line">    &#125;];</span><br><span class="line">    //释放</span><br><span class="line">    [_rootClassDeallocImps release];</span><br><span class="line">    _rootClassDeallocImps = nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure></div>

<ul>
<li>测试</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@interface ViewController ()</span><br><span class="line"></span><br><span class="line">@property (nonatomic, assign) id assignObj;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation ViewController</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    id obj = [[NSObject alloc] init];</span><br><span class="line">    self.assignObj = obj;</span><br><span class="line">    </span><br><span class="line">    [MIZombieSniffer installSniffer];</span><br><span class="line">&#125;</span><br><span class="line">- (IBAction)zombieObjectAction:(id)sender &#123;</span><br><span class="line"></span><br><span class="line">    NSLog(@&quot;%@&quot;, self.assignObj);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>打印崩溃信息如下</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/BboyZJ.github.io/assets/16488787909724.jpg"
                     
                ></p>

            </div>

            
                <div class="post-copyright-info">
                    <div class="article-copyright-info-container">
    <ul>
        <li>Post title：OC底层原理41：内存优化（一）野指针探测</li>
        <li>Post author：张建</li>
        <li>Create time：2021-07-22 14:51:26</li>
        <li>
            Post link：https://redefine.ohevan.com/2021/07/22/OC进阶/OC底层原理41：内存优化（一）野指针探测/
        </li>
        <li>
            Copyright Notice：All articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> unless stating additionally.
        </li>
    </ul>
</div>

                </div>
            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/BboyZJ.github.io/tags/iOS-OC/">#iOS-OC</a>&nbsp;
                        </li>
                    
                </ul>
            

            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                            rel="prev"
                            href="/BboyZJ.github.io/2022/01/04/OC%E8%BF%9B%E9%98%B6/OC%E9%AB%98%E7%BA%A7%E5%BC%BA%E5%8C%9601%EF%BC%9A%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"
                            >
                                <span class="left arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </span>
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">OC高级强化01：多环境配置</span>
                                    <span class="post-nav-item">Prev posts</span>
                                </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                            rel="next"
                            href="/BboyZJ.github.io/2021/07/13/OC%E5%AD%A6%E4%B9%A0/OC%E5%AD%A6%E4%B9%A015%EF%BC%9ASDWebImage%E6%8E%A2%E7%B4%A2/"
                            >
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">OC学习15：SDWebImage探索</span>
                                    <span class="post-nav-item">Next posts</span>
                                </span>
                                <span class="right arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </span>
                            </a>
                        </div>
                    
                </div>
            


            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">OC底层原理41：内存优化（一）野指针探测</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8A%80%E6%9C%AF%E7%82%B9%EF%BC%9A%E9%87%8E%E6%8C%87%E9%92%88%E6%8E%A2%E6%B5%8B"><span class="nav-text">技术点：野指针探测</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%95%E5%AD%90"><span class="nav-text">引子</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E7%B1%BB%E5%9E%8B"><span class="nav-text">异常类型</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Mach%E5%BC%82%E5%B8%B8%E4%B8%8EUNIX%E4%BF%A1%E5%8F%B7%E7%9A%84%E8%BD%AC%E6%8D%A2"><span class="nav-text">Mach异常与UNIX信号的转换</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%87%8E%E6%8C%87%E9%92%88"><span class="nav-text">野指针</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8E%E6%8C%87%E9%92%88%E5%88%86%E7%B1%BB"><span class="nav-text">野指针分类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88OC%E9%87%8E%E6%8C%87%E9%92%88%E7%9A%84crash%E8%BF%99%E4%B9%88%E5%A4%9A%EF%BC%9F"><span class="nav-text">为什么OC野指针的crash这么多？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8E%E6%8C%87%E9%92%88%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF"><span class="nav-text">野指针解决思路</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%A4%E7%A7%8D%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94"><span class="nav-text">两种方案对比</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Malloc-Scribble"><span class="nav-text">Malloc Scribble</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%87%8E%E6%8C%87%E9%92%88%E6%8E%A2%E6%B5%8B%E5%AE%9E%E7%8E%B01"><span class="nav-text">野指针探测实现1</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Zombie-Objects"><span class="nav-text">Zombie Objects</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%87%8E%E6%8C%87%E9%92%88%E6%8E%A2%E6%B5%8B%E5%AE%9E%E7%8E%B02"><span class="nav-text">野指针探测实现2</span></a></li></ol>

    </div>
</div>
            </div>
        
    </div>
</div>


                

            </div>



        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info">
            &copy;
            
              <span>2019</span>
              -
            
            2023&nbsp;&nbsp;<i class="fa-regular fa-computer-classic"></i>&nbsp;&nbsp;<a href="/">张建</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv" class="busuanzi_container_site_uv">
                        VISITOR COUNT&nbsp;<span id="busuanzi_value_site_uv" class="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="busuanzi_container_site_pv">
                        TOTAL PAGE VIEWS&nbsp;<span id="busuanzi_value_site_pv" class="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            <span class="powered-by-container">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" href="https://hexo.io">Hexo</a></span>
                <br> 
            <span class="theme-version-container">THEME&nbsp;<a class="theme-version" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v1.1.5</a>
        </div>
        
        
        
            <div id="start_time_div" style="display:none">
                2019/8/17 11:45:14
            </div>
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
        
            <script async data-pjax>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="unfolded-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-expand-width flex-center">
            <i class="fa-regular fa-expand"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="right-bottom-tools tool-scroll-to-top flex-center">
                <i class="fa-regular fa-arrow-up"></i>
            </li>
        

        <li class="right-bottom-tools tool-scroll-to-bottom flex-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="folded-tools-list">
        <li class="right-bottom-tools tool-toggle-show flex-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    


</main>




<script src="/BboyZJ.github.io/js/utils.js"></script>

<script src="/BboyZJ.github.io/js/main.js"></script>

<script src="/BboyZJ.github.io/js/layouts/menu-shrink.js"></script>

<script src="/BboyZJ.github.io/js/tools/go-top-bottom.js"></script>

<script src="/BboyZJ.github.io/js/tools/dark-light-toggle.js"></script>



    
<script src="/BboyZJ.github.io/js/tools/local-search.js"></script>




    
<script src="/BboyZJ.github.io/js/tools/code-block.js"></script>




    
<script src="/BboyZJ.github.io/js/layouts/lazyload.js"></script>




    
<script src="/BboyZJ.github.io/js/tools/runtime.js"></script>

    
<script src="/BboyZJ.github.io/js/layouts/odometer.min.js"></script>

    
<link rel="stylesheet" href="/BboyZJ.github.io/assets/odometer-theme-minimal.css">





<div class="post-scripts pjax">
    
        
<script src="/BboyZJ.github.io/js/tools/toc-toggle.js"></script>

<script src="/BboyZJ.github.io/js/libs/anime.min.js"></script>

<script src="/BboyZJ.github.io/js/layouts/toc.js"></script>

<script src="/BboyZJ.github.io/js/plugins/tabs.js"></script>

    
    
</div>


    
<script src="/BboyZJ.github.io/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            REDEFINE.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            REDEFINE.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            REDEFINE.refresh();
        });
    });
</script>




<script src="/BboyZJ.github.io/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
