<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    <meta name="description" content="æˆ‘æ˜¯å°Jï¼Œå…³æ³¨æˆ‘">
    <meta name="author" content="å¼ å»º">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-redefine.png">
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://www.bboyzj.cn/2020/11/03/ocåº•å±‚åŸç†/ocåº•å±‚åŸç†17ï¼šç±»çš„åŠ è½½ï¼ˆä¸Šï¼‰/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    <meta property="og:type" content="article">
    <meta property="og:title" content="OCåº•å±‚åŸç†17ï¼šç±»çš„åŠ è½½ï¼ˆä¸Šï¼‰">
    <meta property="og:description" content="æˆ‘æ˜¯å°Jï¼Œå…³æ³¨æˆ‘">
    <meta property="og:url" content="https://www.bboyzj.cn2020/11/03/OCåº•å±‚åŸç†/OCåº•å±‚åŸç†17ï¼šç±»çš„åŠ è½½ï¼ˆä¸Šï¼‰/">
    <meta property="og:image" content="/images/redefine-logo.svg">
    <meta property="og:site_name" content="BboyZJ">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="OCåº•å±‚åŸç†17ï¼šç±»çš„åŠ è½½ï¼ˆä¸Šï¼‰">
    <meta name="twitter:description" content="æˆ‘æ˜¯å°Jï¼Œå…³æ³¨æˆ‘">
    <meta name="twitter:image" content="/images/redefine-logo.svg">
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/redefine-logo.svg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/redefine-logo.svg">
    <meta name="theme-color" content="#005080">
    <link rel="shortcut icon" href="/BboyZJ.github.io/images/redefine-logo.svg">
    
    <title>
        
            OCåº•å±‚åŸç†17ï¼šç±»çš„åŠ è½½ï¼ˆä¸Šï¼‰ -
        
        BboyZJ
    </title>
    
<link rel="stylesheet" href="/BboyZJ.github.io/css/style.css">

    
<link rel="stylesheet" href="/BboyZJ.github.io/assets/fonts.css">

    
    
    
    
    <script id="hexo-configurations">
    let REDEFINE = window.REDEFINE || {};
    REDEFINE.hexo_config = {"hostname":"www.bboyzj.cn","root":"/BboyZJ.github.io/","language":"en","path":"search.xml"};
    REDEFINE.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#005080","avatar":"/images/head_img.svg","favicon":"/images/redefine-logo.svg","article_img_align":"center","right_side_width":"210px","content_max_width":"1000px","nav_color":{"left":"#f78736","right":"#367df7","transparency":35},"hover":{"shadow":true,"scale":false},"first_screen":{"enable":true,"background_image":{"light":"https://evan.beee.top/img/wallhaven-wqery6-light.webp","dark":"https://evan.beee.top/img/wallhaven-wqery6-dark.webp"},"title_color":{"light":"#fff","dark":"#d1d1b6"},"description":"å­¦æ— æ­¢å¢ƒ å­¦è€Œä¸æ€åˆ™ç½” æ€è€Œä¸å­¦åˆ™æ®†","custom_font":{"enable":false,"font_family":null,"font_url":null}},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":true},"code_block":{"copy":true,"style":"mac","custom_font":{"enable":false,"font_family":null,"font_url":null}},"pjax":{"enable":true},"lazyload":{"enable":true},"version":"1.1.5","friend_links":{"columns":2},"home_article":{"date_format":"auto","category":{"enable":true,"limit":3},"tag":{"enable":true,"limit":3}},"plugins":{"aplayer":{"enable":false,"audio":[{"name":null,"artist":null,"url":null,"cover":null},{"name":null,"artist":null,"url":null,"cover":null}]}}};
    REDEFINE.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
    
    
<link rel="stylesheet" href="/BboyZJ.github.io/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/BboyZJ.github.io/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/BboyZJ.github.io/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/BboyZJ.github.io/fontawesome/regular.min.css">

    
    
    
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/BboyZJ.github.io/atom.xml" title="å¼ å»ºçš„åšå®¢" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="menu-wrapper">
    
    <div class="menu-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                BboyZJ
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="pc">
                <ul class="menu-list">
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/BboyZJ.github.io/"  >
                                    
                                        
                                            <i class="fa-regular fa-house"></i>
                                        
                                        é¦–é¡µ
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/BboyZJ.github.io/tags/"  >
                                    
                                        
                                            <i class="fa-regular fa-tags"></i>
                                        
                                        æ ‡ç­¾
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            <li class="menu-item">
                                <!-- Menu -->
                                <a class="" 
                                    href="/BboyZJ.github.io/categories/"  >
                                    
                                        
                                            <i class="fa-regular fa-categories"></i>
                                        
                                        åˆ†ç±»
                                    
                                </a>
                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile drawer -->
    <div class="menu-drawer">
        <ul class="drawer-menu-list">
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="" 
                        href="/BboyZJ.github.io/"  >
                             
                                
                                    <i class="fa-regular fa-house"></i>
                                
                                é¦–é¡µ
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="" 
                        href="/BboyZJ.github.io/tags/"  >
                             
                                
                                    <i class="fa-regular fa-tags"></i>
                                
                                æ ‡ç­¾
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            
                
                    <li class="drawer-menu-item flex-center">
                        <a class="" 
                        href="/BboyZJ.github.io/categories/"  >
                             
                                
                                    <i class="fa-regular fa-categories"></i>
                                
                                åˆ†ç±»
                            
                        </a>
                    </li>
                    <!-- Submenu -->
                    
            

        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            
            
                <div class="article-title">
                    <h1 class="article-title-regular">OCåº•å±‚åŸç†17ï¼šç±»çš„åŠ è½½ï¼ˆä¸Šï¼‰</h1>
                </div>
            
                
            

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="/BboyZJ.github.io/images/head_img.svg">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">å¼ å»º</span>
                            
                                <span class="author-label">lol</span>
                            
                        </div>
                        <div class="meta-info">
                            <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="pc">2020-11-03 15:21:34</span>
        <span class="mobile">2020-11-03 15:21</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="pc">2023-05-07 17:23:17</span>
            <span class="mobile">2023-05-07 17:23</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/BboyZJ.github.io/categories/OC/">OC</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/BboyZJ.github.io/tags/OC-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E6%8E%A2%E7%B4%A2%E7%AF%87/">OC-åº•å±‚åŸç†æ¢ç´¢ç¯‡</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content markdown-body">
                <h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>åœ¨ä¸Šä¸€ç¯‡ <a href="">OCåº•å±‚åŸç†16ï¼šdyldä¸objcçš„å…³è”</a> æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ç†è§£äº† <code>dyldä¸objc</code> æ˜¯å¦‚ä½•å…³è”çš„ï¼Œæœ¬æ–‡çš„ä¸»è¦ç›®çš„æ˜¯ç†è§£ <code>ç±»çš„ç›¸å…³ä¿¡æ¯</code> æ˜¯å¦‚ä½• <code>åŠ è½½</code> åˆ° <code>å†…å­˜</code> çš„ï¼Œå…¶ä¸­é‡ç‚¹å…³æ³¨ <code>map_images</code> å’Œ <code>load_images</code></p>
<ul>
<li><p><code>map_images</code>ï¼šä¸»è¦æ˜¯ç®¡ç† <code>æ–‡ä»¶ä¸­å’ŒåŠ¨æ€åº“ä¸­</code> çš„æ‰€æœ‰ç¬¦å·ï¼Œå³ <code>classã€protocolã€selectorã€category</code> ç­‰</p>
</li>
<li><p><code>load_images</code>ï¼šåŠ è½½æ‰§è¡Œ <code>loadæ–¹æ³•</code></p>
</li>
</ul>
<p>å…¶ä¸­ <code>ä»£ç </code> é€šè¿‡ <code>ç¼–è¯‘</code>ï¼Œè¯»å–åˆ° <code>Mach-Oå¯æ‰§è¡Œæ–‡ä»¶</code> ä¸­ï¼Œå†ä»Mach-Oä¸­è¯»å–åˆ° <code>å†…å­˜</code>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071335051.png"
                     
                ></p>
<h1 id="map-imagesï¼šåŠ è½½é•œåƒæ–‡ä»¶åˆ°å†…å­˜"><a href="#map-imagesï¼šåŠ è½½é•œåƒæ–‡ä»¶åˆ°å†…å­˜" class="headerlink" title="map_imagesï¼šåŠ è½½é•œåƒæ–‡ä»¶åˆ°å†…å­˜"></a>map_imagesï¼šåŠ è½½é•œåƒæ–‡ä»¶åˆ°å†…å­˜</h1><p>åœ¨æŸ¥çœ‹æºç ä¹‹å‰ï¼Œé¦–å…ˆéœ€è¦è¯´æ˜ä¸ºä»€ä¹ˆ <code>map_images</code> æœ‰ <code>&amp;</code>ï¼Œè€Œ <code>load_images</code> æ²¡æœ‰</p>
<ul>
<li><p><code>map_images</code> æ˜¯ <code>å¼•ç”¨ç±»å‹</code>ï¼Œå¤–ç•Œå˜äº†ï¼Œè·Ÿç€å˜ã€‚</p>
</li>
<li><p><code>load_images</code> æ˜¯ <code>å€¼ç±»å‹</code>ï¼Œä¸ä¼ é€’å€¼</p>
</li>
</ul>
<h1 id="map-imagesæºç æµç¨‹"><a href="#map-imagesæºç æµç¨‹" class="headerlink" title="map_imagesæºç æµç¨‹"></a>map_imagesæºç æµç¨‹</h1><p><code>map_images</code> æ–¹æ³•çš„ä¸»è¦ä½œç”¨æ˜¯å°† <code>Mach-O</code> ä¸­çš„ <code>ç±»ä¿¡æ¯</code> åŠ è½½åˆ° <code>å†…å­˜</code></p>
<ul>
<li>è¿›å…¥ <code>map_images</code> çš„æºç </li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">void</span><br><span class="line">map_images(unsigned count, const char * const paths[],</span><br><span class="line">           const struct mach_header * const mhdrs[])</span><br><span class="line">&#123;</span><br><span class="line">    mutex_locker_t lock(runtimeLock);</span><br><span class="line">    return map_images_nolock(count, paths, mhdrs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>è¿›å…¥ <code>map_images_nolock</code> æºç ï¼Œå…¶å…³é”®ä»£ç æ˜¯ <code>_read_images</code></li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">void</span><br><span class="line">map_images_nolock(unsigned mhCount, const char * const mhPaths[],</span><br><span class="line">                  const struct mach_header * const mhdrs[])</span><br><span class="line">&#123;</span><br><span class="line">    //...çœç•¥</span><br><span class="line"></span><br><span class="line">    // Find all images with Objective-C metadata.æŸ¥æ‰¾æ‰€æœ‰å¸¦æœ‰Objective-Cå…ƒæ•°æ®çš„æ˜ åƒ</span><br><span class="line">    hCount = 0;</span><br><span class="line"></span><br><span class="line">    // Count classes. Size various table based on the total.è®¡ç®—ç±»çš„ä¸ªæ•°</span><br><span class="line">    int totalClasses = 0;</span><br><span class="line">    int unoptimizedTotalClasses = 0;</span><br><span class="line">    // ä»£ç å—ï¼šä½œç”¨åŸŸï¼Œè¿›è¡Œå±€éƒ¨å¤„ç†ï¼Œå³å±€éƒ¨å¤„ç†ä¸€äº›äº‹ä»¶</span><br><span class="line">    &#123;</span><br><span class="line">        //...çœç•¥</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //...çœç•¥</span><br><span class="line"></span><br><span class="line">    if (hCount &gt; 0) &#123;</span><br><span class="line">        // åŠ è½½é•œåƒæ–‡ä»¶</span><br><span class="line">        _read_images(hList, hCount, totalClasses, unoptimizedTotalClasses);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    firstTime = NO;</span><br><span class="line">    </span><br><span class="line">    // Call image load funcs after everything is set up.ä¸€åˆ‡è®¾ç½®å®Œæˆåï¼Œè°ƒç”¨é•œåƒåŠ è½½åŠŸèƒ½ã€‚</span><br><span class="line">    for (auto func : loadImageFuncs) &#123;</span><br><span class="line">        for (uint32_t i = 0; i &lt; mhCount; i++) &#123;</span><br><span class="line">            func(mhdrs[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="read-images-æºç å®ç°"><a href="#read-images-æºç å®ç°" class="headerlink" title="_read_images æºç å®ç°"></a>_read_images æºç å®ç°</h1><p><code>_read_images</code> ä¸»è¦æ˜¯ä¸»è¦æ˜¯ <code>åŠ è½½ç±»ä¿¡æ¯</code>ï¼Œå³ <code>ç±»ã€åˆ†ç±»ã€åè®®ç­‰</code>ï¼Œè¿›å…¥ <code>_read_images</code> æºç å®ç°ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ éƒ¨åˆ†ï¼š</p>
<ul>
<li>1ã€æ¡ä»¶æ§åˆ¶è¿›è¡Œçš„ä¸€æ¬¡åŠ è½½</li>
<li>2ã€ä¿®å¤é¢„ç¼–è¯‘é˜¶æ®µçš„@selectorçš„æ··ä¹±é—®é¢˜</li>
<li>3ã€é”™è¯¯æ··ä¹±çš„ç±»å¤„ç†</li>
<li>4ã€ä¿®å¤é‡æ˜ å°„ä¸€äº›æ²¡æœ‰è¢«é•œåƒæ–‡ä»¶åŠ è½½è¿›æ¥çš„ç±»</li>
<li>5ã€ä¿®å¤ä¸€äº›æ¶ˆæ¯</li>
<li>6ã€å½“ç±»é‡Œé¢æœ‰åè®®æ—¶ï¼šreadProtocol è¯»å–åè®®</li>
<li>7ã€ä¿®å¤æ²¡æœ‰è¢«åŠ è½½çš„åè®®</li>
<li>8ã€åˆ†ç±»å¤„ç†</li>
<li>9ã€ç±»çš„åŠ è½½å¤„ç†</li>
<li>10ã€æ²¡æœ‰è¢«å¤„ç†çš„ç±»ï¼Œä¼˜åŒ–é‚£äº›è¢«ä¾µçŠ¯çš„ç±»</li>
</ul>
<p>1ã€æ¡ä»¶æ§åˆ¶è¿›è¡Œçš„ä¸€æ¬¡åŠ è½½</p>
<p>åœ¨ <code>doneOnce</code> æµç¨‹ä¸­é€šè¿‡ <code>NXCreateMapTable</code> åˆ›å»ºè¡¨ï¼Œå­˜æ”¾ç±»ä¿¡æ¯ï¼Œå³åˆ›å»ºä¸€å¼ ç±»çš„ <code>å“ˆå¸Œè¡¨gdb_objc_realized_classes</code>ï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†ç±»æŸ¥æ‰¾æ–¹ä¾¿ã€å¿«æ·</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">if (!doneOnce) &#123;</span><br><span class="line">     </span><br><span class="line">    //...çœç•¥</span><br><span class="line">    </span><br><span class="line">    // namedClasses</span><br><span class="line">    // Preoptimized classes don&#x27;t go in this table.</span><br><span class="line">    // 4/3 is NXMapTable&#x27;s load factor</span><br><span class="line">    int namedClassesSize = </span><br><span class="line">        (isPreoptimized() ? unoptimizedTotalClasses : totalClasses) * 4 / 3;</span><br><span class="line">//åˆ›å»ºè¡¨ï¼ˆå“ˆå¸Œè¡¨key-valueï¼‰ï¼Œç›®çš„æ˜¯æŸ¥æ‰¾å¿«</span><br><span class="line">    gdb_objc_realized_classes =</span><br><span class="line">        NXCreateMapTable(NXStrValueMapPrototype, namedClassesSize);</span><br><span class="line"></span><br><span class="line">    ts.log(&quot;IMAGE TIMES: first time tasks&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æŸ¥çœ‹ <code>gdb_objc_realized_classes</code> çš„æ³¨é‡Šè¯´æ˜ï¼Œè¿™ä¸ª <code>å“ˆå¸Œè¡¨</code> ç”¨äº <code>å­˜å‚¨ä¸åœ¨å…±äº«ç¼“å­˜ä¸”å·²å‘½åç±»</code>ï¼Œæ— è®ºç±»æ˜¯å¦å®ç°ï¼Œå…¶å®¹é‡æ˜¯ç±»æ•°é‡çš„ <code>4/3</code></p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// This is a misnomer: gdb_objc_realized_classes is actually a list of </span><br><span class="line">// named classes not in the dyld shared cache, whether realized or not.</span><br><span class="line">//gdb_objc_realized_classeså®é™…ä¸Šæ˜¯ä¸åœ¨dyldå…±äº«ç¼“å­˜ä¸­çš„å·²å‘½åç±»çš„åˆ—è¡¨ï¼Œæ— è®ºæ˜¯å¦å®ç°</span><br><span class="line">NXMapTable *gdb_objc_realized_classes;  // exported for debuggers in objc-gdb.h</span><br></pre></td></tr></table></figure></div>

<p>2ã€ä¿®å¤é¢„ç¼–è¯‘é˜¶æ®µçš„@selectorçš„æ··ä¹±é—®é¢˜</p>
<p>ä¸»è¦æ˜¯é€šè¿‡é€šè¿‡ <code>_getObjc2SelectorRefs </code>æ‹¿åˆ°Mach_Oä¸­çš„é™æ€æ®µ <code>__objc_selrefs</code>ï¼Œéå†åˆ—è¡¨è°ƒç”¨ <code>sel_registerNameNoLock</code> å°† <code>SEL</code> æ·»åŠ åˆ° <code>namedSelectors</code> å“ˆå¸Œè¡¨ä¸­</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// Fix up @selector references ä¿®å¤@selectorå¼•ç”¨</span><br><span class="line">// sel ä¸æ˜¯ç®€å•çš„å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯å¸¦åœ°å€çš„å­—ç¬¦ä¸²</span><br><span class="line">static size_t UnfixedSelectors;</span><br><span class="line">&#123;</span><br><span class="line">    mutex_locker_t lock(selLock);</span><br><span class="line">    for (EACH_HEADER) &#123;</span><br><span class="line">        if (hi-&gt;hasPreoptimizedSelectors()) continue;</span><br><span class="line"></span><br><span class="line">        bool isBundle = hi-&gt;isBundle();</span><br><span class="line">        // é€šè¿‡_getObjc2SelectorRefsæ‹¿åˆ°Mach-Oä¸­çš„é™æ€æ®µ__objc_selrefs</span><br><span class="line">        SEL *sels = _getObjc2SelectorRefs(hi, &amp;count);</span><br><span class="line">        UnfixedSelectors += count;</span><br><span class="line">        for (i = 0; i &lt; count; i++) &#123; //åˆ—è¡¨éå†</span><br><span class="line">            const char *name = sel_cname(sels[i]);</span><br><span class="line">            // æ³¨å†Œselæ“ä½œï¼Œå³å°†selæ·»åŠ åˆ°</span><br><span class="line">            SEL sel = sel_registerNameNoLock(name, isBundle);</span><br><span class="line">            if (sels[i] != sel) &#123; // å½“selä¸sels[i]åœ°å€ä¸ä¸€è‡´æ—¶ï¼Œéœ€è¦è°ƒæ•´ä¸ºä¸€è‡´çš„</span><br><span class="line">                sels[i] = sel;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>å…¶ä¸­ <code>_getObjc2SelectorRefs</code> çš„æºç å¦‚ä¸‹ï¼Œè¡¨ç¤ºè·å– <code>Mach-O</code> ä¸­çš„é™æ€æ®µ <code>__objc_selrefs</code>ï¼Œåç»­é€šè¿‡ <code>_getObjc2</code> å¼€å¤´çš„Mach-Oé™æ€æ®µè·å–ï¼Œéƒ½å¯¹åº”ä¸åŒçš„ <code>section name</code></li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//      function name                 content type     section name</span><br><span class="line">GETSECT(_getObjc2SelectorRefs,        SEL,             &quot;__objc_selrefs&quot;); </span><br><span class="line">GETSECT(_getObjc2MessageRefs,         message_ref_t,   &quot;__objc_msgrefs&quot;); </span><br><span class="line">GETSECT(_getObjc2ClassRefs,           Class,           &quot;__objc_classrefs&quot;);</span><br><span class="line">GETSECT(_getObjc2SuperRefs,           Class,           &quot;__objc_superrefs&quot;);</span><br><span class="line">GETSECT(_getObjc2ClassList,           classref_t const,      &quot;__objc_classlist&quot;);</span><br><span class="line">GETSECT(_getObjc2NonlazyClassList,    classref_t const,      &quot;__objc_nlclslist&quot;);</span><br><span class="line">GETSECT(_getObjc2CategoryList,        category_t * const,    &quot;__objc_catlist&quot;);</span><br><span class="line">GETSECT(_getObjc2CategoryList2,       category_t * const,    &quot;__objc_catlist2&quot;);</span><br><span class="line">GETSECT(_getObjc2NonlazyCategoryList, category_t * const,    &quot;__objc_nlcatlist&quot;);</span><br><span class="line">GETSECT(_getObjc2ProtocolList,        protocol_t * const,    &quot;__objc_protolist&quot;);</span><br><span class="line">GETSECT(_getObjc2ProtocolRefs,        protocol_t *,    &quot;__objc_protorefs&quot;);</span><br><span class="line">GETSECT(getLibobjcInitializers,       UnsignedInitializer, &quot;__objc_init_func&quot;);</span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>sel_registerNameNoLock</code> æºç è·¯å¾„å¦‚ä¸‹ï¼š<code>sel_registerNameNoLock -&gt; __sel_registerName</code>,å¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶å…³é”®ä»£ç æ˜¯ <code>auto it = namedSelectors.get().insert(name);</code>ï¼Œå³å°†selæ’å…¥ <code>namedSelectors</code> å“ˆå¸Œè¡¨</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">SEL sel_registerNameNoLock(const char *name, bool copy) &#123;</span><br><span class="line">    return __sel_registerName(name, 0, copy);  // NO lock, maybe copy</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ğŸ‘‡</span><br><span class="line">static SEL __sel_registerName(const char *name, bool shouldLock, bool copy) </span><br><span class="line">&#123;</span><br><span class="line">    SEL result = 0;</span><br><span class="line"></span><br><span class="line">    if (shouldLock) selLock.assertUnlocked();</span><br><span class="line">    else selLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    if (!name) return (SEL)0;</span><br><span class="line"></span><br><span class="line">    result = search_builtins(name);</span><br><span class="line">    if (result) return result;</span><br><span class="line">    </span><br><span class="line">    conditional_mutex_locker_t lock(selLock, shouldLock);</span><br><span class="line">    auto it = namedSelectors.get().insert(name);//selæ’å…¥è¡¨</span><br><span class="line">    if (it.second) &#123;</span><br><span class="line">        // No match. Insert.</span><br><span class="line">        *it.first = (const char *)sel_alloc(name, copy);</span><br><span class="line">    &#125;</span><br><span class="line">    return (SEL)*it.first;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>å…¶ä¸­ <code>selector --&gt; sel</code> å¹¶ä¸æ˜¯ç®€å•çš„å­—ç¬¦ä¸²ï¼Œæ˜¯å¸¦åœ°å€çš„å­—ç¬¦ä¸²</li>
</ul>
<p>å¦‚ä¸‹æ‰€ç¤ºï¼Œ<code>sels[i]ä¸sel</code> å­—ç¬¦ä¸²ä¸€è‡´ï¼Œä½†æ˜¯åœ°å€ä¸ä¸€è‡´ï¼Œæ‰€ä»¥éœ€è¦è°ƒæ•´ä¸ºä¸€è‡´çš„ã€‚å³fix upï¼Œå¯ä»¥é€šè¿‡æ‰“å°è°ƒè¯•æ˜¾ç¤ºå¦‚ä¸‹</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071345374.png"
                     
                ></p>
<p>3ã€é”™è¯¯æ··ä¹±çš„ç±»å¤„ç†</p>
<p>ä¸»è¦æ˜¯ä»Mach-Oä¸­å–å‡ºæ‰€æœ‰ç±»ï¼Œåœ¨éå†è¿›è¡Œå¤„ç†</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">// 3ã€é”™è¯¯æ··ä¹±çš„ç±»å¤„ç†</span><br><span class="line">// Discover classes. Fix up unresolved future classes. Mark bundle classes.</span><br><span class="line">bool hasDyldRoots = dyld_shared_cache_some_image_overridden();</span><br><span class="line">// è¯»å–ç±»ï¼šreadClass</span><br><span class="line">for (EACH_HEADER) &#123;</span><br><span class="line">    if (! mustReadClasses(hi, hasDyldRoots)) &#123;</span><br><span class="line">        // Image is sufficiently optimized that we need not call readClass()</span><br><span class="line">        continue;</span><br><span class="line">    &#125;</span><br><span class="line">    // ä»ç¼–è¯‘åçš„ç±»åˆ—è¡¨ä¸­å–å‡ºæ‰€æœ‰ç±»ï¼Œå³ä»Mach-Oä¸­è·å–é™æ€æ®µ__objc_classlistï¼Œæ˜¯ä¸€ä¸ªclassref_tç±»å‹çš„æŒ‡é’ˆ</span><br><span class="line">    classref_t const *classlist = _getObjc2ClassList(hi, &amp;count);</span><br><span class="line"></span><br><span class="line">    bool headerIsBundle = hi-&gt;isBundle();</span><br><span class="line">    bool headerIsPreoptimized = hi-&gt;hasPreoptimizedClasses();</span><br><span class="line"></span><br><span class="line">    for (i = 0; i &lt; count; i++) &#123;</span><br><span class="line">        Class cls = (Class)classlist[i];//æ­¤æ—¶è·å–çš„clsåªæ˜¯ä¸€ä¸ªåœ°å€</span><br><span class="line">        Class newCls = readClass(cls, headerIsBundle, headerIsPreoptimized); //è¯»å–ç±»ï¼Œç»è¿‡è¿™æ­¥åï¼Œclsè·å–çš„å€¼æ‰æ˜¯ä¸€ä¸ªåå­—</span><br><span class="line">        // ç»è¿‡è°ƒè¯•ï¼Œå¹¶æœªæ‰§è¡Œifé‡Œé¢çš„æµç¨‹</span><br><span class="line">        // åˆå§‹åŒ–æ‰€æœ‰æ‡’åŠ è½½çš„ç±»éœ€è¦çš„å†…å­˜ç©ºé—´ï¼Œä½†æ˜¯æ‡’åŠ è½½ç±»çš„æ•°æ®ç°åœ¨æ˜¯æ²¡æœ‰åŠ è½½åˆ°çš„ï¼Œè¿ç±»éƒ½æ²¡æœ‰åˆå§‹åŒ–</span><br><span class="line">        if (newCls != cls  &amp;&amp;  newCls) &#123;</span><br><span class="line">            // Class was moved but not deleted. Currently this occurs </span><br><span class="line">            // only when the new class resolved a future class.</span><br><span class="line">            // Non-lazily realize the class below.</span><br><span class="line">            // å°†æ‡’åŠ è½½çš„ç±»æ·»åŠ åˆ°æ•°ç»„ä¸­</span><br><span class="line">            resolvedFutureClasses = (Class *)</span><br><span class="line">                realloc(resolvedFutureClasses, </span><br><span class="line">                        (resolvedFutureClassCount+1) * sizeof(Class));</span><br><span class="line">            resolvedFutureClasses[resolvedFutureClassCount++] = newCls;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">ts.log(&quot;IMAGE TIMES: discover classes&quot;);</span><br></pre></td></tr></table></figure></div>

<ul>
<li>é€šè¿‡ä»£ç è°ƒè¯•ï¼ŒçŸ¥é“äº†åœ¨æœªæ‰§è¡ŒreadClassæ–¹æ³•å‰ï¼Œclsåªæ˜¯ä¸€ä¸ªåœ°å€</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071346326.png"
                     
                ></p>
<ul>
<li>åœ¨æ‰§è¡Œåï¼Œclsæ˜¯ä¸€ä¸ªç±»çš„åç§°</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071347487.png"
                     
                ></p>
<p>æ‰€ä»¥åˆ°è¿™æ­¥ä¸ºæ­¢ï¼Œç±»çš„ä¿¡æ¯ç›®å‰ä»…å­˜å‚¨äº† <code>åœ°å€+åç§°</code></p>
<p>4ã€ä¿®å¤é‡æ˜ å°„ä¸€äº›æ²¡æœ‰è¢«é•œåƒæ–‡ä»¶åŠ è½½è¿›æ¥çš„ç±»</p>
<p>ä¸»è¦æ˜¯å°†æœªæ˜ å°„çš„ <code>Class</code> å’Œ <code>Super Class</code> è¿›è¡Œé‡æ˜ å°„ï¼Œå…¶ä¸­</p>
<ul>
<li><p><code>_getObjc2ClassRefs</code>  æ˜¯è·å– <code>Mach-O</code> ä¸­çš„é™æ€æ®µ <code>__objc_classrefs</code> å³ç±»çš„å¼•ç”¨</p>
</li>
<li><p><code>_getObjc2SuperRefs</code> æ˜¯è·å– <code>Mach-O</code> ä¸­çš„é™æ€æ®µ <code>__objc_superrefs</code> å³çˆ¶ç±»çš„å¼•ç”¨</p>
</li>
<li><p>é€šè¿‡æ³¨é‡Šå¯ä»¥å¾—çŸ¥ï¼Œè¢« <code>remapClassRef</code> çš„ç±»éƒ½æ˜¯æ‡’åŠ è½½çš„ç±»ï¼Œæ‰€ä»¥æœ€åˆç»è¿‡è°ƒè¯•æ—¶ï¼Œè¿™éƒ¨åˆ†ä»£ç æ˜¯æ²¡æœ‰æ‰§è¡Œçš„</p>
</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">//4ã€ä¿®å¤é‡æ˜ å°„ä¸€äº›æ²¡æœ‰è¢«é•œåƒæ–‡ä»¶åŠ è½½è¿›æ¥çš„ç±»</span><br><span class="line">// Fix up remapped classes ä¿®æ­£é‡æ–°æ˜ å°„çš„ç±»</span><br><span class="line">// Class list and nonlazy class list remain unremapped.ç±»åˆ—è¡¨å’Œéæƒ°æ€§ç±»åˆ—è¡¨ä¿æŒæœªæ˜ å°„</span><br><span class="line">// Class refs and super refs are remapped for message dispatching.ç±»å¼•ç”¨å’Œè¶…çº§å¼•ç”¨å°†é‡æ–°æ˜ å°„ä»¥è¿›è¡Œæ¶ˆæ¯åˆ†å‘</span><br><span class="line">//ç»è¿‡è°ƒè¯•ï¼Œå¹¶æœªæ‰§è¡Œifé‡Œé¢çš„æµç¨‹</span><br><span class="line">//å°†æœªæ˜ å°„çš„Class å’Œ Super Classé‡æ˜ å°„ï¼Œè¢«remapçš„ç±»éƒ½æ˜¯æ‡’åŠ è½½çš„ç±»</span><br><span class="line">if (!noClassesRemapped()) &#123;</span><br><span class="line">    for (EACH_HEADER) &#123;</span><br><span class="line">        Class *classrefs = _getObjc2ClassRefs(hi, &amp;count);//Mach-Oçš„é™æ€æ®µ __objc_classrefs</span><br><span class="line">        for (i = 0; i &lt; count; i++) &#123;</span><br><span class="line">            remapClassRef(&amp;classrefs[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        // fixme why doesn&#x27;t test future1 catch the absence of this?</span><br><span class="line">        classrefs = _getObjc2SuperRefs(hi, &amp;count);//Mach_Oä¸­çš„é™æ€æ®µ __objc_superrefs</span><br><span class="line">        for (i = 0; i &lt; count; i++) &#123;</span><br><span class="line">            remapClassRef(&amp;classrefs[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ts.log(&quot;IMAGE TIMES: remap classes&quot;);</span><br></pre></td></tr></table></figure></div>

<p>5ã€ä¿®å¤ä¸€äº›æ¶ˆæ¯</p>
<p>ä¸»è¦æ˜¯é€šè¿‡ <code>_getObjc2MessageRefs</code> è·å– <code>Mach-O</code> çš„é™æ€æ®µ <code>__objc_msgrefs</code>ï¼Œå¹¶éå†é€šè¿‡ <code>fixupMessageRef</code> å°†å‡½æ•°æŒ‡é’ˆè¿›è¡Œæ³¨å†Œï¼Œå¹¶fixä¸ºæ–°çš„å‡½æ•°æŒ‡é’ˆ</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#if SUPPORT_FIXUP</span><br><span class="line">//5ã€ä¿®å¤ä¸€äº›æ¶ˆæ¯</span><br><span class="line">    // Fix up old objc_msgSend_fixup call sites</span><br><span class="line">    for (EACH_HEADER) &#123;</span><br><span class="line">        // _getObjc2MessageRefs è·å–Mach-Oçš„é™æ€æ®µ __objc_msgrefs</span><br><span class="line">        message_ref_t *refs = _getObjc2MessageRefs(hi, &amp;count);</span><br><span class="line">        if (count == 0) continue;</span><br><span class="line"></span><br><span class="line">        if (PrintVtables) &#123;</span><br><span class="line">            _objc_inform(&quot;VTABLES: repairing %zu unsupported vtable dispatch &quot;</span><br><span class="line">                         &quot;call sites in %s&quot;, count, hi-&gt;fname());</span><br><span class="line">        &#125;</span><br><span class="line">        //ç»è¿‡è°ƒè¯•ï¼Œå¹¶æœªæ‰§è¡Œforé‡Œé¢çš„æµç¨‹</span><br><span class="line">        //éå†å°†å‡½æ•°æŒ‡é’ˆè¿›è¡Œæ³¨å†Œï¼Œå¹¶fixä¸ºæ–°çš„å‡½æ•°æŒ‡é’ˆ</span><br><span class="line">        for (i = 0; i &lt; count; i++) &#123;</span><br><span class="line">            fixupMessageRef(refs+i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ts.log(&quot;IMAGE TIMES: fix up objc_msgSend_fixup&quot;);</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure></div>

<p>6ã€å½“ç±»é‡Œé¢æœ‰åè®®æ—¶ï¼šreadProtocol è¯»å–åè®®</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">// 6ã€å½“ç±»é‡Œé¢æœ‰åè®®æ—¶ï¼šreadProtocol è¯»å–åè®®</span><br><span class="line">// Discover protocols. Fix up protocol refs. å‘ç°åè®®ã€‚ä¿®æ­£åè®®å‚è€ƒ</span><br><span class="line">// éå†æ‰€æœ‰åè®®åˆ—è¡¨ï¼Œå¹¶ä¸”å°†åè®®åˆ—è¡¨åŠ è½½åˆ°Protocolçš„å“ˆå¸Œè¡¨ä¸­</span><br><span class="line">for (EACH_HEADER) &#123;</span><br><span class="line">    extern objc_class OBJC_CLASS_$_Protocol;</span><br><span class="line">    //cls = Protocolç±»ï¼Œæ‰€æœ‰åè®®å’Œå¯¹è±¡çš„ç»“æ„ä½“éƒ½ç±»ä¼¼ï¼Œisaéƒ½å¯¹åº”Protocolç±»</span><br><span class="line">    Class cls = (Class)&amp;OBJC_CLASS_$_Protocol;</span><br><span class="line">    ASSERT(cls);</span><br><span class="line">    //è·å–protocolå“ˆå¸Œè¡¨ -- protocol_map</span><br><span class="line">    NXMapTable *protocol_map = protocols();</span><br><span class="line">    bool isPreoptimized = hi-&gt;hasPreoptimizedProtocols();</span><br><span class="line"></span><br><span class="line">    // Skip reading protocols if this is an image from the shared cache</span><br><span class="line">    // and we support roots</span><br><span class="line">    // Note, after launch we do need to walk the protocol as the protocol</span><br><span class="line">    // in the shared cache is marked with isCanonical() and that may not</span><br><span class="line">    // be true if some non-shared cache binary was chosen as the canonical</span><br><span class="line">    // definition</span><br><span class="line">    if (launchTime &amp;&amp; isPreoptimized &amp;&amp; cacheSupportsProtocolRoots) &#123;</span><br><span class="line">        if (PrintProtocols) &#123;</span><br><span class="line">            _objc_inform(&quot;PROTOCOLS: Skipping reading protocols in image: %s&quot;,</span><br><span class="line">                         hi-&gt;fname());</span><br><span class="line">        &#125;</span><br><span class="line">        continue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bool isBundle = hi-&gt;isBundle();</span><br><span class="line">    //é€šè¿‡_getObjc2ProtocolList è·å–åˆ°Mach-Oä¸­çš„é™æ€æ®µ__objc_protoliståè®®åˆ—è¡¨ï¼Œ</span><br><span class="line">    //å³ä»ç¼–è¯‘å™¨ä¸­è¯»å–å¹¶åˆå§‹åŒ–protocol</span><br><span class="line">    protocol_t * const *protolist = _getObjc2ProtocolList(hi, &amp;count);</span><br><span class="line">    for (i = 0; i &lt; count; i++) &#123;</span><br><span class="line">        //é€šè¿‡æ·»åŠ protocolåˆ°protocol_mapå“ˆå¸Œè¡¨ä¸­</span><br><span class="line">        readProtocol(protolist[i], cls, protocol_map, </span><br><span class="line">                     isPreoptimized, isBundle);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ts.log(&quot;IMAGE TIMES: discover protocols&quot;);</span><br></pre></td></tr></table></figure></div>

<ul>
<li>é€šè¿‡ <code>NXMapTable *protocol_map = protocols();</code> åˆ›å»ºprotocolå“ˆå¸Œè¡¨ï¼Œè¡¨çš„åç§°ä¸ºprotocol_map</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/***********************************************************************</span><br><span class="line">* protocols</span><br><span class="line">* Returns the protocol name =&gt; protocol map for protocols.</span><br><span class="line">* Locking: runtimeLock must read- or write-locked by the caller</span><br><span class="line">**********************************************************************/</span><br><span class="line">static NXMapTable *protocols(void)</span><br><span class="line">&#123;</span><br><span class="line">    static NXMapTable *protocol_map = nil;</span><br><span class="line">    </span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    INIT_ONCE_PTR(protocol_map, </span><br><span class="line">                  NXCreateMapTable(NXStrValueMapPrototype, 16), </span><br><span class="line">                  NXFreeMapTable(v) );</span><br><span class="line"></span><br><span class="line">    return protocol_map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>é€šè¿‡ <code>_getObjc2ProtocolList</code> è·å–åˆ° <code>Mach-O</code> ä¸­çš„é™æ€æ®µ <code>__objc_protolist</code> åè®®åˆ—è¡¨ï¼Œå³ä»ç¼–è¯‘å™¨ä¸­è¯»å–å¹¶åˆå§‹åŒ– <code>protocol</code></li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protocol_t * const *protolist = _getObjc2ProtocolList(hi, &amp;count);</span><br></pre></td></tr></table></figure></div>

<ul>
<li>å¾ªç¯éå†åè®®åˆ—è¡¨ï¼Œé€šè¿‡ <code>readProtocol</code> æ–¹æ³•å°†åè®®æ·»åŠ åˆ° <code>protocol_map</code> å“ˆå¸Œè¡¨ä¸­</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">readProtocol(protolist[i], cls, protocol_map, </span><br><span class="line">                         isPreoptimized, isBundle);</span><br></pre></td></tr></table></figure></div>

<p>7ã€ä¿®å¤æ²¡æœ‰è¢«åŠ è½½çš„åè®®</p>
<p>ä¸»è¦æ˜¯é€šè¿‡ <code>_getObjc2ProtocolRefs</code> è·å–åˆ°Mach-Oçš„é™æ€æ®µ <code>__objc_protorefs</code>ï¼ˆä¸6ä¸­çš„__objc_protolistå¹¶ä¸æ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼‰ï¼Œç„¶åéå†éœ€è¦ä¿®å¤çš„åè®®ï¼Œé€šè¿‡ <code>remapProtocolRef</code> æ¯”è¾ƒå½“å‰åè®®å’Œåè®®åˆ—è¡¨ä¸­çš„åŒä¸€ä¸ªå†…å­˜åœ°å€çš„åè®®æ˜¯å¦ç›¸åŒï¼Œå¦‚æœä¸åŒåˆ™æ›¿æ¢</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">//7ã€ä¿®å¤æ²¡æœ‰è¢«åŠ è½½çš„åè®®</span><br><span class="line">// Fix up @protocol references</span><br><span class="line">// Preoptimized images may have the right </span><br><span class="line">// answer already but we don&#x27;t know for sure.</span><br><span class="line">for (EACH_HEADER) &#123;</span><br><span class="line">    // At launch time, we know preoptimized image refs are pointing at the</span><br><span class="line">    // shared cache definition of a protocol.  We can skip the check on</span><br><span class="line">    // launch, but have to visit @protocol refs for shared cache images</span><br><span class="line">    // loaded later.</span><br><span class="line">    if (launchTime &amp;&amp; cacheSupportsProtocolRoots &amp;&amp; hi-&gt;isPreoptimized())</span><br><span class="line">        continue;</span><br><span class="line">    //_getObjc2ProtocolRefs è·å–åˆ°Mach-Oçš„é™æ€æ®µ __objc_protorefs</span><br><span class="line">    protocol_t **protolist = _getObjc2ProtocolRefs(hi, &amp;count);</span><br><span class="line">    for (i = 0; i &lt; count; i++) &#123;//éå†</span><br><span class="line">        //æ¯”è¾ƒå½“å‰åè®®å’Œåè®®åˆ—è¡¨ä¸­çš„åŒä¸€ä¸ªå†…å­˜åœ°å€çš„åè®®æ˜¯å¦ç›¸åŒï¼Œå¦‚æœä¸åŒåˆ™æ›¿æ¢</span><br><span class="line">        remapProtocolRef(&amp;protolist[i]);//ç»è¿‡ä»£ç è°ƒè¯•ï¼Œå¹¶æœªæ‰§è¡Œ</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ts.log(&quot;IMAGE TIMES: fix up @protocol references&quot;);</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ <code>remapProtocolRef</code> çš„æºç å®ç°å¦‚ä¸‹</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/***********************************************************************</span><br><span class="line">* remapProtocolRef</span><br><span class="line">* Fix up a protocol ref, in case the protocol referenced has been reallocated.</span><br><span class="line">* Locking: runtimeLock must be read- or write-locked by the caller</span><br><span class="line">**********************************************************************/</span><br><span class="line">static size_t UnfixedProtocolReferences;</span><br><span class="line">static void remapProtocolRef(protocol_t **protoref)</span><br><span class="line">&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line">    //è·å–åè®®åˆ—è¡¨ä¸­ç»Ÿä¸€å†…å­˜åœ°å€çš„åè®®</span><br><span class="line">    protocol_t *newproto = remapProtocol((protocol_ref_t)*protoref);</span><br><span class="line">    if (*protoref != newproto) &#123;//å¦‚æœå½“å‰åè®® ä¸ åŒä¸€å†…å­˜åœ°å€åè®®ä¸åŒï¼Œåˆ™æ›¿æ¢</span><br><span class="line">        *protoref = newproto;</span><br><span class="line">        UnfixedProtocolReferences++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>8ã€åˆ†ç±»å¤„ç†</p>
<p>ä¸»è¦æ˜¯ <code>å¤„ç†åˆ†ç±»</code>ï¼Œéœ€è¦åœ¨åˆ†ç±»åˆå§‹åŒ–å¹¶å°†æ•°æ®åŠ è½½åˆ°ç±»åæ‰æ‰§è¡Œï¼Œå¯¹äºè¿è¡Œæ—¶å‡ºç°çš„åˆ†ç±»ï¼Œå°†åˆ†ç±»çš„å‘ç°æ¨è¿Ÿæ¨è¿Ÿåˆ°å¯¹ <code>_dyld_objc_notify_register</code> çš„è°ƒç”¨å®Œæˆåçš„ç¬¬ä¸€ä¸ª <code>load_images</code> è°ƒç”¨ä¸ºæ­¢</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 8ã€åˆ†ç±»å¤„ç†</span><br><span class="line">// Discover categories. Only do this after the initial category å‘ç°åˆ†ç±»</span><br><span class="line">// attachment has been done. For categories present at startup,</span><br><span class="line">// discovery is deferred until the first load_images call after</span><br><span class="line">// the call to _dyld_objc_notify_register completes. rdar://problem/53119145</span><br><span class="line">if (didInitialAttachCategories) &#123;</span><br><span class="line">    for (EACH_HEADER) &#123;</span><br><span class="line">        load_categories_nolock(hi);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ts.log(&quot;IMAGE TIMES: discover categories&quot;);</span><br></pre></td></tr></table></figure></div>

<p>9ã€ç±»çš„åŠ è½½å¤„ç†</p>
<p>ä¸»è¦æ˜¯å®ç° <code>ç±»çš„åŠ è½½å¤„ç†</code>ï¼Œå®ç°éæ‡’åŠ è½½ç±»</p>
<ul>
<li><p>é€šè¿‡ <code>_getObjc2NonlazyClassList</code> è·å–Mach-Oçš„é™æ€æ®µ <code>__objc_nlclslist</code> éæ‡’åŠ è½½ç±»è¡¨</p>
</li>
<li><p>é€šè¿‡ <code>addClassTableEntry</code> å°†éæ‡’åŠ è½½ç±»æ’å…¥ç±»è¡¨ï¼Œå­˜å‚¨åˆ°å†…å­˜ï¼Œå¦‚æœå·²ç»æ·»åŠ å°±ä¸ä¼šè½½æ·»åŠ ï¼Œéœ€è¦ç¡®ä¿æ•´ä¸ªç»“æ„éƒ½è¢«æ·»åŠ </p>
</li>
<li><p>é€šè¿‡ <code>realizeClassWithoutSwift</code> å®ç°å½“å‰çš„ç±»ï¼Œå› ä¸ºå‰é¢3ä¸­çš„ <code>readClass</code> è¯»å–åˆ°å†…å­˜çš„ä»…ä»…åªæœ‰ <code>åœ°å€+åç§°</code>ï¼Œç±»çš„dataæ•°æ®å¹¶æ²¡æœ‰åŠ è½½å‡ºæ¥</p>
</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">// Realize non-lazy classes (for +load methods and static instances) åˆå§‹åŒ–éæ‡’åŠ è½½ç±»ï¼Œè¿›è¡Œrwã€roç­‰æ“ä½œï¼šrealizeClassWithoutSwift</span><br><span class="line">    //æ‡’åŠ è½½ç±» -- åˆ«äººä¸åŠ¨æˆ‘ï¼Œæˆ‘å°±ä¸åŠ¨</span><br><span class="line">    //å®ç°éæ‡’åŠ è½½çš„ç±»ï¼Œå¯¹äºloadæ–¹æ³•å’Œé™æ€å®ä¾‹å˜é‡</span><br><span class="line">    for (EACH_HEADER) &#123;</span><br><span class="line">        //é€šè¿‡_getObjc2NonlazyClassListè·å–Mach-Oçš„é™æ€æ®µ__objc_nlclslistéæ‡’åŠ è½½ç±»è¡¨</span><br><span class="line">        classref_t const *classlist = </span><br><span class="line">            _getObjc2NonlazyClassList(hi, &amp;count);</span><br><span class="line">        for (i = 0; i &lt; count; i++) &#123;</span><br><span class="line">            Class cls = remapClass(classlist[i]);</span><br><span class="line">            </span><br><span class="line">            const char *mangledName  = cls-&gt;mangledName();</span><br><span class="line">             const char *LGPersonName = &quot;LGPerson&quot;;</span><br><span class="line">            </span><br><span class="line">             if (strcmp(mangledName, LGPersonName) == 0) &#123;</span><br><span class="line">                 auto kc_ro = (const class_ro_t *)cls-&gt;data();</span><br><span class="line">                 printf(&quot;_getObjc2NonlazyClassList: è¿™ä¸ªæ˜¯æˆ‘è¦ç ”ç©¶çš„ %s \n&quot;,LGPersonName);</span><br><span class="line">             &#125;</span><br><span class="line">            </span><br><span class="line">            if (!cls) continue;</span><br><span class="line"></span><br><span class="line">            addClassTableEntry(cls);//æ’å…¥è¡¨ï¼Œä½†æ˜¯å‰é¢å·²ç»æ’å…¥è¿‡äº†ï¼Œæ‰€ä»¥ä¸ä¼šé‡æ–°æ’å…¥</span><br><span class="line"></span><br><span class="line">            if (cls-&gt;isSwiftStable()) &#123;</span><br><span class="line">                if (cls-&gt;swiftMetadataInitializer()) &#123;</span><br><span class="line">                    _objc_fatal(&quot;Swift class %s with a metadata initializer &quot;</span><br><span class="line">                                &quot;is not allowed to be non-lazy&quot;,</span><br><span class="line">                                cls-&gt;nameForLogging());</span><br><span class="line">                &#125;</span><br><span class="line">                // fixme also disallow relocatable classes</span><br><span class="line">                // We can&#x27;t disallow all Swift classes because of</span><br><span class="line">                // classes like Swift.__EmptyArrayStorage</span><br><span class="line">            &#125;</span><br><span class="line">            //å®ç°å½“å‰çš„ç±»ï¼Œå› ä¸ºå‰é¢readClassè¯»å–åˆ°å†…å­˜çš„ä»…ä»…åªæœ‰åœ°å€+åç§°ï¼Œç±»çš„dataæ•°æ®å¹¶æ²¡æœ‰åŠ è½½å‡ºæ¥</span><br><span class="line">            //å®ç°æ‰€æœ‰éæ‡’åŠ è½½çš„ç±»(å®ä¾‹åŒ–ç±»å¯¹è±¡çš„ä¸€äº›ä¿¡æ¯ï¼Œä¾‹å¦‚rw)</span><br><span class="line">            realizeClassWithoutSwift(cls, nil);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ts.log(&quot;IMAGE TIMES: realize non-lazy classes&quot;);</span><br></pre></td></tr></table></figure></div>

<p>10ã€æ²¡æœ‰è¢«å¤„ç†çš„ç±»ï¼Œä¼˜åŒ–é‚£äº›è¢«ä¾µçŠ¯çš„ç±»</p>
<p>ä¸»è¦æ˜¯å®ç°æ²¡æœ‰è¢«å¤„ç†çš„ç±»ï¼Œä¼˜åŒ–è¢«ä¾µçŠ¯çš„ç±»</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// Realize newly-resolved future classes, in case CF manipulates them</span><br><span class="line">    if (resolvedFutureClasses) &#123;</span><br><span class="line">        for (i = 0; i &lt; resolvedFutureClassCount; i++) &#123;</span><br><span class="line">            Class cls = resolvedFutureClasses[i];</span><br><span class="line">            if (cls-&gt;isSwiftStable()) &#123;</span><br><span class="line">                _objc_fatal(&quot;Swift class is not allowed to be future&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            //å®ç°ç±»</span><br><span class="line">            realizeClassWithoutSwift(cls, nil);</span><br><span class="line">            cls-&gt;setInstancesRequireRawIsaRecursively(false/*inherited*/);</span><br><span class="line">        &#125;</span><br><span class="line">        free(resolvedFutureClasses);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ts.log(&quot;IMAGE TIMES: realize future classes&quot;);</span><br><span class="line"></span><br><span class="line">    if (DebugNonFragileIvars) &#123;</span><br><span class="line">        //å®ç°æ‰€æœ‰ç±»</span><br><span class="line">        realizeAllClasses();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨çš„æ˜¯3ä¸­çš„ <code>readClass</code> ä»¥åŠ9ä¸­ <code>realizeClassWithoutSwift</code> ä¸¤ä¸ªæ–¹æ³•</p>
<h1 id="readClassï¼šè¯»å–ç±»"><a href="#readClassï¼šè¯»å–ç±»" class="headerlink" title="readClassï¼šè¯»å–ç±»"></a>readClassï¼šè¯»å–ç±»</h1><p><code>readClass</code> ä¸»è¦æ˜¯ <code>è¯»å–ç±»</code>ï¼Œåœ¨æœªè°ƒç”¨è¯¥æ–¹æ³•å‰ï¼Œ<code>cls</code> åªæ˜¯ä¸€ä¸ª <code>åœ°å€</code>ï¼Œæ‰§è¡Œè¯¥æ–¹æ³•åï¼Œ<code>cls</code> æ˜¯ <code>ç±»çš„åç§°</code>ï¼Œå…¶æºç å®ç°å¦‚ä¸‹ï¼Œå…³é”®ä»£ç æ˜¯ <code>addNamedClass</code> å’Œ <code>addClassTableEntry</code>ï¼Œæºç å®ç°å¦‚ä¸‹</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">/***********************************************************************</span><br><span class="line">* readClass</span><br><span class="line">* Read a class and metaclass as written by a compiler. è¯»å–ç¼–è¯‘å™¨ç¼–å†™çš„ç±»å’Œå…ƒç±»</span><br><span class="line">* Returns the new class pointer. This could be:  è¿”å›æ–°çš„ç±»æŒ‡é’ˆï¼Œå¯èƒ½æ˜¯ï¼š</span><br><span class="line">* - cls</span><br><span class="line">* - nil  (cls has a missing weak-linked superclass)</span><br><span class="line">* - something else (space for this class was reserved by a future class)</span><br><span class="line">*</span><br><span class="line">* Note that all work performed by this function is preflighted by </span><br><span class="line">* mustReadClasses(). Do not change this function without updating that one.</span><br><span class="line">*</span><br><span class="line">* Locking: runtimeLock acquired by map_images or objc_readClassPair</span><br><span class="line">**********************************************************************/</span><br><span class="line">Class readClass(Class cls, bool headerIsBundle, bool headerIsPreoptimized)</span><br><span class="line">&#123;</span><br><span class="line">    const char *mangledName = cls-&gt;mangledName();//åå­—</span><br><span class="line">    </span><br><span class="line">    // **CJLå†™çš„** ----å¦‚æœæƒ³è¿›å…¥è‡ªå®šä¹‰ï¼Œè‡ªå·±åŠ ä¸€ä¸ªåˆ¤æ–­</span><br><span class="line">    const char *LGPersonName = &quot;LGPerson&quot;;</span><br><span class="line">    if (strcmp(mangledName, LGPersonName) == 0) &#123;</span><br><span class="line">        auto kc_ro = (const class_ro_t *)cls-&gt;data();</span><br><span class="line">        printf(&quot;%s -- ç ”ç©¶é‡ç‚¹--%s\n&quot;, __func__,mangledName);</span><br><span class="line">    &#125;</span><br><span class="line">    // å½“å‰ç±»çš„çˆ¶ç±»ä¸­è‹¥æœ‰ä¸¢å¤±çš„weak-linkedç±»ï¼Œåˆ™è¿”å›nil</span><br><span class="line">    if (missingWeakSuperclass(cls)) &#123;</span><br><span class="line">        // No superclass (probably weak-linked). </span><br><span class="line">        // Disavow any knowledge of this subclass.</span><br><span class="line">        if (PrintConnecting) &#123;</span><br><span class="line">            _objc_inform(&quot;CLASS: IGNORING class &#x27;%s&#x27; with &quot;</span><br><span class="line">                         &quot;missing weak-linked superclass&quot;, </span><br><span class="line">                         cls-&gt;nameForLogging());</span><br><span class="line">        &#125;</span><br><span class="line">        addRemappedClass(cls, nil);</span><br><span class="line">        cls-&gt;superclass = nil;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    cls-&gt;fixupBackwardDeployingStableSwift();</span><br><span class="line">    // åˆ¤æ–­æ˜¯ä¸æ˜¯åæœŸè¦å¤„ç†çš„ç±»</span><br><span class="line">    //  æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸ä¼šèµ°åˆ°popFutureNamedClassï¼Œå› ä¸ºè¿™æ˜¯ä¸“é—¨é’ˆå¯¹æœªæ¥å¾…å¤„ç†çš„ç±»çš„æ“ä½œ</span><br><span class="line">    //  é€šè¿‡æ–­ç‚¹è°ƒè¯•ï¼Œä¸ä¼šèµ°åˆ°ifæµç¨‹é‡Œé¢ï¼Œå› æ­¤ä¹Ÿä¸ä¼šå¯¹roã€rwè¿›è¡Œæ“ä½œ</span><br><span class="line">    Class replacing = nil;</span><br><span class="line">    if (Class newCls = popFutureNamedClass(mangledName)) &#123;</span><br><span class="line">        // This name was previously allocated as a future class.</span><br><span class="line">        // Copy objc_class to future class&#x27;s struct.</span><br><span class="line">        // Preserve future&#x27;s rw data block.</span><br><span class="line">        </span><br><span class="line">        if (newCls-&gt;isAnySwift()) &#123;</span><br><span class="line">            _objc_fatal(&quot;Can&#x27;t complete future class request for &#x27;%s&#x27; &quot;</span><br><span class="line">                        &quot;because the real class is too big.&quot;, </span><br><span class="line">                        cls-&gt;nameForLogging());</span><br><span class="line">        &#125;</span><br><span class="line">        //  è¯»å–classçš„dataï¼Œè®¾ç½®roã€rw</span><br><span class="line">        //  ç»è¿‡è°ƒè¯•ï¼Œå¹¶ä¸ä¼šèµ°åˆ°è¿™é‡Œ</span><br><span class="line">        class_rw_t *rw = newCls-&gt;data();</span><br><span class="line">        const class_ro_t *old_ro = rw-&gt;ro();</span><br><span class="line">        memcpy(newCls, cls, sizeof(objc_class));</span><br><span class="line">        rw-&gt;set_ro((class_ro_t *)newCls-&gt;data());</span><br><span class="line">        newCls-&gt;setData(rw);</span><br><span class="line">        freeIfMutable((char *)old_ro-&gt;name);</span><br><span class="line">        free((void *)old_ro);</span><br><span class="line">        </span><br><span class="line">        addRemappedClass(cls, newCls);</span><br><span class="line">        </span><br><span class="line">        replacing = cls;</span><br><span class="line">        cls = newCls;</span><br><span class="line">    &#125;</span><br><span class="line">    //  åˆ¤æ–­æ˜¯å¦ç±»æ˜¯å¦å·²ç»åŠ è½½åˆ°å†…å­˜</span><br><span class="line">    if (headerIsPreoptimized  &amp;&amp;  !replacing) &#123;</span><br><span class="line">        // class list built in shared cache</span><br><span class="line">        // fixme strict assert doesn&#x27;t work because of duplicates</span><br><span class="line">        // ASSERT(cls == getClass(name));</span><br><span class="line">        ASSERT(getClassExceptSomeSwift(mangledName));</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        addNamedClass(cls, mangledName, replacing);//åŠ è½½å…±äº«ç¼“å­˜ä¸­çš„ç±»</span><br><span class="line">        addClassTableEntry(cls);//æ’å…¥è¡¨ï¼Œå³ç›¸å½“äºä»mach-Oæ–‡ä»¶ è¯»å–åˆ° å†…å­˜ ä¸­</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // for future reference: shared cache never contains MH_BUNDLEs</span><br><span class="line">    if (headerIsBundle) &#123;</span><br><span class="line">        cls-&gt;data()-&gt;flags |= RO_FROM_BUNDLE;</span><br><span class="line">        cls-&gt;ISA()-&gt;data()-&gt;flags |= RO_FROM_BUNDLE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return cls;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>é€šè¿‡æºç å®ç°ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</p>
<ul>
<li>é€šè¿‡ <code>mangledName</code> è·å–ç±»çš„åå­—ï¼Œå…¶ä¸­ <code>mangledName</code> æ–¹æ³•çš„æºç å®ç°å¦‚ä¸‹</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const char *mangledName() &#123; </span><br><span class="line">        // fixme can&#x27;t assert locks here</span><br><span class="line">        ASSERT(this);</span><br><span class="line"></span><br><span class="line">        if (isRealized()  ||  isFuture()) &#123; //è¿™ä¸ªåˆå§‹åŒ–åˆ¤æ–­åœ¨lookupImpä¹Ÿæœ‰ç±»ä¼¼çš„</span><br><span class="line">            return data()-&gt;ro()-&gt;name;//å¦‚æœå·²ç»å®ä¾‹åŒ–ï¼Œåˆ™ä»roä¸­è·å–name</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return ((const class_ro_t *)data())-&gt;name;//åä¹‹ï¼Œä»mach-Oçš„æ•°æ®dataä¸­è·å–name</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li><p>å½“å‰ç±»çš„çˆ¶ç±»ä¸­è‹¥æœ‰ä¸¢å¤±çš„ <code>weak-linked</code> ç±»ï¼Œåˆ™è¿”å› <code>nil</code></p>
</li>
<li><p>åˆ¤æ–­æ˜¯ä¸æ˜¯åæœŸéœ€è¦å¤„ç†çš„ç±»ï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸ä¼šèµ°åˆ° <code>popFutureNamedClass</code>ï¼Œå› ä¸ºè¿™æ˜¯ <code>ä¸“é—¨é’ˆå¯¹æœªæ¥å¾…å¤„ç†çš„ç±»çš„æ“ä½œ</code>ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ–­ç‚¹è°ƒè¯•ï¼Œå¯çŸ¥ä¸ä¼šèµ°åˆ° <code>ifæµç¨‹</code> é‡Œé¢ï¼Œå› æ­¤ä¹Ÿä¸ä¼šå¯¹<code>roã€rw</code> è¿›è¡Œæ“ä½œ</p>
<ul>
<li><p><code>data</code> æ˜¯ <code>mach-O</code> çš„æ•°æ®ï¼Œå¹¶ <code>ä¸åœ¨classçš„å†…å­˜</code> ä¸­</p>
</li>
<li><p><code>ro</code> çš„ <code>èµ‹å€¼</code> æ˜¯ä» <code>mach-O</code> ä¸­çš„ <code>data</code> å¼ºè½¬èµ‹å€¼çš„</p>
</li>
<li><p><code>rw</code> é‡Œçš„ <code>ro</code> æ˜¯ä» <code>ro</code> å¤åˆ¶è¿‡å»çš„</p>
</li>
</ul>
</li>
<li><p>é€šè¿‡ <code>addNamedClass</code> å°†å½“å‰ç±»æ·»åŠ åˆ°å·²ç»åˆ›å»ºå¥½çš„ <code>gdb_objc_realized_classes</code> å“ˆå¸Œè¡¨ï¼Œè¯¥è¡¨ç”¨äºå­˜æ”¾æ‰€æœ‰ç±»</p>
</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/***********************************************************************</span><br><span class="line">* addNamedClass åŠ è½½å…±äº«ç¼“å­˜ä¸­çš„ç±» æ’å…¥è¡¨</span><br><span class="line">* Adds name =&gt; cls to the named non-meta class map. å°†name=&gt; clsæ·»åŠ åˆ°å‘½åçš„éå…ƒç±»æ˜ å°„</span><br><span class="line">* Warns about duplicate class names and keeps the old mapping.</span><br><span class="line">* Locking: runtimeLock must be held by the caller</span><br><span class="line">**********************************************************************/</span><br><span class="line">static void addNamedClass(Class cls, const char *name, Class replacing = nil)</span><br><span class="line">&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line">    Class old;</span><br><span class="line">    if ((old = getClassExceptSomeSwift(name))  &amp;&amp;  old != replacing) &#123;</span><br><span class="line">        inform_duplicate(name, old, cls);</span><br><span class="line"></span><br><span class="line">        // getMaybeUnrealizedNonMetaClass uses name lookups.</span><br><span class="line">        // Classes not found by name lookup must be in the</span><br><span class="line">        // secondary meta-&gt;nonmeta table.</span><br><span class="line">        addNonMetaClass(cls);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //æ·»åŠ åˆ°gdb_objc_realized_classeså“ˆå¸Œè¡¨</span><br><span class="line">        NXMapInsert(gdb_objc_realized_classes, name, cls);</span><br><span class="line">    &#125;</span><br><span class="line">    ASSERT(!(cls-&gt;data()-&gt;flags &amp; RO_META));</span><br><span class="line"></span><br><span class="line">    // wrong: constructed classes are already realized when they get here</span><br><span class="line">    // ASSERT(!cls-&gt;isRealized());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>é€šè¿‡ <code>addClassTableEntry</code>ï¼Œå°†åˆå§‹åŒ–çš„ç±»æ·»åŠ åˆ° <code>allocatedClasses</code> è¡¨ï¼Œè¿™ä¸ªè¡¨åœ¨ <a href="">OCåº•å±‚åŸç†16ï¼šdyldä¸objcçš„å…³è”</a> æ–‡ç« ä¸­æåŠè¿‡ï¼Œæ˜¯åœ¨ <code>_objc_init</code> ä¸­çš„ <code>runtime_init</code> å°±åˆ›å»ºäº† <code>allocatedClasses</code> è¡¨</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/***********************************************************************</span><br><span class="line">* addClassTableEntry å°†ä¸€ä¸ªç±»æ·»åŠ åˆ°æ‰€æœ‰ç±»çš„è¡¨ä¸­</span><br><span class="line">* Add a class to the table of all classes. If addMeta is true,</span><br><span class="line">* automatically adds the metaclass of the class as well.</span><br><span class="line">* Locking: runtimeLock must be held by the caller.</span><br><span class="line">**********************************************************************/</span><br><span class="line">static void</span><br><span class="line">addClassTableEntry(Class cls, bool addMeta = true)</span><br><span class="line">&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    // This class is allowed to be a known class via the shared cache or via</span><br><span class="line">    // data segments, but it is not allowed to be in the dynamic table already.</span><br><span class="line">    auto &amp;set = objc::allocatedClasses.get();//å¼€è¾Ÿçš„ç±»çš„è¡¨ï¼Œåœ¨objc_initä¸­çš„runtime_initå°±åˆ›å»ºäº†è¡¨</span><br><span class="line"></span><br><span class="line">    ASSERT(set.find(cls) == set.end());</span><br><span class="line"></span><br><span class="line">    if (!isKnownClass(cls))</span><br><span class="line">        set.insert(cls);</span><br><span class="line">    if (addMeta)</span><br><span class="line">        //æ·»åŠ åˆ°allocatedClasseså“ˆå¸Œè¡¨</span><br><span class="line">        addClassTableEntry(cls-&gt;ISA(), false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœæˆ‘ä»¬æƒ³åœ¨ <code>readClass</code> æºç ä¸­æƒ³ <code>å®šä½åˆ°è‡ªå®šä¹‰çš„ç±»</code>ï¼Œå¯ä»¥ <code>è‡ªå®šä¹‰åŠ ifåˆ¤æ–­</code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071408989.png"
                     
                ></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æ‰€ä»¥ç»¼ä¸Šæ‰€è¿°ï¼Œ<code>readClass</code> çš„ä¸»è¦ä½œç”¨å°±æ˜¯å°† <code>Mach-O</code> ä¸­çš„ç±»è¯»å–åˆ° <code>å†…å­˜</code>ï¼Œå³æ’å…¥è¡¨ä¸­ï¼Œä½†æ˜¯ç›®å‰çš„ç±»ä»…æœ‰ä¸¤ä¸ªä¿¡æ¯ï¼š<code>åœ°å€ä»¥åŠåç§°</code>ï¼Œè€Œmach-Oçš„å…¶ä¸­çš„dataæ•°æ®è¿˜æœªè¯»å–å‡ºæ¥</p>
<h1 id="realizeClassWithoutSwiftï¼šå®ç°ç±»"><a href="#realizeClassWithoutSwiftï¼šå®ç°ç±»" class="headerlink" title="realizeClassWithoutSwiftï¼šå®ç°ç±»"></a>realizeClassWithoutSwiftï¼šå®ç°ç±»</h1><p><code>realizeClassWithoutSwift</code> æ–¹æ³•ä¸­æœ‰ <code>roã€rw</code> çš„ç›¸å…³æ“ä½œï¼Œè¿™ä¸ªæ–¹æ³•åœ¨æ¶ˆæ¯æµç¨‹çš„æ…¢é€ŸæŸ¥æ‰¾ä¸­æœ‰æ‰€æåŠ,æ–¹æ³•è·¯å¾„ä¸ºï¼šæ…¢é€ŸæŸ¥æ‰¾(<code>lookUpImpOrForward</code>) â€“ <code>realizeClassMaybeSwiftAndLeaveLocked</code> â€“ <code>realizeClassMaybeSwiftMaybeRelock</code> â€“ <code>realizeClassWithoutSwift</code>ï¼ˆå®ç°ç±»ï¼‰</p>
<p><code>realizeClassWithoutSwift</code> æ–¹æ³•ä¸»è¦ä½œç”¨æ˜¯ <code>å®ç°ç±»</code>ï¼Œå°†ç±»çš„ <code>data</code> æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ éƒ¨åˆ†æ“ä½œï¼š</p>
<ul>
<li>ã€ç¬¬ä¸€æ­¥ã€‘è¯»å– <code>data</code> æ•°æ®ï¼Œå¹¶è®¾ç½® <code>roã€rw</code></li>
<li>ã€ç¬¬äºŒæ­¥ã€‘é€’å½’è°ƒç”¨ <code>realizeClassWithoutSwift</code> å®Œå–„ç»§æ‰¿é“¾</li>
<li>ã€ç¬¬ä¸‰æ­¥ã€‘é€šè¿‡ <code>methodizeClass</code> æ–¹æ³•åŒ–ç±»</li>
</ul>
<p><strong>ç¬¬ä¸€æ­¥ï¼šè¯»å–dataæ•°æ®</strong></p>
<p>è¯»å– <code>class</code> çš„ <code>data</code> æ•°æ®ï¼Œå¹¶å°†å…¶å¼ºè½¬ä¸º <code>ro</code>ï¼Œä»¥åŠ <code>rw</code> åˆå§‹åŒ–å’Œ <code>ro</code> æ‹·è´ä¸€ä»½åˆ° <code>rw</code> ä¸­çš„ <code>ro</code></p>
<ul>
<li><p><code>ro</code> è¡¨ç¤º <code>readOnly</code>ï¼Œå³ <code>åªè¯»</code>ï¼Œå…¶åœ¨ç¼–è¯‘æ—¶å°±å·²ç»ç¡®å®šäº†å†…å­˜ï¼ŒåŒ…å«ç±»åç§°ã€æ–¹æ³•ã€åè®®å’Œå®ä¾‹å˜é‡çš„ä¿¡æ¯ï¼Œç”±äºæ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥å±äº <code>Clean Memory</code>ï¼Œè€Œ <code>Clean Memory</code> æ˜¯æŒ‡åŠ è½½åä¸ä¼šå‘ç”Ÿæ›´æ”¹çš„å†…å­˜</p>
</li>
<li><p><code>rw</code> è¡¨ç¤º <code>readWrite</code>ï¼Œå³ <code>å¯è¯»å¯å†™</code>ï¼Œç”±äºå…¶åŠ¨æ€æ€§ï¼Œå¯èƒ½ä¼šå¾€ç±»ä¸­æ·»åŠ å±æ€§ã€æ–¹æ³•ã€æ·»åŠ åè®®ï¼Œåœ¨æœ€æ–°çš„2020çš„ <code>WWDC</code> çš„å¯¹å†…å­˜ä¼˜åŒ–çš„è¯´æ˜ <a class="link"   target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2020/10163/" >Advancements in the Objective-C runtime - WWDC 2020 - Videos - Apple Developer <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> ä¸­ï¼Œæåˆ° <code>rw</code>ï¼Œå…¶å®åœ¨ <code>rw</code> ä¸­åªæœ‰10%çš„ç±»çœŸæ­£çš„æ›´æ”¹äº†å®ƒä»¬çš„æ–¹æ³•ï¼Œæ‰€ä»¥æœ‰äº†rwï¼Œå³ <code>ç±»çš„é¢å¤–ä¿¡æ¯</code>ã€‚å¯¹äºé‚£äº›ç¡®å®éœ€è¦é¢å¤–ä¿¡æ¯çš„ç±»ï¼Œå¯ä»¥åˆ†é… <code>rw</code> æ‰©å±•è®°å½•ä¸­çš„ä¸€ä¸ªï¼Œå¹¶å°†å…¶æ»‘å…¥ç±»ä¸­ä¾›å…¶ä½¿ç”¨ã€‚å…¶ä¸­ <code>rw</code> å°±å±äº <code>dirty memory</code>ï¼Œè€Œ <code>dirty memory</code> æ˜¯æŒ‡åœ¨è¿›ç¨‹è¿è¡Œæ—¶ä¼šå‘ç”Ÿæ›´æ”¹çš„å†…å­˜ï¼Œç±»ç»“æ„ä¸€ç»ä½¿ç”¨å°±ä¼šå˜æˆ <code>ditry memory</code>ï¼Œå› ä¸ºè¿è¡Œæ—¶ä¼šå‘å®ƒå†™å…¥æ–°æ•°æ®ï¼Œä¾‹å¦‚ <code>åˆ›å»ºä¸€ä¸ªæ–°çš„æ–¹æ³•ç¼“å­˜</code>ï¼Œå¹¶ä»ç±»ä¸­æŒ‡å‘å®ƒ</p>
</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// fixme verify class is not in an un-dlopened part of the shared cache?</span><br><span class="line">//è¯»å–classçš„data()ï¼Œä»¥åŠro/rwåˆ›å»º</span><br><span class="line">auto ro = (const class_ro_t *)cls-&gt;data(); //è¯»å–ç±»ç»“æ„çš„bitså±æ€§ã€//ro -- clean memoryï¼Œåœ¨ç¼–è¯‘æ—¶å°±å·²ç»ç¡®å®šäº†å†…å­˜</span><br><span class="line">auto isMeta = ro-&gt;flags &amp; RO_META; //åˆ¤æ–­å…ƒç±»</span><br><span class="line">if (ro-&gt;flags &amp; RO_FUTURE) &#123;</span><br><span class="line">    // This was a future class. rw data is already allocated.</span><br><span class="line">    rw = cls-&gt;data(); //dirty memory è¿›è¡Œèµ‹å€¼</span><br><span class="line">    ro = cls-&gt;data()-&gt;ro();</span><br><span class="line">    ASSERT(!isMeta);</span><br><span class="line">    cls-&gt;changeInfo(RW_REALIZED|RW_REALIZING, RW_FUTURE);</span><br><span class="line">&#125; else &#123; //æ­¤æ—¶å°†æ•°æ®è¯»å–è¿›æ¥äº†ï¼Œä¹Ÿèµ‹å€¼å®Œæ¯•äº†</span><br><span class="line">    // Normal class. Allocate writeable class data.</span><br><span class="line">    rw = objc::zalloc&lt;class_rw_t&gt;(); //ç”³è¯·å¼€è¾Ÿzalloc -- rw</span><br><span class="line">    rw-&gt;set_ro(ro);//rwä¸­çš„roè®¾ç½®ä¸ºä¸´æ—¶å˜é‡ro</span><br><span class="line">    rw-&gt;flags = RW_REALIZED|RW_REALIZING|isMeta;</span><br><span class="line">    cls-&gt;setData(rw);//å°†clsçš„dataèµ‹å€¼ä¸ºrwå½¢å¼</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>ã€ç¬¬äºŒæ­¥ã€‘é€’å½’è°ƒç”¨ realizeClassWithoutSwift å®Œå–„ ç»§æ‰¿é“¾</strong></p>
<p>é€’å½’è°ƒç”¨ <code>realizeClassWithoutSwift</code> å®Œå–„ <code>ç»§æ‰¿é“¾</code>,å¹¶è®¾ç½®å½“å‰ç±»ã€çˆ¶ç±»ã€å…ƒç±»çš„ <code>rw</code></p>
<ul>
<li><p>é€’å½’è°ƒç”¨ <code>realizeClassWithoutSwift</code> è®¾ç½® <code>çˆ¶ç±»ã€å…ƒç±»</code></p>
</li>
<li><p>è®¾ç½® <code>çˆ¶ç±»å’Œå…ƒç±»çš„isaæŒ‡å‘</code></p>
</li>
<li><p>é€šè¿‡ <code>addSubclass</code> å’Œ <code>addRootClass</code> è®¾ç½®çˆ¶å­çš„åŒå‘é“¾è¡¨æŒ‡å‘å…³ç³»ï¼Œå³çˆ¶ç±»ä¸­å¯ä»¥æ‰¾åˆ°å­ç±»ï¼Œå­ç±»ä¸­å¯ä»¥æ‰¾åˆ°çˆ¶ç±»</p>
</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> // Realize superclass and metaclass, if they aren&#x27;t already.</span><br><span class="line">    // This needs to be done after RW_REALIZED is set above, for root classes.</span><br><span class="line">    // This needs to be done after class index is chosen, for root metaclasses.</span><br><span class="line">    // This assumes that none of those classes have Swift contents,</span><br><span class="line">    //   or that Swift&#x27;s initializers have already been called.</span><br><span class="line">    //   fixme that assumption will be wrong if we add support</span><br><span class="line">    //   for ObjC subclasses of Swift classes. --</span><br><span class="line">    //é€’å½’è°ƒç”¨realizeClassWithoutSwiftå®Œå–„ç»§æ‰¿é“¾,å¹¶å¤„ç†å½“å‰ç±»çš„çˆ¶ç±»ã€å…ƒç±»</span><br><span class="line">    //é€’å½’å®ç° è®¾ç½®å½“å‰ç±»ã€çˆ¶ç±»ã€å…ƒç±»çš„ rwï¼Œä¸»è¦ç›®çš„æ˜¯ç¡®å®šç»§æ‰¿é“¾ ï¼ˆç±»ç»§æ‰¿é“¾ã€å…ƒç±»ç»§æ‰¿é“¾ï¼‰</span><br><span class="line">    //å®ç°å…ƒç±»ã€çˆ¶ç±»</span><br><span class="line">    //å½“isaæ‰¾åˆ°æ ¹å…ƒç±»ä¹‹åï¼Œæ ¹å…ƒç±»çš„isaæ˜¯æŒ‡å‘è‡ªå·±çš„ï¼Œä¸ä¼šè¿”å›nilä»è€Œå¯¼è‡´æ­»å¾ªç¯â€”â€”remapClassä¸­å¯¹ç±»åœ¨è¡¨ä¸­è¿›è¡ŒæŸ¥æ‰¾çš„æ“ä½œï¼Œå¦‚æœè¡¨ä¸­å·²æœ‰è¯¥ç±»ï¼Œåˆ™è¿”å›ä¸€ä¸ªç©ºå€¼ï¼›å¦‚æœæ²¡æœ‰åˆ™è¿”å›å½“å‰ç±»ï¼Œè¿™æ ·ä¿è¯äº†ç±»åªåŠ è½½ä¸€æ¬¡å¹¶ç»“æŸé€’å½’</span><br><span class="line">    supercls = realizeClassWithoutSwift(remapClass(cls-&gt;superclass), nil);</span><br><span class="line">    metacls = realizeClassWithoutSwift(remapClass(cls-&gt;ISA()), nil);</span><br><span class="line">    </span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">// Update superclass and metaclass in case of remapping -- class æ˜¯ åŒå‘é“¾è¡¨ç»“æ„ å³çˆ¶å­å…³ç³»éƒ½ç¡®è®¤äº†</span><br><span class="line">// å°†çˆ¶ç±»å’Œå…ƒç±»ç»™æˆ‘ä»¬çš„ç±» åˆ†åˆ«æ˜¯isaå’Œçˆ¶ç±»çš„å¯¹åº”å€¼</span><br><span class="line">cls-&gt;superclass = supercls;</span><br><span class="line">cls-&gt;initClassIsa(metacls);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">// Connect this class to its superclass&#x27;s subclass lists</span><br><span class="line">//åŒå‘é“¾è¡¨æŒ‡å‘å…³ç³» çˆ¶ç±»ä¸­å¯ä»¥æ‰¾åˆ°å­ç±» å­ç±»ä¸­ä¹Ÿå¯ä»¥æ‰¾åˆ°çˆ¶ç±»</span><br><span class="line">//é€šè¿‡addSubclassæŠŠå½“å‰ç±»æ”¾åˆ°çˆ¶ç±»çš„å­ç±»åˆ—è¡¨ä¸­å»</span><br><span class="line">if (supercls) &#123;</span><br><span class="line">    addSubclass(supercls, cls);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    addRootClass(cls);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œ<code>realizeClassWithoutSwift</code> é€’å½’è°ƒç”¨æ—¶ï¼Œ<code>isa</code> æ‰¾åˆ° <code>æ ¹å…ƒç±»</code> ä¹‹åï¼Œæ ¹å…ƒç±»çš„ <code>isa</code> æ˜¯ <code>æŒ‡å‘è‡ªå·±</code>ï¼Œå¹¶ä¸ä¼šè¿”å› <code>nil</code>ï¼Œæ‰€ä»¥æœ‰ä»¥ä¸‹é€’å½’ç»ˆæ­¢æ¡ä»¶ï¼Œå…¶ç›®çš„æ˜¯ä¿è¯ç±»åªåŠ è½½ä¸€æ¬¡</p>
<ul>
<li><p>åœ¨ <code>realizeClassWithoutSwift</code> ä¸­</p>
<ul>
<li><p>å¦‚æœç±» <code>ä¸å­˜åœ¨</code>ï¼Œåˆ™è¿”å› <code>nil</code></p>
</li>
<li><p>å¦‚æœç±» <code>å·²ç»å®ç°</code>ï¼Œåˆ™ç›´æ¥è¿”å› <code>cls</code></p>
</li>
</ul>
</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">static Class realizeClassWithoutSwift(Class cls, Class previously)</span><br><span class="line">&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line">    </span><br><span class="line">    //å¦‚æœç±»ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›nil</span><br><span class="line">    if (!cls) return nil;</span><br><span class="line">    å¦‚æœç±»å·²ç»å®ç°ï¼Œåˆ™ç›´æ¥è¿”å›cls</span><br><span class="line">    if (cls-&gt;isRealized()) return cls;</span><br><span class="line">    ASSERT(cls == remapClass(cls));</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>åœ¨ <code>remapClass</code> æ–¹æ³•ä¸­ï¼Œå¦‚æœ <code>cls</code> ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å› <code>nil</code></li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/***********************************************************************</span><br><span class="line">* remapClass</span><br><span class="line">* Returns the live class pointer for cls, which may be pointing to </span><br><span class="line">* a class struct that has been reallocated.</span><br><span class="line">* Returns nil if cls is ignored because of weak linking.</span><br><span class="line">* Locking: runtimeLock must be read- or write-locked by the caller</span><br><span class="line">**********************************************************************/</span><br><span class="line">static Class remapClass(Class cls)</span><br><span class="line">&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    if (!cls) return nil;//å¦‚æœclsä¸å­˜åœ¨ï¼Œåˆ™è¿”å›nil</span><br><span class="line"></span><br><span class="line">    auto *map = remappedClasses(NO);</span><br><span class="line">    if (!map)</span><br><span class="line">        return cls;</span><br><span class="line">    </span><br><span class="line">    auto iterator = map-&gt;find(cls);</span><br><span class="line">    if (iterator == map-&gt;end())</span><br><span class="line">        return cls;</span><br><span class="line">    return std::get&lt;1&gt;(*iterator);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ã€ç¬¬ä¸‰æ­¥ã€‘é€šè¿‡ <code>methodizeClass</code> æ–¹æ³•åŒ–ç±»</p>
<p>é€šè¿‡ <code>methodizeClass</code> æ–¹æ³•ï¼Œä» <code>ro</code> ä¸­è¯»å–æ–¹æ³•åˆ—è¡¨ï¼ˆåŒ…æ‹¬åˆ†ç±»ä¸­çš„æ–¹æ³•ï¼‰ã€å±æ€§åˆ—è¡¨ã€åè®®åˆ—è¡¨èµ‹å€¼ç»™ <code>rw</code>ï¼Œå¹¶è¿”å› <code>cls</code></p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// Attach categories é™„åŠ ç±»åˆ« -- ç–‘é—®ï¼šroä¸­ä¹Ÿæœ‰æ–¹æ³•åˆ—è¡¨ rwä¸­ä¹Ÿæœ‰æ–¹æ³•åˆ—è¡¨ï¼Œä¸‹é¢è¿™ä¸ªæ–¹æ³•å¯ä»¥è¯´æ˜</span><br><span class="line">//å°†roæ•°æ®å†™å…¥åˆ°rw</span><br><span class="line">methodizeClass(cls, previously);</span><br><span class="line"></span><br><span class="line">return cls;</span><br></pre></td></tr></table></figure></div>

<p><strong>æ–­ç‚¹è°ƒè¯• <code>realizeClassWithoutSwift</code></strong></p>
<p>å¦‚æœæˆ‘ä»¬éœ€è¦è·Ÿè¸ªè‡ªå®šä¹‰ç±»ï¼ŒåŒæ ·éœ€è¦ <code>_read_images</code> æ–¹æ³•ä¸­çš„ç¬¬ä¹æ­¥çš„<code>realizeClassWithoutSwift</code> è°ƒç”¨å‰ï¼Œä»¥åŠ <code>realizeClassWithoutSwift</code> æ–¹æ³•ä¸­å¢åŠ è‡ªå®šä¹‰é€»è¾‘ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ–¹ä¾¿ <code>è°ƒè¯•è‡ªå®šä¹‰ç±»</code></p>
<ul>
<li><code>_read_images</code> æ–¹æ³•ä¸­çš„ç¬¬ä¹æ­¥çš„ <code>realizeClassWithoutSwift</code> è°ƒç”¨å‰å¢åŠ è‡ªå®šä¹‰é€»è¾‘</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071419089.png"
                     
                ></p>
<ul>
<li>realizeClassWithoutSwiftæ–¹æ³•ä¸­å¢åŠ è‡ªå®šä¹‰é€»è¾‘</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071419766.png"
                     
                ></p>
<p>ä¸‹é¢ï¼Œå¼€å¯æˆ‘ä»¬çš„æ–­ç‚¹è°ƒè¯•</p>
<ul>
<li>åœ¨ <code>LGPerson</code> ä¸­é‡å†™ <code>+load</code> å‡½æ•°</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071420555.png"
                     
                ></p>
<ul>
<li>é‡æ–°è¿è¡Œç¨‹åºï¼Œæˆ‘ä»¬å°±èµ°åˆ°äº† <code>_read_images</code> çš„ç¬¬ä¹æ­¥ä¸­çš„è‡ªå®šä¹‰é€»è¾‘éƒ¨åˆ†</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071420333.png"
                     
                ></p>
<ul>
<li>åœ¨ <code>realizeClassWithoutSwift</code> è°ƒç”¨éƒ¨åˆ†åŠ æ–­ç‚¹ï¼Œè¿è¡Œå¹¶æ–­ä½</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071421940.png"
                     
                ></p>
<ul>
<li>ç»§ç»­è¿è¡Œç¨‹åºï¼Œæ–­ç‚¹æ¥åˆ° <code>realizeClassWithoutSwift</code> æ–¹æ³•è‡ªå®šä¹‰åˆ¤æ–­çš„ä»£ç ä¸­</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071421465.png"
                     
                ></p>
<ul>
<li>ç»§ç»­åœ¨ <code>auto ro =</code> åŠ æ–­ç‚¹ï¼Œç»§ç»­è¿è¡Œï¼Œæ–­ä½ <code>--</code> è¿™éƒ¨åˆ†ä¸»è¦æ˜¯ <code>è¯»å–data</code></li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071422586.png"
                     
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071422647.png"
                     
                ></p>
<ul>
<li>åœ¨elseé‡Œé¢çš„ <code>rw-&gt;set_ro(ro);</code> å¤„åŠ æ–­ç‚¹ï¼Œæ–­ä½ï¼ŒæŸ¥çœ‹ <code>rw</code>ï¼Œæ­¤æ—¶çš„ <code>rw</code> æ˜¯ <code>0x0</code>,æŸ¥çœ‹ <code>rw</code>ï¼Œå…¶ä¸­åŒ…æ‹¬ <code>ro</code> å’Œ <code>rw</code></li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071423831.png"
                     
                ></p>
<ul>
<li><code>x/4gx cls</code> å…¶ä¸­çº¢æ¡†éƒ¨åˆ†ä¸º0</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071423835.png"
                     
                ></p>
<ul>
<li>ç»§ç»­è¿è¡Œï¼Œç„¶åæŸ¥çœ‹ <code>x/4gx cls</code>ï¼Œæ­¤æ—¶è¿˜æ˜¯ä¸º <code>0x0</code></li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071425379.png"
                     
                ></p>
<p>è¿™é‡Œæˆ‘ä»¬éœ€è¦å»æŸ¥çœ‹ <code>set_ro</code> çš„æºç å®ç°ï¼Œå…¶è·¯å¾„ä¸ºï¼š<code>set_ro -- set_ro_or_rwe</code>ï¼ˆæ‰¾åˆ° <code>get_ro_or_rwe</code>ï¼Œæ˜¯é€šè¿‡ <code>ro_or_rw_ext_t</code> ç±»å‹ä» <code>ro_or_rw_ext</code> ä¸­è·å–ï¼‰ â€“ <code>ro_or_rw_ext_t</code> ä¸­çš„ <code>ro</code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071426580.png"
                     
                ></p>
<p>é€šè¿‡æºç å¯çŸ¥ <code>ro</code> çš„è·å–ä¸»è¦åˆ†ä¸¤ç§æƒ…å†µï¼š<code>æœ‰æ²¡æœ‰è¿è¡Œæ—¶</code>ï¼Œ</p>
<pre><code>* å¦‚æœ `æœ‰è¿è¡Œæ—¶`ï¼Œä» `rw` ä¸­è¯»å–

* åä¹‹ï¼Œå¦‚æœ `æ²¡æœ‰è¿è¡Œæ—¶`ï¼Œä» `ro` ä¸­è¯»å–
</code></pre>
<ul>
<li>åœ¨ <code>if (supercls &amp;&amp; !isMeta)</code> å¤„åŠ æ–­ç‚¹ï¼Œç»§ç»­è¿è¡Œæ–­ä½ï¼Œæ­¤æ—¶æ–­ç‚¹çš„ <code>cls</code> æ˜¯åœ°å€ï¼ŒçŒœæµ‹<code>cls</code> å¯èƒ½æ˜¯å…ƒç±»</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071427582.png"
                     
                ></p>
<p>ä¸‹é¢æ¥è¿›è¡ŒéªŒè¯ï¼šé€šè¿‡ <code>cls</code> çš„ <code>isa</code> æŒ‡é’ˆåœ°å€æ¥éªŒè¯ï¼Œæ˜¯åŒä¸€ä¸ªåœ°å€ï¼Œè¿™ä¸ªæ˜¯å­˜åœ¨ä¸€ä¸ª <code>é€’å½’</code>ï¼ˆåœ¨supercls &#x3D; ã€metacls &#x3D;éƒ¨åˆ†é€’å½’ï¼‰</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071428111.png"
                     
                ></p>
<h1 id="methodizeClassï¼šæ–¹æ³•åŒ–ç±»"><a href="#methodizeClassï¼šæ–¹æ³•åŒ–ç±»" class="headerlink" title="methodizeClassï¼šæ–¹æ³•åŒ–ç±»"></a>methodizeClassï¼šæ–¹æ³•åŒ–ç±»</h1><p>å…¶ä¸­ <code>methodizeClass</code> çš„æºç å®ç°å¦‚ä¸‹ï¼Œä¸»è¦åˆ†ä¸ºå‡ éƒ¨åˆ†ï¼š</p>
<ul>
<li><p>å°† <code>å±æ€§åˆ—è¡¨ã€æ–¹æ³•åˆ—è¡¨ã€åè®®åˆ—è¡¨</code> ç­‰è´´åˆ° <code>rwe</code> ä¸­</p>
</li>
<li><p>é™„åŠ  <code>åˆ†ç±»</code> ä¸­çš„æ–¹æ³•ï¼ˆå°†åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­è¿›è¡Œè§£é‡Šè¯´æ˜ï¼‰</p>
</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">static void methodizeClass(Class cls, Class previously)</span><br><span class="line">&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    bool isMeta = cls-&gt;isMetaClass();</span><br><span class="line">    auto rw = cls-&gt;data(); // åˆå§‹åŒ–ä¸€ä¸ªrw</span><br><span class="line">    auto ro = rw-&gt;ro();</span><br><span class="line">    auto rwe = rw-&gt;ext();</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    // Install methods and properties that the class implements itself.</span><br><span class="line">    //å°†å±æ€§åˆ—è¡¨ã€æ–¹æ³•åˆ—è¡¨ã€åè®®åˆ—è¡¨ç­‰è´´åˆ°rwä¸­</span><br><span class="line">    // å°†roä¸­çš„æ–¹æ³•åˆ—è¡¨åŠ å…¥åˆ°rwä¸­</span><br><span class="line">    method_list_t *list = ro-&gt;baseMethods();//è·å–roçš„baseMethods</span><br><span class="line">    if (list) &#123;</span><br><span class="line">        prepareMethodLists(cls, &amp;list, 1, YES, isBundleClass(cls));//methodsè¿›è¡Œæ’åº</span><br><span class="line">        if (rwe) rwe-&gt;methods.attachLists(&amp;list, 1);//å¯¹rweè¿›è¡Œå¤„ç†</span><br><span class="line">    &#125;</span><br><span class="line">    // åŠ å…¥å±æ€§</span><br><span class="line">    property_list_t *proplist = ro-&gt;baseProperties;</span><br><span class="line">    if (rwe &amp;&amp; proplist) &#123;</span><br><span class="line">        rwe-&gt;properties.attachLists(&amp;proplist, 1);</span><br><span class="line">    &#125;</span><br><span class="line">    // åŠ å…¥åè®®</span><br><span class="line">    protocol_list_t *protolist = ro-&gt;baseProtocols;</span><br><span class="line">    if (rwe &amp;&amp; protolist) &#123;</span><br><span class="line">        rwe-&gt;protocols.attachLists(&amp;protolist, 1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Root classes get bonus method implementations if they don&#x27;t have </span><br><span class="line">    // them already. These apply before category replacements.</span><br><span class="line">    if (cls-&gt;isRootMetaclass()) &#123;</span><br><span class="line">        // root metaclass</span><br><span class="line">        addMethod(cls, @selector(initialize), (IMP)&amp;objc_noop_imp, &quot;&quot;, NO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Attach categories.</span><br><span class="line">    // åŠ å…¥åˆ†ç±»ä¸­çš„æ–¹æ³•</span><br><span class="line">    if (previously) &#123;</span><br><span class="line">        if (isMeta) &#123;</span><br><span class="line">            objc::unattachedCategories.attachToClass(cls, previously,</span><br><span class="line">                                                     ATTACH_METACLASS);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // When a class relocates, categories with class methods</span><br><span class="line">            // may be registered on the class itself rather than on</span><br><span class="line">            // the metaclass. Tell attachToClass to look for those.</span><br><span class="line">            objc::unattachedCategories.attachToClass(cls, previously,</span><br><span class="line">                                                     ATTACH_CLASS_AND_METACLASS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    objc::unattachedCategories.attachToClass(cls, cls,</span><br><span class="line">                                             isMeta ? ATTACH_METACLASS : ATTACH_CLASS);</span><br><span class="line"></span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="rweçš„é€»è¾‘"><a href="#rweçš„é€»è¾‘" class="headerlink" title="rweçš„é€»è¾‘"></a>rweçš„é€»è¾‘</h1><p>æ–¹æ³•åˆ—è¡¨åŠ å…¥ <code>rwe</code> çš„é€»è¾‘å¦‚ä¸‹ï¼š</p>
<ul>
<li><p>è·å– <code>ro</code> çš„ <code>baseMethods</code></p>
</li>
<li><p>é€šè¿‡ <code>prepareMethodLists</code> æ–¹æ³•æ’åº</p>
</li>
<li><p>å¯¹ <code>rwe</code> è¿›è¡Œå¤„ç†å³é€šè¿‡ <code>attachLists</code> æ’å…¥</p>
</li>
</ul>
<h1 id="æ–¹æ³•å¦‚ä½•æ’åº"><a href="#æ–¹æ³•å¦‚ä½•æ’åº" class="headerlink" title="æ–¹æ³•å¦‚ä½•æ’åº"></a>æ–¹æ³•å¦‚ä½•æ’åº</h1><p>åœ¨æ¶ˆæ¯æµç¨‹çš„ <a href="">OCåº•å±‚åŸç†14-2ï¼šobjc_msgSendæ–¹æ³•åˆ—è¡¨æŸ¥æ‰¾(æ…¢é€ŸæŸ¥æ‰¾)æ±‡ç¼–åˆ†æ</a> ä¸­ï¼Œæ–¹æ³•çš„æŸ¥æ‰¾ç®—æ³•æ˜¯é€šè¿‡ <code>äºŒåˆ†æŸ¥æ‰¾ç®—æ³•</code>ï¼Œè¯´æ˜ <code>sel-imp</code> æ˜¯æœ‰æ’åºçš„ï¼Œé‚£ä¹ˆæ˜¯å¦‚ä½•æ’åºçš„å‘¢ï¼Ÿ</p>
<ul>
<li>è¿›å…¥ <code>prepareMethodLists</code> çš„æºç å®ç°,å…¶å†…éƒ¨æ˜¯é€šè¿‡ <code>fixupMethodList</code> æ–¹æ³•æ’åº</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">static void </span><br><span class="line">prepareMethodLists(Class cls, method_list_t **addedLists, int addedCount,</span><br><span class="line">                   bool baseMethods, bool methodsFromBundle)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    // Add method lists to array.</span><br><span class="line">    // Reallocate un-fixed method lists.</span><br><span class="line">    // The new methods are PREPENDED to the method list array.</span><br><span class="line"></span><br><span class="line">    for (int i = 0; i &lt; addedCount; i++) &#123;</span><br><span class="line">        method_list_t *mlist = addedLists[i];</span><br><span class="line">        ASSERT(mlist);</span><br><span class="line"></span><br><span class="line">        // Fixup selectors if necessary</span><br><span class="line">        if (!mlist-&gt;isFixedUp()) &#123;</span><br><span class="line">            fixupMethodList(mlist, methodsFromBundle, true/*sort*/);//æ’åº</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>è¿›å…¥ <code>fixupMethodList</code> æºç å®ç°ï¼Œæ˜¯æ ¹æ® <code>selector address</code> æ’åº</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">static void </span><br><span class="line">fixupMethodList(method_list_t *mlist, bool bundleCopy, bool sort)</span><br><span class="line">&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line">    ASSERT(!mlist-&gt;isFixedUp());</span><br><span class="line"></span><br><span class="line">    // fixme lock less in attachMethodLists ?</span><br><span class="line">    // dyld3 may have already uniqued, but not sorted, the list</span><br><span class="line">    if (!mlist-&gt;isUniqued()) &#123;</span><br><span class="line">        mutex_locker_t lock(selLock);</span><br><span class="line">    </span><br><span class="line">        // Unique selectors in list.</span><br><span class="line">        for (auto&amp; meth : *mlist) &#123;</span><br><span class="line">            const char *name = sel_cname(meth.name);</span><br><span class="line">            meth.name = sel_registerNameNoLock(name, bundleCopy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Sort by selector address.æ ¹æ®selåœ°å€æ’åº</span><br><span class="line">    if (sort) &#123;</span><br><span class="line">        method_t::SortBySELAddress sorter;</span><br><span class="line">        std::stable_sort(mlist-&gt;begin(), mlist-&gt;end(), sorter);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Mark method list as uniqued and sorted</span><br><span class="line">    mlist-&gt;setFixedUp();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="éªŒè¯æ–¹æ³•æ’åº"><a href="#éªŒè¯æ–¹æ³•æ’åº" class="headerlink" title="éªŒè¯æ–¹æ³•æ’åº"></a>éªŒè¯æ–¹æ³•æ’åº</h1><p>ä¸‹é¢æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>è°ƒè¯•æ¥éªŒè¯</code> æ–¹æ³•çš„æ’åº</p>
<ul>
<li>åœ¨ <code>methodizeClass</code> æ–¹æ³•ä¸­æ·»åŠ è‡ªå®šä¹‰é€»è¾‘ï¼Œå¹¶æ–­ä½</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071634172.png"
                     
                ></p>
<ul>
<li><p>è¯»å– <code>ro</code> ä¸­çš„ <code>methodlist</code></p>
<ul>
<li>p kc_ro</li>
<li>p $0-&gt;baseMethodListï¼ˆé€šè¿‡ auto kc_ro &#x3D; kc_rw-&gt;ro(); â€“ ro() â€“ class_ro_tç±»å‹æŸ¥çœ‹å±æ€§ï¼‰</li>
<li>p *$1</li>
</ul>
</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071636447.png"
                     
                ></p>
<p>p $2.get(0)<br>p $2.get(1)<br>p $2.get(2)<br>p $2.get(3) â€¦</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071637729.png"
                     
                ></p>
<ul>
<li>è¿›å…¥ <code>prepareMethodLists</code> æ–¹æ³•ï¼Œå°† <code>ro</code> ä¸­çš„ <code>baseMethods</code> è¿›è¡Œæ’åº</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071637191.png"
                     
                ></p>
<ul>
<li>è¿›å…¥ <code>prepareMethodLists</code> æºç ï¼ŒåŠ è‡ªå®šä¹‰æ–­ç‚¹ï¼ˆä¸»è¦æ˜¯ä¸ºäº†é’ˆå¯¹æ€§ç ”ç©¶ï¼‰ï¼Œæ‰§è¡Œæ–­ç‚¹ï¼Œè¿è¡Œåˆ°è‡ªå®šä¹‰é€»è¾‘å¹¶æ–­ä½ï¼ˆè¿™é‡ŒåŠ  <code>kc_isMeta</code>ï¼Œä¸»è¦æ˜¯ç”¨äºè¿‡æ»¤æ‰åŒåçš„å…ƒç±»ä¸­çš„ <code>methods</code>ï¼‰</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071638150.png"
                     
                ></p>
<ul>
<li>ä¸€æ­¥æ­¥æ‰§è¡Œï¼Œæ¥åˆ° <code>fixupMethodList</code>ï¼Œå³å¯¹ <code>sel</code> æ’åº</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071639666.png"
                     
                ></p>
<ul>
<li>è¿›å…¥ <code>fixupMethodList</code> æºç å®ç°ï¼Œï¼ˆsel æ ¹æ®selAdress æ’åºï¼‰ ï¼Œå†æ¬¡æ–­ç‚¹ï¼Œæ¥åˆ°ä¸‹å›¾éƒ¨åˆ†ï¼Œå³æ–¹æ³•ç»è¿‡äº†ä¸€å±‚æ’åº</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071639199.png"
                     
                ></p>
<ul>
<li>p mlist</li>
<li>p *$7</li>
<li>p 8.get(0)ã€p8.get(1)ã€p 8.get(2)ã€p8.get(3)</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071640995.png"
                     
                ></p>
<p>æ‰€ä»¥ æ’åºå‰åçš„ <code>methodlist</code> å¯¹æ¯”å¦‚ä¸‹ï¼Œæ‰€ä»¥æ€»ç»“å¦‚ä¸‹ï¼š<code>methodizeClass</code> æ–¹æ³•ä¸­å®ç°ç±»ä¸­æ–¹æ³•ï¼ˆåè®®ç­‰ï¼‰çš„åºåˆ—åŒ–</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071640304.png"
                     
                ></p>
<h1 id="attachToClassæ–¹æ³•"><a href="#attachToClassæ–¹æ³•" class="headerlink" title="attachToClassæ–¹æ³•"></a>attachToClassæ–¹æ³•</h1><p>åœ¨ <code>methodlist</code> æ–¹æ³•ä¸»è¦æ˜¯å°† <code>åˆ†ç±»æ·»åŠ åˆ°ä¸»ç±»</code> ä¸­ï¼Œå…¶æºç å®ç°å¦‚ä¸‹ï¼š</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">void attachToClass(Class cls, Class previously, int flags)</span><br><span class="line">&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line">    ASSERT((flags &amp; ATTACH_CLASS) ||</span><br><span class="line">           (flags &amp; ATTACH_METACLASS) ||</span><br><span class="line">           (flags &amp; ATTACH_CLASS_AND_METACLASS));</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    const char *mangledName  = cls-&gt;mangledName();</span><br><span class="line">    const char *LGPersonName = &quot;LGPerson&quot;;</span><br><span class="line"></span><br><span class="line">    if (strcmp(mangledName, LGPersonName) == 0) &#123;</span><br><span class="line">        bool kc_isMeta = cls-&gt;isMetaClass();</span><br><span class="line">        auto kc_rw = cls-&gt;data();</span><br><span class="line">        auto kc_ro = kc_rw-&gt;ro();</span><br><span class="line">        if (!kc_isMeta) &#123;</span><br><span class="line">            printf(&quot;%s: è¿™ä¸ªæ˜¯æˆ‘è¦ç ”ç©¶çš„ %s \n&quot;,__func__,LGPersonName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    auto &amp;map = get();</span><br><span class="line">    auto it = map.find(previously); // æ‰¾åˆ°ä¸€ä¸ªåˆ†ç±»è¿›æ¥ä¸€æ¬¡ï¼Œå³ä¸€ä¸ªä¸ªåŠ è½½åˆ†ç±»ï¼Œä¸è¦æ··ä¹±</span><br><span class="line"></span><br><span class="line">    if (it != map.end()) &#123; // è¿™é‡Œä¼šèµ°è¿›æ¥ï¼šå½“ä¸»ç±»æ²¡æœ‰å®ç°loadï¼Œåˆ†ç±»å¼€å§‹åŠ è½½ï¼Œè¿«ä½¿ä¸»ç±»åŠ è½½ï¼Œä¼šèµ°åˆ°ifæµç¨‹é‡Œé¢</span><br><span class="line">        category_list &amp;list = it-&gt;second;</span><br><span class="line">        if (flags &amp; ATTACH_CLASS_AND_METACLASS) &#123; // åˆ¤æ–­æ˜¯å¦æ˜¯å…ƒç±»</span><br><span class="line">            int otherFlags = flags &amp; ~ATTACH_CLASS_AND_METACLASS;</span><br><span class="line">            attachCategories(cls, list.array(), list.count(), otherFlags | ATTACH_CLASS); // å®ä¾‹æ–¹æ³•</span><br><span class="line">            attachCategories(cls-&gt;ISA(), list.array(), list.count(), otherFlags | ATTACH_METACLASS); // ç±»æ–¹æ³•</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // å¦‚æœä¸æ˜¯å…ƒç±»ï¼Œåˆ™åªèµ°ä¸€æ¬¡ attachCategories</span><br><span class="line">            attachCategories(cls, list.array(), list.count(), flags);</span><br><span class="line">        &#125;</span><br><span class="line">        map.erase(it);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å› ä¸º <code>attachToClass</code> ä¸­çš„å¤–éƒ¨å¾ªç¯æ˜¯æ‰¾åˆ°ä¸€ä¸ªåˆ†ç±»å°±ä¼šè¿›åˆ° <code>attachCategories</code> ä¸€æ¬¡ï¼Œå³æ‰¾ä¸€ä¸ªå°±å¾ªç¯ä¸€æ¬¡</p>
<h1 id="attachCategoriesæ–¹æ³•"><a href="#attachCategoriesæ–¹æ³•" class="headerlink" title="attachCategoriesæ–¹æ³•"></a>attachCategoriesæ–¹æ³•</h1><p>åœ¨ <code>attachCategories</code> æ–¹æ³•ä¸­å‡†å¤‡åˆ†ç±»çš„æ•°æ®ï¼Œå…¶æºç å®ç°å¦‚ä¸‹ï¼š</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">static void</span><br><span class="line">attachCategories(Class cls, const locstamped_category_t *cats_list, uint32_t cats_count,</span><br><span class="line">                 int flags)</span><br><span class="line">&#123;</span><br><span class="line">    if (slowpath(PrintReplacedMethods)) &#123;</span><br><span class="line">        printReplacements(cls, cats_list, cats_count);</span><br><span class="line">    &#125;</span><br><span class="line">    if (slowpath(PrintConnecting)) &#123;</span><br><span class="line">        _objc_inform(&quot;CLASS: attaching %d categories to%s class &#x27;%s&#x27;%s&quot;,</span><br><span class="line">                     cats_count, (flags &amp; ATTACH_EXISTING) ? &quot; existing&quot; : &quot;&quot;,</span><br><span class="line">                     cls-&gt;nameForLogging(), (flags &amp; ATTACH_METACLASS) ? &quot; (meta)&quot; : &quot;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * Only a few classes have more than 64 categories during launch.</span><br><span class="line">     * This uses a little stack, and avoids malloc.</span><br><span class="line">     *</span><br><span class="line">     * Categories must be added in the proper order, which is back</span><br><span class="line">     * to front. To do that with the chunking, we iterate cats_list</span><br><span class="line">     * from front to back, build up the local buffers backwards,</span><br><span class="line">     * and call attachLists on the chunks. attachLists prepends the</span><br><span class="line">     * lists, so the final result is in the expected order.</span><br><span class="line">     */</span><br><span class="line">    constexpr uint32_t ATTACH_BUFSIZ = 64;</span><br><span class="line">    method_list_t   *mlists[ATTACH_BUFSIZ];</span><br><span class="line">    property_list_t *proplists[ATTACH_BUFSIZ];</span><br><span class="line">    protocol_list_t *protolists[ATTACH_BUFSIZ];</span><br><span class="line"></span><br><span class="line">    uint32_t mcount = 0;</span><br><span class="line">    uint32_t propcount = 0;</span><br><span class="line">    uint32_t protocount = 0;</span><br><span class="line">    bool fromBundle = NO;</span><br><span class="line">    bool isMeta = (flags &amp; ATTACH_METACLASS);</span><br><span class="line">    /*</span><br><span class="line">     rweçš„åˆ›å»ºï¼Œ</span><br><span class="line">     é‚£ä¹ˆä¸ºä»€ä¹ˆè¦åœ¨è¿™é‡Œè¿›è¡Œ`rweçš„åˆå§‹åŒ–`ï¼Ÿå› ä¸ºæˆ‘ä»¬ç°åœ¨è¦åšä¸€ä»¶äº‹ï¼šå¾€`æœ¬ç±»`ä¸­`æ·»åŠ å±æ€§ã€æ–¹æ³•ã€åè®®`ç­‰</span><br><span class="line">     */</span><br><span class="line">    auto rwe = cls-&gt;data()-&gt;extAllocIfNeeded();</span><br><span class="line">        </span><br><span class="line">    // mlists æ˜¯ä¸€ä¸ªäºŒç»´æ•°ç»„</span><br><span class="line">    for (uint32_t i = 0; i &lt; cats_count; i++) &#123;</span><br><span class="line">        auto&amp; entry = cats_list[i];</span><br><span class="line"></span><br><span class="line">        method_list_t *mlist = entry.cat-&gt;methodsForMeta(isMeta);</span><br><span class="line">        if (mlist) &#123;</span><br><span class="line">            if (mcount == ATTACH_BUFSIZ) &#123;//mcount = 0ï¼ŒATTACH_BUFSIZ= 64ï¼Œä¸ä¼šèµ°åˆ°ifé‡Œé¢çš„æµç¨‹</span><br><span class="line">                prepareMethodLists(cls, mlists, mcount, NO, fromBundle);//å‡†å¤‡æ’åº</span><br><span class="line">                rwe-&gt;methods.attachLists(mlists, mcount);</span><br><span class="line">                mcount = 0;</span><br><span class="line">            &#125;</span><br><span class="line">            mlists[ATTACH_BUFSIZ - ++mcount] = mlist;</span><br><span class="line">            fromBundle |= entry.hi-&gt;isBundle();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        property_list_t *proplist =</span><br><span class="line">            entry.cat-&gt;propertiesForMeta(isMeta, entry.hi);</span><br><span class="line">        if (proplist) &#123;</span><br><span class="line">            if (propcount == ATTACH_BUFSIZ) &#123;</span><br><span class="line">                rwe-&gt;properties.attachLists(proplists, propcount);</span><br><span class="line">                propcount = 0;</span><br><span class="line">            &#125;</span><br><span class="line">            proplists[ATTACH_BUFSIZ - ++propcount] = proplist;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        protocol_list_t *protolist = entry.cat-&gt;protocolsForMeta(isMeta);</span><br><span class="line">        if (protolist) &#123;</span><br><span class="line">            if (protocount == ATTACH_BUFSIZ) &#123;</span><br><span class="line">                rwe-&gt;protocols.attachLists(protolists, protocount);</span><br><span class="line">                protocount = 0;</span><br><span class="line">            &#125;</span><br><span class="line">            protolists[ATTACH_BUFSIZ - ++protocount] = protolist;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (mcount &gt; 0) &#123;</span><br><span class="line">        prepareMethodLists(cls, mlists + ATTACH_BUFSIZ - mcount, mcount, NO, fromBundle);//æ’åº</span><br><span class="line">        rwe-&gt;methods.attachLists(mlists + ATTACH_BUFSIZ - mcount, mcount);//mlists + ATTACH_BUFSIZ - mcount ä¸ºå†…å­˜å¹³ç§»</span><br><span class="line">        if (flags &amp; ATTACH_EXISTING) flushCaches(cls);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rwe-&gt;properties.attachLists(proplists + ATTACH_BUFSIZ - propcount, propcount);</span><br><span class="line"></span><br><span class="line">    rwe-&gt;protocols.attachLists(protolists + ATTACH_BUFSIZ - protocount, protocount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li><p>åœ¨ <code>auto rwe = cls-&gt;data()-&gt;extAllocIfNeeded();</code> æ˜¯è¿›è¡Œ <code>rwe</code> çš„åˆ›å»º,é‚£ä¹ˆä¸ºä»€ä¹ˆè¦åœ¨è¿™é‡Œè¿›è¡Œ <code>rwe</code> çš„åˆå§‹åŒ–ï¼Ÿï¼Ÿå› ä¸ºæˆ‘ä»¬ç°åœ¨è¦åšä¸€ä»¶äº‹ï¼š<code>å¾€æœ¬ç±»ä¸­æ·»åŠ å±æ€§ã€æ–¹æ³•ã€åè®®ç­‰</code>,å³å¯¹åŸæ¥çš„ <code>clean memory</code> è¦è¿›è¡Œå¤„ç†äº†</p>
<ul>
<li><p>è¿›å…¥ <code>extAllocIfNeeded</code> æ–¹æ³•çš„æºç å®ç°ï¼Œåˆ¤æ–­ <code>rwe</code> æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™ç›´æ¥è·å–ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å¼€è¾Ÿ</p>
</li>
<li><p>è¿›å…¥ <code>extAlloc</code> æºç å®ç°ï¼Œå³å¯¹ <code>rwe 0-1</code> çš„è¿‡ç¨‹ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œå°±å°†æœ¬ç±»çš„ <code>data</code> æ•°æ®åŠ è½½è¿›å»äº†</p>
</li>
</ul>
</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">class_rw_ext_t *extAllocIfNeeded() &#123;</span><br><span class="line">    auto v = get_ro_or_rwe();</span><br><span class="line">    if (fastpath(v.is&lt;class_rw_ext_t *&gt;())) &#123; //åˆ¤æ–­rweæ˜¯å¦å­˜åœ¨</span><br><span class="line">        return v.get&lt;class_rw_ext_t *&gt;();//å¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥è·å–</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return extAlloc(v.get&lt;const class_ro_t *&gt;());//å¦‚æœä¸å­˜åœ¨åˆ™è¿›è¡Œå¼€è¾Ÿ</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ğŸ‘‡//extAllocæºç å®ç°</span><br><span class="line">class_rw_ext_t *</span><br><span class="line">class_rw_t::extAlloc(const class_ro_t *ro, bool deepCopy)</span><br><span class="line">&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line">    //æ­¤æ—¶åªæœ‰rwï¼Œéœ€è¦å¯¹rweè¿›è¡Œæ•°æ®æ·»åŠ ï¼Œå³0-1çš„è¿‡ç¨‹</span><br><span class="line">    auto rwe = objc::zalloc&lt;class_rw_ext_t&gt;();//åˆ›å»º</span><br><span class="line">    </span><br><span class="line">    rwe-&gt;version = (ro-&gt;flags &amp; RO_META) ? 7 : 0;</span><br><span class="line"></span><br><span class="line">    method_list_t *list = ro-&gt;baseMethods();</span><br><span class="line">    if (list) &#123;</span><br><span class="line">        if (deepCopy) list = list-&gt;duplicate();</span><br><span class="line">        rwe-&gt;methods.attachLists(&amp;list, 1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // See comments in objc_duplicateClass</span><br><span class="line">    // property lists and protocol lists historically</span><br><span class="line">    // have not been deep-copied</span><br><span class="line">    //</span><br><span class="line">    // This is probably wrong and ought to be fixed some day</span><br><span class="line">    property_list_t *proplist = ro-&gt;baseProperties;</span><br><span class="line">    if (proplist) &#123;</span><br><span class="line">        rwe-&gt;properties.attachLists(&amp;proplist, 1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protocol_list_t *protolist = ro-&gt;baseProtocols;</span><br><span class="line">    if (protolist) &#123;</span><br><span class="line">        rwe-&gt;protocols.attachLists(&amp;protolist, 1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    set_ro_or_rwe(rwe, ro);</span><br><span class="line">    return rwe;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li><p>å…¶ä¸­å…³é”®ä»£ç æ˜¯ <code>rwe-&gt;methods.attachLists(mlists + ATTACH_BUFSIZ - mcount, mcount);</code> å³å­˜å…¥mlistsçš„æœ«å°¾ï¼Œmlistsçš„æ•°æ®æ¥æºå‰é¢çš„forå¾ªç¯</p>
</li>
<li><p>åœ¨è°ƒè¯•è¿è¡Œæ—¶ï¼Œå‘ç° <code>category_t</code> ä¸­çš„ <code>name</code> ç¼–è¯‘æ—¶æ˜¯ <code>LGPerson</code>ï¼ˆå‚è€ƒclangç¼–è¯‘æ—¶çš„é‚£ä¹ˆï¼‰ï¼Œè¿è¡Œæ—¶æ˜¯ <code>LGA</code> å³åˆ†ç±»çš„åå­—</p>
</li>
<li><p>ä»£ç  <code>mlists[ATTACH_BUFSIZ - ++mcount] = mlist;</code>ï¼Œç»è¿‡è°ƒè¯•å‘ç°æ­¤æ—¶çš„ <code>mcount</code> ç­‰äº <code>1</code>ï¼Œå³å¯ä»¥ç†è§£ä¸º <code>å€’åºæ’å…¥</code>,<code>64</code> çš„åŸå› æ˜¯å…è®¸å®¹çº³64ä¸ªï¼ˆæœ€å¤š64ä¸ªåˆ†ç±»ï¼‰</p>
</li>
</ul>
<blockquote>
<p>æ€»ç»“: <code>æœ¬ç±»</code> ä¸­ <code>éœ€è¦æ·»åŠ å±æ€§ã€æ–¹æ³•ç­‰</code>ï¼Œæ‰€ä»¥éœ€è¦ <code>åˆå§‹åŒ–rwe</code>,rweçš„åˆå§‹åŒ–ä¸»è¦æ¶‰åŠï¼š<code>åˆ†ç±»ã€addMethodã€addPropertyã€addprotocol</code> ï¼Œ å³å¯¹åŸå§‹ç±»è¿›è¡Œä¿®æ”¹æˆ–è€…å¤„ç†æ—¶ï¼Œæ‰ä¼šè¿›è¡Œrweçš„åˆå§‹åŒ–</p>
</blockquote>
<h1 id="attachListsæ–¹æ³•ï¼šæ’å…¥"><a href="#attachListsæ–¹æ³•ï¼šæ’å…¥" class="headerlink" title="attachListsæ–¹æ³•ï¼šæ’å…¥"></a>attachListsæ–¹æ³•ï¼šæ’å…¥</h1><ul>
<li>å…¶ä¸­ <code>æ–¹æ³•ã€å±æ€§</code> ç»§æ‰¿äº <code>entsize_list_tt</code>ï¼Œ<code>åè®®</code> åˆ™æ˜¯ç±»ä¼¼ <code>entsize_list_tt</code> å®ç°ï¼Œéƒ½æ˜¯ <code>äºŒç»´æ•°ç»„</code></li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">struct method_list_t : entsize_list_tt&lt;method_t, method_list_t, 0x3&gt; </span><br><span class="line"></span><br><span class="line">struct property_list_t : entsize_list_tt&lt;property_t, property_list_t, 0&gt; </span><br><span class="line"></span><br><span class="line">struct protocol_list_t &#123;</span><br><span class="line">    // count is pointer-sized by accident.</span><br><span class="line">    uintptr_t count;</span><br><span class="line">    protocol_ref_t list[0]; // variable-size</span><br><span class="line"></span><br><span class="line">    size_t byteSize() const &#123;</span><br><span class="line">        return sizeof(*this) + count*sizeof(list[0]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protocol_list_t *duplicate() const &#123;</span><br><span class="line">        return (protocol_list_t *)memdup(this, this-&gt;byteSize());</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>è¿›å…¥ <code>attachLists</code> æ–¹æ³•çš„æºç å®ç°</li>
</ul>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">void attachLists(List* const * addedLists, uint32_t addedCount) &#123;</span><br><span class="line">    if (addedCount == 0) return;</span><br><span class="line"></span><br><span class="line">    if (hasArray()) &#123;</span><br><span class="line">        // many lists -&gt; many lists</span><br><span class="line">        // è®¡ç®—æ•°ç»„ä¸­æ—§listsçš„å¤§å°</span><br><span class="line">        uint32_t oldCount = array()-&gt;count;</span><br><span class="line">        // è®¡ç®—æ–°çš„å®¹é‡å¤§å° = æ—§æ•°æ®å¤§å°+æ–°æ•°æ®å¤§å°</span><br><span class="line">        uint32_t newCount = oldCount + addedCount;</span><br><span class="line">        // æ ¹æ®æ–°çš„å®¹é‡å¤§å°ï¼Œå¼€è¾Ÿä¸€ä¸ªæ•°ç»„ï¼Œç±»å‹æ˜¯ array_tï¼Œé€šè¿‡array()è·å–</span><br><span class="line">        setArray((array_t *)realloc(array(), array_t::byteSize(newCount)));</span><br><span class="line">        // è®¾ç½®æ•°ç»„å¤§å°</span><br><span class="line">        array()-&gt;count = newCount;</span><br><span class="line">        // æ—§çš„æ•°æ®ä» addedCount æ•°ç»„ä¸‹æ ‡å¼€å§‹ å­˜æ”¾æ—§çš„listsï¼Œå¤§å°ä¸º æ—§æ•°æ®å¤§å° * å•ä¸ªæ—§listå¤§å°</span><br><span class="line">        memmove(array()-&gt;lists + addedCount, array()-&gt;lists, </span><br><span class="line">                oldCount * sizeof(array()-&gt;lists[0]));</span><br><span class="line">        // æ–°æ•°æ®ä»æ•°ç»„ é¦–ä½ç½®å¼€å§‹å­˜å‚¨ï¼Œå­˜æ”¾æ–°çš„listsï¼Œå¤§å°ä¸º æ–°æ•°æ®å¤§å° * å•ä¸ªlistå¤§å°</span><br><span class="line">        memcpy(</span><br><span class="line">               array()-&gt;lists, addedLists, </span><br><span class="line">               addedCount * sizeof(array()-&gt;lists[0]));</span><br><span class="line">    &#125;</span><br><span class="line">    else if (!list  &amp;&amp;  addedCount == 1) &#123;</span><br><span class="line">        // 0 lists -&gt; 1 list</span><br><span class="line">        // å°†liståŠ å…¥mlistsçš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæ­¤æ—¶çš„listæ˜¯ä¸€ä¸ªä¸€ç»´æ•°ç»„</span><br><span class="line">        list = addedLists[0];</span><br><span class="line">    &#125; </span><br><span class="line">    else &#123;</span><br><span class="line">        // 1 list -&gt; many lists æœ‰äº†ä¸€ä¸ªlistï¼Œæœ‰å¾€é‡ŒåŠ å¾ˆå¤šlist</span><br><span class="line">        // æ–°çš„listå°±æ˜¯åˆ†ç±»ï¼Œæ¥è‡ªLRUçš„ç®—æ³•æ€ç»´ï¼Œå³æœ€è¿‘æœ€å°‘ä½¿ç”¨</span><br><span class="line">        // è·å–æ—§çš„list</span><br><span class="line">        List* oldList = list;</span><br><span class="line">        uint32_t oldCount = oldList ? 1 : 0;</span><br><span class="line">        // è®¡ç®—å®¹é‡å’Œ = æ—§listä¸ªæ•°+æ–°listsçš„ä¸ªæ•°</span><br><span class="line">        uint32_t newCount = oldCount + addedCount;</span><br><span class="line">        // å¼€è¾Ÿä¸€ä¸ªå®¹é‡å’Œå¤§å°çš„é›†åˆï¼Œç±»å‹æ˜¯ array_tï¼Œå³åˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œæ”¾åˆ°arrayä¸­ï¼Œé€šè¿‡array()è·å–</span><br><span class="line">        setArray((array_t *)malloc(array_t::byteSize(newCount)));</span><br><span class="line">        // è®¾ç½®æ•°ç»„çš„å¤§å°</span><br><span class="line">        array()-&gt;count = newCount;</span><br><span class="line">        // åˆ¤æ–­oldæ˜¯å¦å­˜åœ¨ï¼Œoldè‚¯å®šæ˜¯å­˜åœ¨çš„ï¼Œå°†æ—§çš„listæ”¾å…¥åˆ°æ•°ç»„çš„æœ«å°¾</span><br><span class="line">        if (oldList) array()-&gt;lists[addedCount] = oldList;</span><br><span class="line">        // memcpyï¼ˆå¼€å§‹ä½ç½®ï¼Œæ”¾ä»€ä¹ˆï¼Œæ”¾å¤šå¤§ï¼‰ æ˜¯å†…å­˜å¹³ç§»ï¼Œä»æ•°ç»„èµ·å§‹ä½ç½®å­˜å…¥æ–°çš„list</span><br><span class="line">        // å…¶ä¸­array()-&gt;lists è¡¨ç¤ºé¦–ä½å…ƒç´ ä½ç½®</span><br><span class="line">        memcpy(array()-&gt;lists, addedLists, </span><br><span class="line">               addedCount * sizeof(array()-&gt;lists[0]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä»æºç å¯ä»¥å¾—çŸ¥ï¼Œ<code>æ’å…¥è¡¨</code> ä¸»è¦åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š</p>
<ul>
<li><p>ã€æƒ…å†µ1ï¼šå¤šå¯¹å¤šã€‘å¦‚æœå½“å‰è°ƒç”¨ <code>attachLists</code> çš„ <code>list_array_tt</code> äºŒç»´æ•°ç»„ä¸­æœ‰å¤šä¸ªä¸€ç»´æ•°ç»„</p>
<ul>
<li><p>è®¡ç®—æ•°ç»„ä¸­æ—§ <code>lists</code> çš„å¤§å°</p>
</li>
<li><p>è®¡ç®—æ–°çš„å®¹é‡å¤§å° &#x3D; æ—§æ•°æ®å¤§å°+æ–°æ•°æ®å¤§å°</p>
</li>
<li><p>æ ¹æ®æ–°çš„å®¹é‡å¤§å°ï¼Œå¼€è¾Ÿä¸€ä¸ªæ•°ç»„ï¼Œç±»å‹æ˜¯ <code>array_t</code>ï¼Œé€šè¿‡ <code>array()</code> è·å–</p>
</li>
<li><p>è®¾ç½®æ•°ç»„å¤§å°</p>
</li>
<li><p>æ—§çš„æ•°æ®ä» addedCount æ•°ç»„ä¸‹æ ‡å¼€å§‹ å­˜æ”¾æ—§çš„listsï¼Œå¤§å°ä¸º æ—§æ•°æ®å¤§å° * å•ä¸ªæ—§listå¤§å°ï¼Œå³æ•´æ®µå¹³ç§»ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºåŸæ¥çš„æ•°æ®ç§»åŠ¨åˆ°åé¢ï¼Œå³æŒ‡é’ˆåç§»</p>
</li>
<li><p>æ–°æ•°æ®ä»æ•°ç»„ é¦–ä½ç½®å¼€å§‹å­˜å‚¨ï¼Œå­˜æ”¾æ–°çš„listsï¼Œå¤§å°ä¸º æ–°æ•°æ®å¤§å° * å•ä¸ªlistå¤§å°ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºè¶Šæ™šåŠ è¿›æ¥ï¼Œè¶Šåœ¨å‰é¢ï¼Œè¶Šåœ¨å‰é¢ï¼Œè°ƒç”¨æ—¶åˆ™ä¼˜å…ˆè°ƒç”¨</p>
</li>
</ul>
</li>
<li><p>ã€æƒ…å†µ2ï¼š0å¯¹ä¸€ã€‘å¦‚æœè°ƒç”¨ <code>attachLists</code> çš„ <code>list_array_tt</code> äºŒç»´æ•°ç»„ä¸ºç©ºä¸”æ–°å¢å¤§å°æ•°ç›®ä¸º <code>1</code></p>
<ul>
<li>ç›´æ¥èµ‹å€¼ <code>addedList</code> çš„ <code>ç¬¬ä¸€ä¸ªlist</code></li>
</ul>
</li>
<li><p>ã€æƒ…å†µ3ï¼šä¸€å¯¹å¤šã€‘å¦‚æœå½“å‰è°ƒç”¨ <code>attachLists</code> çš„ <code>list_array_tt</code> äºŒç»´æ•°ç»„åªæœ‰ä¸€ä¸ªä¸€ç»´æ•°ç»„</p>
<ul>
<li><p>è·å–æ—§çš„list</p>
</li>
<li><p>è®¡ç®— <code>å®¹é‡å’Œ = æ—§listä¸ªæ•°+æ–°listsçš„ä¸ªæ•°</code></p>
</li>
<li><p>å¼€è¾Ÿä¸€ä¸ªå®¹é‡å’Œå¤§å°çš„é›†åˆï¼Œç±»å‹æ˜¯ <code>array_t</code>ï¼Œå³åˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œæ”¾åˆ° <code>array</code> ä¸­ï¼Œé€šè¿‡<code>array()</code> è·å–</p>
</li>
<li><p>è®¾ç½®æ•°ç»„çš„å¤§å°</p>
</li>
<li><p>åˆ¤æ–­oldæ˜¯å¦å­˜åœ¨ï¼Œoldè‚¯å®šæ˜¯å­˜åœ¨çš„ï¼Œå°† <code>æ—§çš„listæ”¾å…¥åˆ°æ•°ç»„çš„æœ«å°¾</code></p>
</li>
<li><p><code>memcpyï¼ˆå¼€å§‹ä½ç½®ï¼Œæ”¾ä»€ä¹ˆï¼Œæ”¾å¤šå¤§ï¼‰</code> æ˜¯ <code>å†…å­˜å¹³ç§»</code>ï¼Œä»æ•°ç»„ <code>èµ·å§‹ä½ç½®å¼€å§‹å­˜å…¥æ–°çš„list</code>ï¼Œå…¶ä¸­ <code>array()-&gt;lists</code> è¡¨ç¤ºé¦–ä½å…ƒç´ ä½ç½®</p>
</li>
</ul>
</li>
</ul>
<p>é’ˆå¯¹ <code>æƒ…å†µ3</code>ï¼Œè¿™é‡Œçš„listsæ˜¯æŒ‡ <code>åˆ†ç±»</code></p>
<ul>
<li><p>è¿™æ˜¯æ—¥å¸¸å¼€å‘ä¸­ï¼Œä¸ºä»€ä¹ˆ <code>å­ç±»å®ç°çˆ¶ç±»æ–¹æ³•ä¼šæŠŠçˆ¶ç±»æ–¹æ³•è¦†ç›–</code> çš„åŸå› </p>
</li>
<li><p>åŒç†ï¼Œå¯¹äºåŒåæ–¹æ³•ï¼Œ<code>åˆ†ç±»æ–¹æ³•è¦†ç›–ç±»æ–¹æ³•</code> çš„åŸå› </p>
</li>
<li><p>è¿™ä¸ªæ“ä½œæ¥è‡ªä¸€ä¸ªç®—æ³•æ€ç»´ <code>LRUå³æœ€è¿‘æœ€å°‘ä½¿ç”¨</code>ï¼Œ<code>åŠ è¿™ä¸ªnewlistçš„ç›®çš„æ˜¯ç”±äºè¦ä½¿ç”¨è¿™ä¸ªnewlistä¸­çš„æ–¹æ³•</code>ï¼Œè¿™ä¸ª <code>newlist</code> å¯¹äºç”¨æˆ·çš„ä»·å€¼è¦é«˜ï¼Œå³ä¼˜å…ˆè°ƒç”¨</p>
</li>
<li><p>ä¼šæ¥åˆ° <code>1å¯¹å¤š</code> çš„åŸå›  ï¼Œä¸»è¦æ˜¯ <code>æœ‰åˆ†ç±»çš„æ·»åŠ </code>ï¼Œå³æ—§çš„å…ƒç´ åœ¨åé¢ï¼Œæ–°çš„å…ƒç´ åœ¨å‰é¢ ï¼Œç©¶å…¶æ ¹æœ¬åŸå› ä¸»è¦æ˜¯ <code>ä¼˜å…ˆè°ƒç”¨category</code>ï¼Œè¿™ä¹Ÿæ˜¯åˆ†ç±»çš„æ„ä¹‰æ‰€åœ¨</p>
</li>
</ul>
<h1 id="memmoveå’Œmemcpyçš„åŒºåˆ«"><a href="#memmoveå’Œmemcpyçš„åŒºåˆ«" class="headerlink" title="memmoveå’Œmemcpyçš„åŒºåˆ«"></a>memmoveå’Œmemcpyçš„åŒºåˆ«</h1><ul>
<li><p>åœ¨ä¸çŸ¥é“éœ€è¦å¹³ç§»çš„å†…å­˜å¤§å°æ—¶ï¼Œéœ€è¦ <code>memmove</code> è¿›è¡Œå†…å­˜å¹³ç§»ï¼Œä¿è¯å®‰å…¨</p>
</li>
<li><p><code>memcpy</code> ä»åŸå†…å­˜åœ°å€çš„èµ·å§‹ä½ç½®å¼€å§‹æ‹·è´è‹¥å¹²ä¸ªå­—èŠ‚åˆ°ç›®æ ‡å†…å­˜åœ°å€ä¸­ï¼Œ<code>é€Ÿåº¦å¿«</code></p>
</li>
</ul>
<h1 id="rwe-æ•°æ®åŠ è½½"><a href="#rwe-æ•°æ®åŠ è½½" class="headerlink" title="rwe æ•°æ®åŠ è½½"></a>rwe æ•°æ®åŠ è½½</h1><p><strong>rwe â€“ æœ¬ç±»çš„æ•°æ®åŠ è½½ã€é‡ç‚¹ï¼ï¼ï¼ã€‘</strong></p>
<p>ä¸‹é¢é€šè¿‡è°ƒè¯•æ¥éªŒè¯ <code>rweæ•°æ®0-1çš„è¿‡ç¨‹</code>ï¼Œå³ <code>æ·»åŠ ç±»çš„æ–¹æ³•åˆ—è¡¨</code></p>
<ul>
<li><p>åœ¨ <code>attachCategories -&gt; extAllocIfNeeded -&gt; extAlloc</code> å¢åŠ è‡ªå®šä¹‰é€»è¾‘ï¼Œè¿è¡Œï¼Œå¹¶æ–­ä½ï¼Œä»å †æ ˆä¿¡æ¯å¯ä»¥çœ‹å‡ºæ˜¯ä» <code>attachCategories</code> æ–¹æ³•ä¸­ <code>auto rwe = cls-&gt;data()-&gt;extAllocIfNeeded();</code> è¿‡æ¥çš„ï¼Œè¿™é‡Œçš„ä½œç”¨æ˜¯ <code>å¼€è¾Ÿrwe</code>ï¼Œ</p>
<ul>
<li><p>é‚£ä¹ˆä¸ºä»€ä¹ˆè¦åœ¨è¿™é‡Œè¿›è¡Œ <code>rweçš„åˆå§‹åŒ–</code>ï¼Ÿå› ä¸ºæˆ‘ä»¬ç°åœ¨è¦åšä¸€ä»¶äº‹ï¼šå¾€ <code>æœ¬ç±»</code> ä¸­ <code>æ·»åŠ å±æ€§ã€æ–¹æ³•ã€åè®®ç­‰</code>,å³å¯¹åŸæ¥çš„ <code>clean memory</code> è¦è¿›è¡Œå¤„ç†äº†</p>
</li>
<li><p><code>rwe</code> æ˜¯åœ¨ <code>åˆ†ç±»å¤„ç†</code> æ—¶æ‰ä¼šè¿›è¡Œå¤„ç†ï¼Œå³rweåˆå§‹åŒ–ï¼Œä¸”æœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ä¼šæ¶‰åŠrweçš„åˆå§‹åŒ– ï¼Œåˆ†åˆ«æ˜¯ï¼š<code>åˆ†ç±» + addMethod + addPro + addProtocol</code></p>
</li>
</ul>
</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071659349.png"
                     
                ></p>
<ul>
<li><code>p rwe</code></li>
<li><code>p *$0</code> , æ­¤æ—¶çš„ <code>rwe</code> ä¸­çš„ <code>list_array_tt</code> æ˜¯ç©ºçš„</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071700969.png"
                     
                ></p>
<ul>
<li><p>ç»§ç»­å¾€ä¸‹æ‰§è¡Œåˆ°if (list) {æ–­ä½</p>
<ul>
<li><code>p list</code></li>
<li><code>p *$2</code> ï¼Œæ­¤æ—¶çš„ <code>list</code> æ˜¯ <code>LGPerson</code> æœ¬ç±»çš„æ–¹æ³•åˆ—è¡¨</li>
</ul>
</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071701893.png"
                     
                ></p>
<ul>
<li>åœ¨ <code>attachLists</code> æ–¹æ³•ä¸­çš„ <code>if (hasArray()) &#123;</code> å¤„è®¾ç½®æ–­ç‚¹ï¼Œå¹¶è¿è¡Œæ–­ä½ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œä¼šèµ°åˆ° else-ifæµç¨‹ï¼Œå³0å¯¹1 â€“ <code>LGPersonæœ¬ç±»çš„æ–¹æ³•åˆ—è¡¨çš„æ·»åŠ </code> ä¼šèµ° <code>0å¯¹1æµç¨‹</code></li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071702247.png"
                     
                ></p>
<ul>
<li><code>p addedLists</code> ï¼Œæ­¤æ—¶æ˜¯ä¸€ä¸ªlistæŒ‡é’ˆçš„åœ°å€ï¼Œç»™äº† <code>mlists</code> çš„ç¬¬ä¸€ä¸ªå…ƒç´ , ç±»å‹æ˜¯<code>method_list_t *const *</code></li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071702033.png"
                     
                ></p>
<ul>
<li><code>p addedLists[0]</code></li>
<li><code>p *$5</code></li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071703598.png"
                     
                ></p>
<ul>
<li><code>p addedLists[1]</code></li>
<li><code>p *$7</code> ,ä¹Ÿä¼šæœ‰å€¼ï¼Œä¸»è¦æ˜¯å› ä¸ºå†…å­˜æ˜¯è¿ç»­çš„ï¼Œè®¿é—®çš„æ˜¯åˆ«äººçš„</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071703432.png"
                     
                ></p>
<blockquote>
<p>æ€»ç»“ ï¼šæ‰€ä»¥ <code>0å¯¹1</code> æ˜¯ä¸€ç§ <code>ä¸€ç»´èµ‹å€¼</code>ï¼Œå‡½æ•°è·¯å¾„ä¸ºï¼š<code>map_images -&gt; _read_images -&gt;readClass -&gt; realizeClassWithoutSwift -&gt; methodizeClass -&gt; prepareMethodLists -&gt; fixupMethodList -&gt; attachToClass -&gt; load_categories_nolock -&gt; attachCategories -&gt; extAllocIfNeeded -&gt; extAlloc -&gt; attachLists</code></p>
</blockquote>
<h1 id="rwe-â€“-LGAåˆ†ç±»æ•°æ®åŠ è½½ã€é‡ç‚¹ï¼ï¼ï¼ã€‘"><a href="#rwe-â€“-LGAåˆ†ç±»æ•°æ®åŠ è½½ã€é‡ç‚¹ï¼ï¼ï¼ã€‘" class="headerlink" title="rwe â€“ LGAåˆ†ç±»æ•°æ®åŠ è½½ã€é‡ç‚¹ï¼ï¼ï¼ã€‘"></a>rwe â€“ LGAåˆ†ç±»æ•°æ®åŠ è½½ã€é‡ç‚¹ï¼ï¼ï¼ã€‘</h1><ul>
<li><p>ç»§ç»­æ‰§è¡Œä¸€æ­¥ï¼Œæ‰“å°list</p>
<ul>
<li><code>p list</code> ï¼Œæ­¤æ—¶çš„listæ˜¯ <code>method_list_t</code> ç»“æ„</li>
</ul>
</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071705570.png"
                     
                ></p>
<ul>
<li><p>æ¥ä¸Šé¢ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œèµ°åˆ° <code>method_list_t *mlist = entry.cat-&gt;methodsForMeta(isMeta);</code>ï¼Œ</p>
<ul>
<li>p mlist</li>
<li>p *$10 ï¼Œæ­¤æ—¶çš„mlistæ˜¯ åˆ†ç±»LGA çš„</li>
</ul>
</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071706758.png"
                     
                ></p>
<ul>
<li>åœ¨ <code>if (mcount &gt; 0) &#123;</code> éƒ¨åˆ†åŠ æ–­ç‚¹ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œå¹¶æ–­ä½</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071706627.png"
                     
                ></p>
<ul>
<li>å¾€ä¸‹æ‰§è¡Œä¸€æ­¥ï¼Œæ­¤æ—¶çš„ <code>mlists</code> ä¸º <code>é›†åˆçš„é›†åˆ</code></li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071707173.png"
                     
                ></p>
<ul>
<li><p>å…¶ä¸­ <code>mlists + ATTACH_BUFSIZ - mcount</code> ä¸º <code>å†…å­˜å¹³ç§»</code></p>
<ul>
<li><code>p mlists + ATTACH_BUFSIZ - mcount</code> , å› ä¸ºmcount &#x3D; 1ï¼Œ ATTACH_BUFSIZ &#x3D; 64ï¼Œä»é¦–ä½å¹³ç§»åˆ°63ä½ï¼Œå³æœ€åä¸€ä¸ªå…ƒç´ </li>
<li>p *$14</li>
</ul>
</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071708333.png"
                     
                ></p>
<ul>
<li><code>p *$15</code> ,<code>mlists</code> æœ€åä¸€ä¸ªå…ƒç´ çš„ç±»å®¹ä¸º <code>æœ¬ç±»çš„æ–¹æ³•åˆ—è¡¨</code></li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071708416.png"
                     
                ></p>
<ul>
<li>è¿›å…¥ <code>attachLists</code> æ–¹æ³•ï¼Œ åœ¨ <code>if (hasArray()) &#123;</code> å¤„åŠ æ–­ç‚¹ï¼Œç»§ç»­æ‰§è¡Œï¼Œç”±äºå·²ç»æœ‰äº†ä¸€ä¸ªlistï¼Œæ‰€ä»¥ä¼šèµ°åˆ° <code>1å¯¹å¤š</code> çš„æµç¨‹</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071709402.png"
                     
                ></p>
<ul>
<li>æ‰§è¡Œåˆ°æœ€åï¼Œè¾“å‡ºå½“å‰çš„array å³ <code>p array()</code></li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071709312.png"
                     
                ></p>
<p>è¿™ä¸ª <code>list_array_tt&lt;method_t, method_list_t&gt;</code> è¡¨ç¤º arrayä¸­ä¼šæ”¾å¾ˆå¤šçš„ <code>method_list_t</code>ï¼Œmethod_list_tä¸­ä¼šæ”¾å¾ˆå¤š <code>method_t</code></p>
<blockquote>
<p>æ€»ç»“:å¦‚æœæœ¬ç±» <code>åªæœ‰ä¸€ä¸ªåˆ†ç±»</code>ï¼Œåˆ™ä¼šèµ°åˆ°æƒ…å†µ3ï¼Œå³ <code>1å¯¹å¤š</code> çš„æƒ…å†µ</p>
</blockquote>
<h1 id="rwe-â€“-LGBåˆ†ç±»æ•°æ®åŠ è½½ã€é‡ç‚¹ï¼ï¼ï¼ã€‘"><a href="#rwe-â€“-LGBåˆ†ç±»æ•°æ®åŠ è½½ã€é‡ç‚¹ï¼ï¼ï¼ã€‘" class="headerlink" title="rwe â€“ LGBåˆ†ç±»æ•°æ®åŠ è½½ã€é‡ç‚¹ï¼ï¼ï¼ã€‘"></a>rwe â€“ LGBåˆ†ç±»æ•°æ®åŠ è½½ã€é‡ç‚¹ï¼ï¼ï¼ã€‘</h1><p>å¦‚æœå†åŠ ä¸€ä¸ª <code>åˆ†ç±»LGB</code>ï¼Œèµ°åˆ°ç¬¬ä¸‰ç§æƒ…å†µï¼Œå³ <code>å¤šå¯¹å¤š</code></p>
<ul>
<li>å†æ¬¡èµ°åˆ° <code>attachCategories -- if (mcount &gt; 0) &#123;ï¼Œ</code> è¿›å…¥ <code>attachLists</code>ï¼Œèµ°åˆ° <code>å¤šå¯¹å¤š</code> çš„æƒ…å†µ</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071711162.png"
                     
                ></p>
<ul>
<li>æŸ¥çœ‹å½“å‰ <code>array</code> çš„å½¢å¼å³ <code>p array()</code></li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071711677.png"
                     
                ></p>
<ul>
<li>p $25[0]</li>
<li>p $25[1]</li>
<li>p $25[2]</li>
<li>p $26.lists[0]</li>
<li>p *$29 ,ç¬¬ä¸€ä¸ªé‡Œé¢å­˜å‚¨çš„LGBçš„æ–¹æ³•åˆ—è¡¨</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071712366.png"
                     
                ></p>
<p>å…¶è¾“å‡ºçš„é¡ºåºæ˜¯ï¼š</p>
<blockquote>
<p>æ€»ç»“ï¼š<br>ç»¼ä¸Šæ‰€è¿°ï¼Œ<code>attachLists</code> æ–¹æ³•ä¸»è¦æ˜¯å°† <code>ç±»</code> å’Œ <code>åˆ†ç±»</code> çš„æ•°æ®åŠ è½½åˆ° <code>rwe</code> ä¸­<br>é¦–å…ˆ <code>åŠ è½½æœ¬ç±»çš„dataæ•°æ®</code>ï¼Œæ­¤æ—¶çš„ <code>rweæ²¡æœ‰æ•°æ®ä¸ºç©º</code>ï¼Œèµ° <code>0å¯¹1æµç¨‹</code><br>å½“åŠ å…¥ <code>ä¸€ä¸ªåˆ†ç±»</code> æ—¶ï¼Œæ­¤æ—¶çš„ <code>rweä»…æœ‰ä¸€ä¸ªlist</code>ï¼Œå³ <code>æœ¬ç±»çš„list</code>ï¼Œèµ° <code>1å¯¹å¤šæµç¨‹</code><br>å†åŠ å…¥ä¸€ä¸ªåˆ†ç±» æ—¶ï¼Œæ­¤æ—¶çš„ <code>rweä¸­æœ‰ä¸¤ä¸ªlist</code>ï¼Œå³ <code>æœ¬ç±»+åˆ†ç±»çš„list</code>ï¼Œèµ° <code>å¤šå¯¹å¤šæµç¨‹</code></p>
</blockquote>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071714172.png"
                     
                ></p>
<h1 id="æ‡’åŠ è½½ç±»-å’Œ-éæ‡’åŠ è½½ç±»"><a href="#æ‡’åŠ è½½ç±»-å’Œ-éæ‡’åŠ è½½ç±»" class="headerlink" title="æ‡’åŠ è½½ç±» å’Œ éæ‡’åŠ è½½ç±»"></a>æ‡’åŠ è½½ç±» å’Œ éæ‡’åŠ è½½ç±»</h1><ul>
<li>åœ¨éªŒè¯æ–¹æ³•æ’åºçš„åŸºç¡€ä¸Šï¼Œç»§ç»­åœ¨ <code>rwe</code> åŠ æ–­ç‚¹ï¼Œæ­¤æ—¶ä¸ºNULL</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071715273.png"
                     
                ></p>
<ul>
<li>ç»§ç»­å¾€ä¸‹ä¸€æ­¥æ­¥æ‰§è¡Œï¼Œ<code>rwe</code> ä»ä¸º <code>NULL</code>ï¼Œä¸ä¼šèµ° <code>if</code> é‡Œé¢çš„æµç¨‹</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071716857.png"
                     
                ></p>
<p>åœ¨è¿™é‡Œï¼Œå°½ç®¡æ–¹æ³•å¤„ç†å®Œæ¯•ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ä» <code>rw</code> ä¸­å­˜å‚¨åˆ° <code>rwe</code> ä¸­ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œä»<code>data -&gt; ro -&gt; rw -&gt; çœ‹åˆ°äº†rwe</code>,å³ <code>realizeClassWithoutSwiftï¼ˆroã€rwæ“ä½œï¼‰</code>-&gt; <code>methodizeClass</code>ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰èµ°ifé‡Œé¢çš„æµç¨‹ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p>
<p>ç©¶å…¶æ ¹æœ¬åŸå› æ˜¯ <code>_read_images</code> æ–¹æ³•ä¸­çš„ç¬¬ä¹æ­¥ <code>å®ç°éæ‡’åŠ è½½ç±»</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦‚ä½•å°† <code>æ‡’åŠ è½½ç±»</code> å˜æˆ <code>éæ‡’åŠ è½½ç±»</code> çš„å‘¢?</p>
<p>ä¸»è¦æ˜¯åœ¨è¿è¡Œobjcæºç å‰ï¼Œæˆ‘ä»¬åœ¨LGPersonä¸­å®ç°äº†ä¸€ä¸ª <code>+load</code> æ–¹æ³•ï¼Œåä¹‹ï¼Œå¦‚æœå»æ‰ <code>+load</code> æ–¹æ³•ï¼Œæ˜¯æ‡’åŠ è½½ç±»ï¼Œä¸ä¼šèµ°åˆ° <code>ç¬¬ä¹æ­¥çš„forå¾ªç¯</code> ä¸­</p>
<p>æ‰€ä»¥ï¼Œç»¼ä¸Šæ‰€è¿°ï¼Œ<code>æ‡’åŠ è½½ç±»</code> å’Œ <code>éæ‡’åŠ è½½ç±»</code> çš„ <code>åŒºåˆ«</code> å°±æ˜¯ <code>æ˜¯å¦å®ç°äº†+loadæ–¹æ³•</code></p>
<ul>
<li><code>å®ç°+load</code>ï¼Œåˆ™æ˜¯ <code>éæ‡’åŠ è½½ç±»</code>ï¼Œ</li>
<li>åä¹‹ï¼Œæ˜¯ <code>æ‡’åŠ è½½ç±»</code></li>
</ul>
<p><strong>ä¸ºä»€ä¹ˆå®ç°loadæ–¹æ³•å°±ä¼šå˜æˆéæ‡’åŠ è½½ç±»ï¼Ÿ</strong></p>
<ul>
<li>ä¸»è¦æ˜¯å› ä¸º <code>load</code> ä¼š <code>æå‰åŠ è½½</code>ï¼ˆloadæ–¹æ³•ä¼šåœ¨ <code>load_images</code> è°ƒç”¨ï¼Œ<code>å‰æ</code> æ˜¯ <code>ç±»å­˜åœ¨</code>ï¼‰</li>
</ul>
<p><code>æ‡’åŠ è½½ç±»</code> åœ¨ä»€ä¹ˆæ—¶å€™ <code>åŠ è½½</code>ï¼Ÿ</p>
<ul>
<li>åœ¨ <code>è°ƒç”¨æ–¹æ³•</code> çš„æ—¶å€™åŠ è½½</li>
</ul>
<p><strong>è°ƒè¯•éªŒè¯ æ‡’åŠ è½½ç±»åŠ è½½çš„æ—¶æœº</strong></p>
<p>ä¸‹é¢é€šè¿‡ä»£ç è°ƒè¯•æ¥éªŒè¯</p>
<ul>
<li>æ³¨é‡Šæ‰LGPersonä¸­çš„ <code>+load</code> æ–¹æ³•,å¹¶åœ¨ <code>main</code> ä¸­å®ä¾‹åŒ– <code>person</code> å¤„åŠ ä¸€ä¸ªæ–­ç‚¹</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071720891.png"
                     
                ></p>
<ul>
<li>åœ¨ <code>_read_images</code> çš„ç¬¬ä¹æ­¥ forå¾ªç¯åŠ ä¸€ä¸ªæ–­ç‚¹ <code>-- readClass -- mainçš„æ–­ç‚¹å¤„</code></li>
</ul>
<p>ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œèµ°åˆ° <code>realizeClassWithoutSwift -- methodizeClass -- prepareMethodLists -- [person kc_instanceMethod1];</code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071720622.png"
                     
                ></p>
<p>å †æ ˆä¿¡æ¯éªŒè¯</p>
<p>ä¹Ÿå¯ä»¥é€šè¿‡ <code>bt</code> å †æ ˆä¿¡æ¯æŸ¥çœ‹ï¼Œæ–¹æ³•ä¸ºä»€ä¹ˆèƒ½æ¥ï¼Ÿå…¶ <code>æœ¬è´¨</code> æ˜¯å› ä¸º èµ°åˆ°<code>realizeClassWithoutSwift</code>ï¼Œå…¶æœ¬è´¨æ˜¯è°ƒç”¨ <code>alloc</code>ï¼Œå³ <code>æ¶ˆæ¯çš„å‘é€</code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071721861.png"
                     
                ></p>
<p>æ‰€ä»¥ <code>æ‡’åŠ è½½ç±»</code> å’Œ <code>éæ‡’åŠ è½½ç±»</code> çš„ <code>æ•°æ®åŠ è½½æ—¶æœº</code> å¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071722512.png"
                     
                ></p>
<p>æ€»ç»“</p>
<ul>
<li><p><code>readClass</code> ä¸»è¦æ˜¯è¯»å–ç±»ï¼Œå³æ­¤æ—¶çš„ç±»ä»…æœ‰åœ°å€+åç§°ï¼Œè¿˜æ²¡æœ‰dataæ•°æ®</p>
</li>
<li><p><code>realizeClassWithoutSwift</code> ä¸»è¦æ˜¯å®ç°ç±»ï¼Œå³å°†ç±»çš„dataæ•°æ®è¯»å–åˆ°å†…å­˜ä¸­</p>
<ul>
<li><p>methodizeClassæ–¹æ³•ä¸­å®ç°ç±»ä¸­æ–¹æ³•ï¼ˆåè®®ç­‰ï¼‰çš„&#96;åºåˆ—åŒ–</p>
</li>
<li><p>attachCategoriesæ–¹æ³•ä¸­å®ç°ç±»ä»¥åŠåˆ†ç±»çš„æ•°æ®åŠ è½½</p>
</li>
</ul>
</li>
</ul>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œ<code>ç±»ä»Mach-OåŠ è½½åˆ°å†…å­˜</code> çš„æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤º</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://bboy-blog.oss-cn-beijing.aliyuncs.com/img/202305071723079.png"
                     
                ></p>

            </div>

            
                <div class="post-copyright-info">
                    <div class="article-copyright-info-container">
    <ul>
        <li>Post titleï¼šOCåº•å±‚åŸç†17ï¼šç±»çš„åŠ è½½ï¼ˆä¸Šï¼‰</li>
        <li>Post authorï¼šå¼ å»º</li>
        <li>Create timeï¼š2020-11-03 15:21:34</li>
        <li>
            Post linkï¼šhttps://redefine.ohevan.com/2020/11/03/OCåº•å±‚åŸç†/OCåº•å±‚åŸç†17ï¼šç±»çš„åŠ è½½ï¼ˆä¸Šï¼‰/
        </li>
        <li>
            Copyright Noticeï¼šAll articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> unless stating additionally.
        </li>
    </ul>
</div>

                </div>
            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/BboyZJ.github.io/tags/OC-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E6%8E%A2%E7%B4%A2%E7%AF%87/">#OC-åº•å±‚åŸç†æ¢ç´¢ç¯‡</a>&nbsp;
                        </li>
                    
                </ul>
            

            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                            rel="prev"
                            href="/BboyZJ.github.io/2020/11/19/OC%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/OC%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%8618%EF%BC%9A%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD%EF%BC%88%E4%B8%8B%EF%BC%89%E5%88%86%E7%B1%BB/"
                            >
                                <span class="left arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </span>
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">OCåº•å±‚åŸç†18ï¼šç±»çš„åŠ è½½ï¼ˆä¸‹ï¼‰åˆ†ç±»</span>
                                    <span class="post-nav-item">Prev posts</span>
                                </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                            rel="next"
                            href="/BboyZJ.github.io/2020/10/20/OC%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/OC%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%8616%EF%BC%9Adyld%E4%B8%8Eobjc%E7%9A%84%E5%85%B3%E8%81%94/"
                            >
                                <span class="title flex-center">
                                    <span class="post-nav-title-item">OCåº•å±‚åŸç†16ï¼šdyldä¸objcçš„å…³è”</span>
                                    <span class="post-nav-item">Next posts</span>
                                </span>
                                <span class="right arrow-icon flex-center">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </span>
                            </a>
                        </div>
                    
                </div>
            


            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">OCåº•å±‚åŸç†17ï¼šç±»çš„åŠ è½½ï¼ˆä¸Šï¼‰</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#map-images%EF%BC%9A%E5%8A%A0%E8%BD%BD%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6%E5%88%B0%E5%86%85%E5%AD%98"><span class="nav-text">map_imagesï¼šåŠ è½½é•œåƒæ–‡ä»¶åˆ°å†…å­˜</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#map-images%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B"><span class="nav-text">map_imagesæºç æµç¨‹</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#read-images-%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="nav-text">_read_images æºç å®ç°</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#readClass%EF%BC%9A%E8%AF%BB%E5%8F%96%E7%B1%BB"><span class="nav-text">readClassï¼šè¯»å–ç±»</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">æ€»ç»“</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#realizeClassWithoutSwift%EF%BC%9A%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="nav-text">realizeClassWithoutSwiftï¼šå®ç°ç±»</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#methodizeClass%EF%BC%9A%E6%96%B9%E6%B3%95%E5%8C%96%E7%B1%BB"><span class="nav-text">methodizeClassï¼šæ–¹æ³•åŒ–ç±»</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#rwe%E7%9A%84%E9%80%BB%E8%BE%91"><span class="nav-text">rweçš„é€»è¾‘</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E5%A6%82%E4%BD%95%E6%8E%92%E5%BA%8F"><span class="nav-text">æ–¹æ³•å¦‚ä½•æ’åº</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E6%96%B9%E6%B3%95%E6%8E%92%E5%BA%8F"><span class="nav-text">éªŒè¯æ–¹æ³•æ’åº</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#attachToClass%E6%96%B9%E6%B3%95"><span class="nav-text">attachToClassæ–¹æ³•</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#attachCategories%E6%96%B9%E6%B3%95"><span class="nav-text">attachCategoriesæ–¹æ³•</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#attachLists%E6%96%B9%E6%B3%95%EF%BC%9A%E6%8F%92%E5%85%A5"><span class="nav-text">attachListsæ–¹æ³•ï¼šæ’å…¥</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#memmove%E5%92%8Cmemcpy%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-text">memmoveå’Œmemcpyçš„åŒºåˆ«</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#rwe-%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD"><span class="nav-text">rwe æ•°æ®åŠ è½½</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#rwe-%E2%80%93-LGA%E5%88%86%E7%B1%BB%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E3%80%90%E9%87%8D%E7%82%B9%EF%BC%81%EF%BC%81%EF%BC%81%E3%80%91"><span class="nav-text">rwe â€“ LGAåˆ†ç±»æ•°æ®åŠ è½½ã€é‡ç‚¹ï¼ï¼ï¼ã€‘</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#rwe-%E2%80%93-LGB%E5%88%86%E7%B1%BB%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E3%80%90%E9%87%8D%E7%82%B9%EF%BC%81%EF%BC%81%EF%BC%81%E3%80%91"><span class="nav-text">rwe â€“ LGBåˆ†ç±»æ•°æ®åŠ è½½ã€é‡ç‚¹ï¼ï¼ï¼ã€‘</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%87%92%E5%8A%A0%E8%BD%BD%E7%B1%BB-%E5%92%8C-%E9%9D%9E%E6%87%92%E5%8A%A0%E8%BD%BD%E7%B1%BB"><span class="nav-text">æ‡’åŠ è½½ç±» å’Œ éæ‡’åŠ è½½ç±»</span></a></li></ol>

    </div>
</div>
            </div>
        
    </div>
</div>


                

            </div>



        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info">
            &copy;
            
              <span>2019</span>
              -
            
            2023&nbsp;&nbsp;<i class="fa-regular fa-computer-classic"></i>&nbsp;&nbsp;<a href="/">å¼ å»º</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv" class="busuanzi_container_site_uv">
                        VISITOR COUNT&nbsp;<span id="busuanzi_value_site_uv" class="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="busuanzi_container_site_pv">
                        TOTAL PAGE VIEWS&nbsp;<span id="busuanzi_value_site_pv" class="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            <span class="powered-by-container">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg version="1.1" id="åœ–å±¤_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" href="https://hexo.io">Hexo</a></span>
                <br> 
            <span class="theme-version-container">THEME&nbsp;<a class="theme-version" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v1.1.5</a>
        </div>
        
        
        
            <div id="start_time_div" style="display:none">
                2019/8/17 11:45:14
            </div>
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
        
            <script async data-pjax>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="unfolded-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-expand-width flex-center">
            <i class="fa-regular fa-expand"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="right-bottom-tools tool-scroll-to-top flex-center">
                <i class="fa-regular fa-arrow-up"></i>
            </li>
        

        <li class="right-bottom-tools tool-scroll-to-bottom flex-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="folded-tools-list">
        <li class="right-bottom-tools tool-toggle-show flex-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    


</main>




<script src="/BboyZJ.github.io/js/utils.js"></script>

<script src="/BboyZJ.github.io/js/main.js"></script>

<script src="/BboyZJ.github.io/js/layouts/menu-shrink.js"></script>

<script src="/BboyZJ.github.io/js/tools/go-top-bottom.js"></script>

<script src="/BboyZJ.github.io/js/tools/dark-light-toggle.js"></script>



    
<script src="/BboyZJ.github.io/js/tools/local-search.js"></script>




    
<script src="/BboyZJ.github.io/js/tools/code-block.js"></script>




    
<script src="/BboyZJ.github.io/js/layouts/lazyload.js"></script>




    
<script src="/BboyZJ.github.io/js/tools/runtime.js"></script>

    
<script src="/BboyZJ.github.io/js/layouts/odometer.min.js"></script>

    
<link rel="stylesheet" href="/BboyZJ.github.io/assets/odometer-theme-minimal.css">





<div class="post-scripts pjax">
    
        
<script src="/BboyZJ.github.io/js/tools/toc-toggle.js"></script>

<script src="/BboyZJ.github.io/js/libs/anime.min.js"></script>

<script src="/BboyZJ.github.io/js/layouts/toc.js"></script>

<script src="/BboyZJ.github.io/js/plugins/tabs.js"></script>

    
    
</div>


    
<script src="/BboyZJ.github.io/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            REDEFINE.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            REDEFINE.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            REDEFINE.refresh();
        });
    });
</script>




<script src="/BboyZJ.github.io/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
